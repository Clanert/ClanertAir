<!-- /index.html -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ClanertAir · Mbezi Makabe</title>

  <!-- Bootstrap + Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"/>

  <!-- Chart.js + Leaflet -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root{
      --accent:#4f46e5; --muted:#6b7280; --border:#e5e7eb; --bg:#ffffff; --chip:#f8fafc;
      --ring:#22c55e;
    }
    html,body{height:100%; background:var(--bg);}
    .navbar{background:#0f172a;}
    .navbar .navbar-brand,.navbar .nav-link,.navbar .btn{color:#fff!important}

    /* Layout */
    .app{display:block;}
    @media (min-width: 992px){
      .app{display:grid; grid-template-columns: 320px 1fr; min-height: calc(100vh - 56px);}
      .sidebar{border-right:1px solid var(--border); height: calc(100vh - 56px); position:sticky; top:56px; overflow:auto;}
      .main{min-height: calc(100vh - 56px); overflow:auto;}
    }

    /* Map (leave space for mobile dock) */
    .map-wrap{position:relative; height:calc(85vh - 64px);}
    @media (min-width: 992px){ .map-wrap{height:65vh;} }
    #map{height:100%; width:100%;}

    /* Status + Day/Night */
    .status-ribbon{
      position:absolute; top:.5rem; right:2.4rem; z-index:510;
      padding:.35rem .6rem; border-radius:.5rem; font-weight:600; font-size:.85rem; color:#fff;
      box-shadow:0 4px 16px rgba(0,0,0,.15);
    }
    .online{background:#22c55e}.offline{background:#ef4444}
    .daynight{
      position:absolute; top:.5rem; right:.5rem; z-index:511;
      width:28px; height:28px; border-radius:50%; background:#fff; border:1px solid var(--border);
      display:flex; align-items:center; justify-content:center; box-shadow:0 4px 12px rgba(0,0,0,.1);
      font-size:1rem; color:#f59e0b;
    }
    .night{color:#334155}

    /* Public/Private ribbon in sheet */
    .vis-ribbon{
      position:absolute; top:.5rem; right:.5rem; z-index:520;
      padding:.35rem .6rem; border-radius:.5rem; font-weight:600; font-size:.85rem; color:#fff;
      box-shadow:0 4px 16px rgba(0,0,0,.15);
    }
    .vis-public{background:#16a34a}
    .vis-private{background:#f59e0b}

    /* Floating AQI circle toggle */
    .aqi-circle{
      position:absolute; right:.75rem; bottom:calc(.75rem + 64px); z-index:520; /* lift above dock on mobile */
      width:84px; height:84px; border-radius:50%;
      background:#fff; box-shadow:0 10px 30px rgba(0,0,0,.12); border:1px solid var(--border);
      display:flex; align-items:center; justify-content:center; cursor:pointer; transition:transform .15s ease;
    }
    @media (min-width: 992px){ .aqi-circle{ bottom:.75rem; } } /* desktop */
    .aqi-circle:active{ transform:scale(.98); }
    .aqi-circle .inner{text-align:center;}
    .aqi-circle .val{font-weight:800; font-size:1.25rem; line-height:1;}
    .aqi-circle .lbl{font-size:.7rem; color:var(--muted); margin-top:2px;}
    .aqi-circle .badge-aqi{font-size:.65rem; margin-top:.25rem;}
    .aqi-circle::before{
      content:""; position:absolute; inset:-6px; border-radius:50%;
      background:conic-gradient(from 0deg, color-mix(in srgb, var(--ring) 25%, transparent) 0 360deg);
      animation:spin 12s linear infinite;
      -webkit-mask: radial-gradient(farthest-side, transparent 68%, #000 69%);
              mask: radial-gradient(farthest-side, transparent 68%, #000 69%);
      opacity:.9;
    }
    @keyframes spin { to { transform: rotate(360deg);} }

    /* KPI sheet (kept intact) */
    .sheet{
      position:absolute; right:.75rem; z-index:500;
      background:#fff; border:1px solid var(--border); border-radius:1rem; box-shadow:0 10px 30px rgba(0,0,0,.08);
      padding:.75rem .75rem .5rem; display:none; width:min(92vw, 680px);
      bottom:calc(84px + 1rem + 64px); /* above circle & dock */
      max-height:65vh; overflow:auto;
    }
    .sheet.open{ display:block; }
    @media (min-width: 992px){
      .sheet{ width:min(50vw, 680px); bottom:calc(84px + 1rem); }
    }
    .kpis{display:flex; flex-direction:column; gap:.5rem;}
    @media (min-width: 992px){
      .kpis{display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:.5rem;}
    }
    .kpi{background:var(--chip); border:1px solid var(--border); border-radius:.9rem; padding:.6rem .8rem;}
    .kpi .label{font-size:.8rem; color:var(--muted);}
    .kpi .value{font-size:1.2rem; font-weight:700;}
    .aqi-chip .value{font-size:1.3rem;}

    .badge-aqi{font-weight:600; color:#fff;}
    .aqi-good{background:#22c55e!important}
    .aqi-moderate{background:#eab308!important}
    .aqi-ufsg{background:#f59e0b!important}
    .aqi-unhealthy{background:#ef4444!important}
    .aqi-vunhealthy{background:#a855f7!important}
    .aqi-hazardous{background:#7f1d1d!important}

    /* Cards + ribbons */
    .card{border-color:var(--border); border-radius:1rem;}
    .pill{display:inline-flex; align-items:center; gap:.35rem; padding:.25rem .5rem; border-radius:999px; border:1px solid var(--border); background:#fff;}
    .date-ribbon{font-size:.8rem;border:1px solid var(--border);border-radius:999px;padding:.2rem .6rem;color:#374151;background:#fff;}

    /* Trend chart smaller */
    #historyChart{height:110px!important; max-height:140px;}
    @media (min-width: 992px){ #historyChart{height:140px!important;} }

    .hidden{display:none!important}

    /* ===== Mobile Dock (NEW) ===== */
    .mobile-dock{
      position:fixed; bottom:0; left:0; right:0; z-index:550;
      background:#ffffffea; backdrop-filter: blur(6px);
      border-top:1px solid var(--border);
      padding:.4rem .75rem;
      display:flex; align-items:center; justify-content:space-between; gap:.5rem;
    }
    .dock-btn{
      flex:1 1 0; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:.15rem;
      border:1px solid var(--border); background:#fff; height:48px; border-radius:999px;
      font-size:.75rem; color:#111827;
    }
    .dock-btn i{ font-size:1.15rem; }
    .dock-primary{ border-color:#dbeafe; background:#eff6ff; color:#1d4ed8; }
    @media (min-width: 992px){ .mobile-dock{ display:none; } }
  </style>
</head>
<body>
  <!-- NAVBAR -->
  <nav class="navbar navbar-expand-lg">
    <div class="container-fluid px-3">
      <a class="navbar-brand fw-bold d-flex align-items-center gap-2" href="#"><i class="bi bi-cloud-fog2"></i> ClanertAir · Mbezi Makabe</a>
      <div class="d-flex gap-2 ms-auto d-lg-none">
        <button class="btn btn-sm btn-outline-light" data-bs-toggle="offcanvas" data-bs-target="#controlsDrawer">
          <i class="bi bi-sliders"></i> Controls
        </button>
      </div>
    </div>
  </nav>

  <div class="app">
    <!-- SIDEBAR (desktop) -->
    <aside class="sidebar d-none d-lg-block p-3">
      <div class="card">
        <div class="card-body">
          <h6 class="card-title mb-3">Controls</h6>

          <div class="mb-3">
            <label class="form-label">Station</label>
            <select id="stationSelect" class="form-select"></select>
            <div class="form-text">Ready for future multi-station.</div>
          </div>

          <div class="mb-3">
            <label class="form-label">Search</label>
            <input id="stationSearch" class="form-control" placeholder="Search (future)"/>
          </div>

          <div class="mb-3">
            <label class="form-label">Unlock Private Station</label>
            <div class="input-group">
              <input id="unlockInput" class="form-control" placeholder="Type exact station code or name"/>
              <button id="btnUnlock" class="btn btn-outline-secondary"><i class="bi bi-unlock"></i></button>
            </div>
            <div id="unlockMsg" class="form-text"></div>
          </div>

          <div class="mb-3">
            <label class="form-label">Hours</label>
            <input id="hoursInput" class="form-control" type="number" min="1" step="1" value="24"/>
          </div>

          <div class="d-grid gap-2">
            <button id="btnCtlLatest" class="btn btn-outline-primary"><i class="bi bi-broadcast-pin"></i> Latest</button>
            <button id="btnCtlHistory" class="btn btn-outline-secondary"><i class="bi bi-graph-up"></i> History</button>
            <button id="btnCtlAll" class="btn btn-primary text-white"><i class="bi bi-arrow-repeat"></i> Refresh</button>
            <button id="btnDownloadCsv" class="btn btn-outline-secondary"><i class="bi bi-download"></i> Download CSV</button>
          </div>

          <div id="alert" class="alert alert-danger mt-3 d-none" role="alert">
            <i class="bi bi-exclamation-triangle"></i> <span id="alertMsg">Error</span>
          </div>
        </div>
      </div>
    </aside>

    <!-- MAIN -->
    <main class="main">
      <!-- MAP -->
      <section class="map-wrap">
        <div id="map"></div>

        <!-- Day/Night -->
        <div id="dayNightIcon" class="daynight" title="Day/Night"><i class="bi bi-sun"></i></div>

        <!-- Online/Offline -->
        <div id="statusRibbon" class="status-ribbon offline">Offline</div>

        <!-- AQI toggle -->
        <button id="aqiCircle" class="aqi-circle" aria-expanded="false" aria-controls="kpiSheet">
          <div class="inner">
            <div class="val" id="circleAQI">—</div>
            <div class="lbl">AQI</div>
            <span id="circleAQIBadge" class="badge badge-aqi">—</span>
          </div>
        </button>

        <!-- KPI SHEET -->
        <div id="kpiSheet" class="sheet" role="region" aria-label="Live station KPIs">
          <div id="visibilityRibbon" class="vis-ribbon vis-public">Public</div>

          <div class="mb-2">
            <div class="d-flex align-items-center justify-content-between">
              <div>
                <div class="fw-semibold" id="headerStationName">CLANERT · Mbezi Makabe</div>
                <div class="small text-secondary" id="headerStationArea">Dar es Salaam</div>
              </div>
              <div class="small text-secondary">Last: <span id="kpiTime">—</span></div>
            </div>
          </div>

          <!-- Minimal KPI chips -->
          <div class="kpis">
            <div class="kpi"><div class="label">PM2.5</div><div class="value" id="kpiPm25">—</div><div class="text-secondary small">µg/m³</div></div>
            <div class="kpi"><div class="label">PM10</div><div class="value" id="kpiPm10">—</div><div class="text-secondary small">µg/m³</div></div>
            <div class="kpi"><div class="label"><i class="bi bi-thermometer-half"></i> Temp</div><div class="value" id="kpiTemp">—</div><div class="text-secondary small">°C</div></div>
            <div class="kpi"><div class="label"><i class="bi bi-droplet-half"></i> Humidity</div><div class="value" id="kpiHum">—</div><div class="text-secondary small">%</div></div>
            <div class="kpi aqi-chip">
              <div class="label">AQI</div>
              <div class="d-flex align-items-center gap-2">
                <div class="value" id="kpiAQI">—</div>
                <span id="kpiAQIBadge" class="badge badge-aqi">—</span>
                <i id="kpiAQIEmoji" class="bi"></i>
              </div>
              <div class="text-secondary small" id="kpiAQINote">—</div>
            </div>
          </div>
        </div>

        <!-- ===== Mobile Dock (icon-first controls) ===== -->
        <div class="mobile-dock d-lg-none">
          <button id="dockLatest" class="dock-btn" aria-label="Latest"><i class="bi bi-broadcast-pin"></i><span>Latest</span></button>
          <button id="dockHistory" class="dock-btn" aria-label="History"><i class="bi bi-graph-up"></i><span>History</span></button>
          <button id="dockRefresh" class="dock-btn dock-primary" aria-label="Refresh"><i class="bi bi-arrow-repeat"></i><span>Refresh</span></button>
          <button id="dockControls" class="dock-btn" aria-label="Controls"><i class="bi bi-sliders"></i><span>More</span></button>
        </div>
      </section>

      <!-- MOBILE CONTROLS (offcanvas) -->
      <div class="offcanvas offcanvas-end d-lg-none" tabindex="-1" id="controlsDrawer">
        <div class="offcanvas-header">
          <h5 class="offcanvas-title"><i class="bi bi-sliders"></i> Controls</h5>
          <button class="btn-close" data-bs-dismiss="offcanvas"></button>
        </div>
        <div class="offcanvas-body">
          <div class="mb-3"><label class="form-label">Station</label><select id="stationSelect_m" class="form-select"></select><div class="form-text">Ready for future multi-station.</div></div>
          <div class="mb-3"><label class="form-label">Search</label><input id="stationSearch_m" class="form-control" placeholder="Search (future)"/></div>
          <div class="mb-3">
            <label class="form-label">Unlock Private Station</label>
            <div class="input-group">
              <input id="unlockInput_m" class="form-control" placeholder="Type exact station code or name"/>
              <button id="btnUnlock_m" class="btn btn-outline-secondary"><i class="bi bi-unlock"></i></button>
            </div>
            <div id="unlockMsg_m" class="form-text"></div>
          </div>
          <div class="mb-3"><label class="form-label">Hours</label><input id="hoursInput_m" class="form-control" type="number" min="1" step="1" value="24"/></div>
          <div class="d-grid gap-2">
            <button id="btnCtlLatest_m" class="btn btn-outline-primary"><i class="bi bi-broadcast-pin"></i> Latest</button>
            <button id="btnCtlHistory_m" class="btn btn-outline-secondary"><i class="bi bi-graph-up"></i> History</button>
            <button id="btnCtlAll_m" class="btn btn-primary text-white"><i class="bi bi-arrow-repeat"></i> Refresh</button>
            <button id="btnDownloadCsv_m" class="btn btn-outline-secondary"><i class="bi bi-download"></i> Download CSV</button>
          </div>
          <div id="alert_m" class="alert alert-danger mt-3 d-none" role="alert"><i class="bi bi-exclamation-triangle"></i> <span id="alertMsg_m">Error</span></div>
        </div>
      </div>

      <!-- ANALYTICS -->
      <section class="container-fluid px-3 py-3 pb-5 pb-md-3"><!-- extra bottom pad so dock doesn't overlap -->
        <div class="card mb-3">
          <div class="card-body">
            <h6 class="card-title mb-3">Activities & Air Quality</h6>
            <div class="d-flex align-items-center gap-2 flex-wrap mb-3">
              <div class="pill"><span class="text-secondary small">Live AQI</span><span id="liveAQIVal" class="fw-semibold">—</span><span id="liveAQIBadge" class="badge badge-aqi">—</span><i id="liveAQIEmoji" class="bi"></i></div>
              <div class="pill"><span class="text-secondary small">Average AQI (last <span id="avgHoursLabel">—</span>h)</span><span id="avgAQIVal" class="fw-semibold">—</span><span id="avgAQIBadge" class="badge badge-aqi">—</span><i id="avgAQIEmoji" class="bi"></i></div>
            </div>
            <div class="row g-2" id="activitiesGrid"></div>
          </div>
        </div>

        <div class="card mb-3">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2 flex-wrap gap-2">
              <div class="d-flex align-items-center gap-3">
                <h6 class="card-title m-0">PM Trends</h6>
                <span id="historyDateRibbon" class="date-ribbon">—</span>
              </div>
              <div class="legend-toggle small">
                <label class="me-3"><input class="form-check-input me-1" type="checkbox" checked data-series="pm25"> PM2.5</label>
                <label><input class="form-check-input me-1" type="checkbox" checked data-series="pm10"> PM10</label>
              </div>
            </div>
            <canvas id="historyChart"></canvas>
          </div>
        </div>

        <div class="card mb-3">
          <div class="card-body">
            <h6 class="card-title mb-2">Averages (last <span id="avgHoursLabel2">—</span>h)</h6>
            <div class="row g-2">
              <div class="col-6 col-lg-3"><div class="p-2 border rounded-3"><div class="small text-secondary">PM2.5</div><div id="avgPm25" class="fw-semibold">—</div></div></div>
              <div class="col-6 col-lg-3"><div class="p-2 border rounded-3"><div class="small text-secondary">PM10</div><div id="avgPm10" class="fw-semibold">—</div></div></div>
              <div class="col-6 col-lg-3"><div class="p-2 border rounded-3"><div class="small text-secondary">Temp <i class="bi bi-thermometer-half"></i></div><div id="avgTemp" class="fw-semibold">—</div></div></div>
              <div class="col-6 col-lg-3"><div class="p-2 border rounded-3"><div class="small text-secondary">Humidity <i class="bi bi-droplet-half"></i></div><div id="avgHum" class="fw-semibold">—</div></div></div>
            </div>
            <div class="d-flex align-items-center gap-2 mt-2 flex-wrap">
              <span class="text-secondary small">Samples</span><span id="avgCount" class="badge text-bg-light">—</span>
              <span class="text-secondary small ms-2">Average AQI</span><span id="avgAQIVal2" class="fw-semibold">—</span>
              <span id="avgAQIBadge2" class="badge badge-aqi">—</span><i id="avgAQIEmoji2" class="bi"></i>
            </div>
          </div>
        </div>

        <div id="historyTableWrap" class="card hidden">
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-sm align-middle">
                <thead><tr><th>Timestamp</th><th>PM2.5</th><th>PM10</th></tr></thead>
                <tbody id="historyBody"></tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="d-flex flex-column flex-md-row align-items-center justify-content-between gap-2 border-top pt-3 mt-3">
          <div class="small text-secondary">© Clanert Sustain</div>
          <div class="small"><a href="https://www.clanertsustain.co.tz" class="link-secondary text-decoration-none" target="_blank" rel="noreferrer">www.clanertsustain.co.tz</a> · <i class="bi bi-telephone"></i> +255 621 667 315</div>
        </div>
      </section>
    </main>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
          integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

  <script>
    /* ===== CONFIG ===== */
    const FALLBACK_STATION = { station:"CLANERT-MAKABE-001", name:"CLANERT · Mbezi Makabe", area:"Dar es Salaam", lat:-6.7350, lng:39.1800, visibility:"public" };
    const PUBLIC_STATIONS = new Set([FALLBACK_STATION.station]);
    const BASE_URL = "https://script.google.com/macros/s/AKfycbwD21CyF2Gli6Y6hDPUyds2fzAw7mrJ0NSDrqeiG7yItbZcYL-cbKsLcbHOU7db32wN/exec";
    const ONLINE_THRESHOLD_MIN = 10;

    /* ===== DOM ===== */
    const el = (id)=>document.getElementById(id);
    const $statusRibbon=el("statusRibbon"), $visibilityRibbon=el("visibilityRibbon");
    const $headerStationName=el("headerStationName"), $headerStationArea=el("headerStationArea");
    const $kpiPm25=el("kpiPm25"), $kpiPm10=el("kpiPm10"), $kpiTemp=el("kpiTemp"), $kpiHum=el("kpiHum");
    const $kpiAQI=el("kpiAQI"), $kpiAQIBadge=el("kpiAQIBadge"), $kpiAQIEmoji=el("kpiAQIEmoji"), $kpiAQINote=el("kpiAQINote"), $kpiTime=el("kpiTime");
    const $historyBody=el("historyBody"), $historyDateRibbon=el("historyDateRibbon");
    const $avgPm25=el("avgPm25"), $avgPm10=el("avgPm10"), $avgTemp=el("avgTemp"), $avgHum=el("avgHum"), $avgCount=el("avgCount");
    const $liveAQIVal=el("liveAQIVal"), $liveAQIBadge=el("liveAQIBadge"), $liveAQIEmoji=el("liveAQIEmoji");
    const $avgAQIVal=el("avgAQIVal"), $avgAQIBadge=el("avgAQIBadge"), $avgAQIEmoji=el("avgAQIEmoji"), $avgHoursLabel=el("avgHoursLabel"), $avgHoursLabel2=el("avgHoursLabel2");
    const $avgAQIVal2=el("avgAQIVal2"), $avgAQIBadge2=el("avgAQIBadge2"), $avgAQIEmoji2=el("avgAQIEmoji2");
    const $activitiesGrid=el("activitiesGrid");
    // selectors
    const $stationSelect=el("stationSelect"), $stationSearch=el("stationSearch"), $unlockInput=el("unlockInput"), $btnUnlock=el("btnUnlock"), $unlockMsg=el("unlockMsg"), $hours=el("hoursInput");
    const $stationSelect_m=el("stationSelect_m"), $stationSearch_m=el("stationSearch_m"), $unlockInput_m=el("unlockInput_m"), $btnUnlock_m=el("btnUnlock_m"), $hours_m=el("hoursInput_m"), $unlockMsg_m=el("unlockMsg_m");
    const $alert=el("alert"), $alertMsg=el("alertMsg"), $alert_m=el("alert_m"), $alertMsg_m=el("alertMsg_m");
    const btns = { ctlLatest: el("btnCtlLatest"), ctlHistory: el("btnCtlHistory"), ctlAll: el("btnCtlAll"), downloadCsv: el("btnDownloadCsv") };
    const btns_m = { ctlLatest: el("btnCtlLatest_m"), ctlHistory: el("btnCtlHistory_m"), ctlAll: el("btnCtlAll_m"), downloadCsv: el("btnDownloadCsv_m") };
    // AQI toggle + sheet + day/night
    const $aqiCircle = el("aqiCircle"), $circleAQI = el("circleAQI"), $circleAQIBadge = el("circleAQIBadge"), $kpiSheet = el("kpiSheet");
    const $dayNightIcon = el("dayNightIcon");

    /* ===== STATE ===== */
    let chart, map, marker;
    let stations=[{...FALLBACK_STATION, visibility:"public"}];
    let selectedId = stations[0].station;
    let lastHistory = [];

    /* ===== MAP ===== */
    function initMap(){
      map = L.map('map',{zoomControl:true}).setView([FALLBACK_STATION.lat, FALLBACK_STATION.lng], 14);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:19, attribution:'&copy; OpenStreetMap'}).addTo(map);
      marker = L.circleMarker([FALLBACK_STATION.lat, FALLBACK_STATION.lng], {radius:14, weight:2, color:'#888', fillColor:'#aaa', fillOpacity:.9}).addTo(map);
      marker.bindPopup("<div id='stationPopup'>Tap refresh</div>");
    }
    function setMarkerStyle(aqiCls){
      const colors = {"aqi-good":"#22c55e","aqi-moderate":"#eab308","aqi-ufsg":"#f59e0b","aqi-unhealthy":"#ef4444","aqi-vunhealthy":"#a855f7","aqi-hazardous":"#7f1d1d"};
      const color = colors[aqiCls] || "#999";
      const radius = 12 + (aqiCls==="aqi-unhealthy"||aqiCls==="aqi-vunhealthy"||aqiCls==="aqi-hazardous" ? 6 : 0);
      marker.setStyle({ color, fillColor: color, radius });
    }
    function setMarkerPopup(html){
      const p = document.getElementById('stationPopup');
      if (p) p.innerHTML = html; else marker.bindPopup(html);
    }
    function panTo(st){ if(Number.isFinite(st.lat)&&Number.isFinite(st.lng)) map.setView([st.lat,st.lng],14); }

    /* ===== AQI ===== */
    function aqiFromConcentration(c,bps){ for(const [Cl,Ch,Il,Ih] of bps){ if(c>=Cl && c<=Ch) return Math.round(((Ih-Il)/(Ch-Cl))*(c-Cl)+Il);} return null;}
    function aqiPm25(pm){ const c=Math.max(0,Math.min(Number(pm),500.4)); const bp=[[0,12,0,50],[12.1,35.4,51,100],[35.5,55.4,101,150],[55.5,150.4,151,200],[150.5,250.4,201,300],[250.5,350.4,301,400],[350.5,500.4,401,500]]; return aqiFromConcentration(c,bp); }
    function aqiPm10(pm){ const c=Math.max(0,Math.min(Number(pm),604)); const bp=[[0,54,0,50],[55,154,51,100],[155,254,101,150],[255,354,151,200],[355,424,201,300],[425,504,301,400],[505,604,401,500]]; return aqiFromConcentration(c,bp); }
    function aqiCategory(aqi){
      if(aqi==null) return { cls:"text-bg-secondary", code:"—", note:"—", emoji:"bi-emoji-expressionless", level:"caution", ring:"#9ca3af" };
      if(aqi<=50)  return { cls:"aqi-good",      code:"Good",         note:"Satisfactory.",           emoji:"bi-emoji-smile", level:"ok",      ring:"#22c55e" };
      if(aqi<=100) return { cls:"aqi-moderate",  code:"Moderate",     note:"Acceptable.",             emoji:"bi-emoji-neutral", level:"ok",    ring:"#eab308" };
      if(aqi<=150) return { cls:"aqi-ufsg",      code:"Unhealthy (SG)", note:"Sensitive groups caution.", emoji:"bi-emoji-frown", level:"caution", ring:"#f59e0b" };
      if(aqi<=200) return { cls:"aqi-unhealthy", code:"Unhealthy",     note:"Everyone may feel effects.", emoji:"bi-emoji-angry", level:"avoid", ring:"#ef4444" };
      if(aqi<=300) return { cls:"aqi-vunhealthy",code:"Very Unhealthy", note:"Health alert.",            emoji:"bi-emoji-dizzy", level:"avoid", ring:"#a855f7" };
      return              { cls:"aqi-hazardous", code:"Hazardous",     note:"Emergency conditions.",    emoji:"bi-emoji-dizzy", level:"avoid", ring:"#7f1d1d" };
    }

    /* ===== HELPERS ===== */
    function showError(msg, mobile=false){ (mobile?$alert_m:$alert).classList.remove("d-none"); (mobile?$alertMsg_m:$alertMsg).textContent=msg; }
    function clearError(){ $alert?.classList.add("d-none"); $alert_m?.classList.add("d-none"); }
    function fmtNum(x,d=1){ const n=Number(x); return Number.isFinite(n)? n.toFixed(d):"—"; }
    function fmtTime(x){ const d=new Date(x); return isNaN(d)?"—":d.toLocaleString(); }
    function fmtHHMM(x){ const d=new Date(x); if(isNaN(d)) return "—"; const h=String(d.getHours()).padStart(2,'0'), m=String(d.getMinutes()).padStart(2,'0'); return `${h}:${m}`; }
    function fmtDate(x){ const d=new Date(x); if(isNaN(d)) return "—"; return d.toLocaleDateString(undefined,{year:"numeric",month:"short",day:"numeric"}); }
    function minutesSince(ts){ const d=new Date(ts); if(isNaN(d)) return Infinity; return (Date.now()-d.getTime())/60000; }
    function buildUrl(mode,station,params={}){ const u=new URL(BASE_URL); u.searchParams.set("mode",mode); if(station) u.searchParams.set("station",station); Object.entries(params).forEach(([k,v])=>{ if(v!==undefined&&v!==null&&`${v}`.length) u.searchParams.set(k,v); }); return u.toString(); }
    async function fetchJson(url){
      const ctrl=new AbortController(); const t=setTimeout(()=>ctrl.abort(),15000);
      try{
        const res=await fetch(url,{signal:ctrl.signal,cache:"no-store"});
        if(!res.ok){ const txt=await res.text().catch(()=> ""); throw new Error(`HTTP ${res.status} ${txt||res.statusText}`); }
        return await res.json();
      } finally { clearTimeout(t); }
    }
    function setBusy(b){
      const buttons=[btns.ctlLatest,btns.ctlHistory,btns.ctlAll,btns.downloadCsv,btns_m.ctlLatest,btns_m.ctlHistory,btns_m.ctlAll,btns_m.downloadCsv,$btnUnlock,$btnUnlock_m].filter(Boolean);
      buttons.forEach(x=>x.disabled=b);
      const html=b?`<span class="spinner-border spinner-border-sm me-1"></span> Refresh`:`<i class="bi bi-arrow-repeat"></i> Refresh`;
      if(btns.ctlAll) btns.ctlAll.innerHTML = html;
      if(btns_m.ctlAll) btns_m.ctlAll.innerHTML = html;
    }
    function getHours(){
      const vDesktop = Number($hours?.value); const vMobile = Number($hours_m?.value);
      const h = Number.isFinite(vDesktop) && vDesktop>0 ? vDesktop : (Number.isFinite(vMobile)&&vMobile>0?vMobile:24);
      return Math.max(1, Math.floor(h));
    }

    /* Day/Night */
    function setDayNightIcon(){
      try{
        const now=new Date(); const hr=(now.getUTCHours()+3+24)%24; // Dar es Salaam
        const isDay=hr>=6 && hr<18;
        $dayNightIcon.innerHTML = `<i class="bi ${isDay?'bi-sun':'bi-moon'}"></i>`;
        $dayNightIcon.classList.toggle('night', !isDay);
        $dayNightIcon.title = isDay ? 'Daytime' : 'Night';
      }catch{}
    }

    /* Activities */
    function activitiesFor(cat){
      const ok=(t,i,n)=>({cls:"ok",icon:i,title:t,note:n});
      const ca=(t,i,n)=>({cls:"caution",icon:i,title:t,note:n});
      const av=(t,i,n)=>({cls:"avoid",icon:i,title:t,note:n});
      if(cat.level==="ok") return [ok("Running","bi-bicycle","Good to go."),ok("Outdoor play","bi-sun","No restrictions."),ok("Commuting/Walking","bi-signpost","Normal activity."),ok("Windows open","bi-wind","Ventilation OK.")];
      if(cat.level==="caution") return [ca("Running (sensitive)","bi-activity","Shorter, lighter effort."),ca("Outdoor play","bi-tree","Limit duration; watch symptoms."),ca("Commuting/Walking","bi-signpost","Prefer less-busy routes."),ca("Masks (SG)","bi-shield-check","Consider mask if sensitive.")];
      return [av("Running","bi-activity","Avoid vigorous exercise."),av("Outdoor play","bi-tree","Move indoors if possible."),av("Commuting","bi-signpost","Reduce exposure; mask recommended."),av("Windows closed","bi-wind","Filter/recirculate air.")];
    }
    function renderActivities(cat){
      document.getElementById("activitiesGrid").innerHTML = activitiesFor(cat).map(it => `
        <div class="col-12 col-md-6 col-xxl-3">
          <div class="p-2 border rounded-3 d-flex align-items-center gap-2">
            <span class="badge ${it.cls==='ok'?'text-bg-success':it.cls==='caution'?'text-bg-warning':'text-bg-danger'}"><i class="bi ${it.icon}"></i></span>
            <div><div class="fw-semibold">${it.title}</div><div class="text-secondary small">${it.note}</div></div>
          </div>
        </div>`).join("");
    }

    /* AQI ring */
    function setCircleAQI(aqi, cat){
      document.getElementById("circleAQI").textContent = aqi ?? "—";
      const b=document.getElementById("circleAQIBadge");
      b.textContent = cat.code; b.className = `badge badge-aqi ${cat.cls}`;
      document.documentElement.style.setProperty('--ring', cat.ring || '#22c55e');
    }

    /* Renderers */
    function updateHeader(st){
      document.getElementById("headerStationName").textContent = st.name;
      document.getElementById("headerStationArea").textContent = st.area || "—";
      const isPublic = PUBLIC_STATIONS.has(st.station) || st.visibility==="public";
      const vr=document.getElementById("visibilityRibbon");
      vr.textContent = isPublic ? "Public" : "Private";
      vr.className = `vis-ribbon ${isPublic ? "vis-public" : "vis-private"}`;
    }
    function updateStatusRibbon(ts){
      const online = minutesSince(ts) <= ONLINE_THRESHOLD_MIN;
      const sr=document.getElementById("statusRibbon");
      sr.textContent = online ? "Online" : "Offline";
      sr.className = `status-ribbon ${online?"online":"offline"}`;
    }
    function setLiveAQIPill(aqi,cat){
      document.getElementById("liveAQIVal").textContent = aqi ?? "—";
      const b=document.getElementById("liveAQIBadge"); b.textContent = cat.code; b.className = `badge badge-aqi ${cat.cls}`;
      document.getElementById("liveAQIEmoji").className = `bi ${cat.emoji}`;
    }
    function setAvgAQIPill(aqi,cat,h){
      document.getElementById("avgHoursLabel").textContent = h; document.getElementById("avgHoursLabel2").textContent = h;
      document.getElementById("avgAQIVal").textContent = aqi ?? "—";
      const b1=document.getElementById("avgAQIBadge"); b1.textContent = cat.code; b1.className = `badge badge-aqi ${cat.cls}`;
      document.getElementById("avgAQIEmoji").className = `bi ${cat.emoji}`;
      document.getElementById("avgAQIVal2").textContent = aqi ?? "—";
      const b2=document.getElementById("avgAQIBadge2"); b2.textContent = cat.code; b2.className = `badge badge-aqi ${cat.cls}`;
      document.getElementById("avgAQIEmoji2").className = `bi ${cat.emoji}`;
    }

    function renderLatest(j, st){
      if(j.error) throw new Error(j.message||j.error);
      document.getElementById("kpiPm25").textContent = fmtNum(j.pm25);
      document.getElementById("kpiPm10").textContent = fmtNum(j.pm10);
      document.getElementById("kpiTemp").textContent = fmtNum(j.temperature);
      document.getElementById("kpiHum").textContent  = fmtNum(j.humidity);
      document.getElementById("kpiTime").textContent = fmtTime(j.timestamp);

      const aqi25=aqiPm25(j.pm25), aqi10=aqiPm10(j.pm10);
      const aqi = Math.max(aqi25??0, aqi10??0) || null;
      const cat = aqiCategory(aqi);

      document.getElementById("kpiAQI").textContent = aqi ?? "—";
      const b=document.getElementById("kpiAQIBadge"); b.textContent = cat.code; b.className = `badge badge-aqi ${cat.cls}`;
      document.getElementById("kpiAQIEmoji").className = `bi ${cat.emoji}`;
      document.getElementById("kpiAQINote").textContent = cat.note;

      setCircleAQI(aqi, cat);
      setMarkerStyle(cat.cls);
      marker.setLatLng([st.lat, st.lng]);
      (function setPopup(){
        const html=`
          <div class="small">
            <div class="fw-semibold mb-1">${st.name}</div>
            <div>AQI: <span class="badge badge-aqi ${cat.cls}">${aqi ?? "—"} · ${cat.code}</span> <i class="bi ${cat.emoji}"></i></div>
            <div>PM2.5: <b>${fmtNum(j.pm25)}</b> µg/m³ · PM10: <b>${fmtNum(j.pm10)}</b> µg/m³</div>
            <div>Temp: <b>${fmtNum(j.temperature)}</b> °C · Humidity: <b>${fmtNum(j.humidity)}</b> %</div>
            <div class="text-secondary">Last: ${fmtTime(j.timestamp)}</div>
          </div>`;
        const p = document.getElementById('stationPopup'); if (p) p.innerHTML = html; else marker.bindPopup(html);
      })();

      updateStatusRibbon(j.timestamp);
      setLiveAQIPill(aqi, cat);
      renderActivities(cat);
    }

    function ensureChart(){
      if(chart) return chart;
      chart = new Chart(document.getElementById("historyChart"), {
        type:"line",
        data:{ labels:[], datasets:[] },
        options:{
          responsive:true, maintainAspectRatio:false,
          interaction:{ mode:"index", intersect:false },
          scales:{ x:{ grid:{ color:"#eee" } }, y:{ grid:{ color:"#f2f2f2" } } },
          plugins:{ legend:{ position:"bottom" } }
        }
      });
      document.querySelectorAll(".legend-toggle input[type=checkbox]").forEach((cb, idx)=>{
        cb.onchange=()=>{ chart.toggleDataVisibility(idx); chart.update(); };
      });
      return chart;
    }
    function renderHistory(j){
      if(j.error) throw new Error(j.message||j.error);
      const pts = Array.isArray(j.points) ? j.points : [];
      lastHistory = pts;

      const body=document.getElementById("historyBody"); body.innerHTML = "";
      if(pts.length){
        const frag=document.createDocumentFragment();
        pts.forEach(p=>{
          const tr=document.createElement("tr");
          tr.innerHTML=`<td>${fmtTime(p.timestamp)}</td><td>${fmtNum(p.pm25,2)}</td><td>${fmtNum(p.pm10,2)}</td>`;
          frag.appendChild(tr);
        });
        body.appendChild(frag);
      }

      const labels = pts.map(p=>fmtHHMM(p.timestamp));
      const mk=(label,key)=>({ label, data: pts.map(p=>Number(p[key])), borderWidth:2, pointRadius:0, tension:.25 });
      const c=ensureChart();
      c.data.labels = labels;
      c.data.datasets = [ mk("PM2.5 (µg/m³)","pm25"), mk("PM10 (µg/m³)","pm10") ];
      c.update();

      const ribbon=document.getElementById("historyDateRibbon");
      if(pts.length){
        const first=fmtDate(pts[0].timestamp), last=fmtDate(pts[pts.length-1].timestamp);
        ribbon.textContent = first===last ? first : `${first} – ${last}`;
      } else { ribbon.textContent = "—"; }
    }
    function renderAvg(j, h){
      if(j.error) throw new Error(j.message||j.error);
      document.getElementById("avgPm25").textContent=fmtNum(j.pm25_avg);
      document.getElementById("avgPm10").textContent=fmtNum(j.pm10_avg);
      document.getElementById("avgTemp").textContent=fmtNum(j.temperature_avg);
      document.getElementById("avgHum").textContent=fmtNum(j.humidity_avg);
      document.getElementById("avgCount").textContent=j.count ?? 0;

      const aqi25=aqiPm25(j.pm25_avg), aqi10=aqiPm10(j.pm10_avg);
      const avgAQI = (aqi25==null && aqi10==null) ? null : Math.max(aqi25??0, aqi10??0);
      const avgCat = aqiCategory(avgAQI);
      setAvgAQIPill(avgAQI, avgCat, h);
      renderActivities(avgCat);
    }

    /* ===== API ===== */
    async function loadLatest(id){ const j=await fetchJson(buildUrl("latest", id)); const st=stations.find(s=>s.station===id)||stations[0]; renderLatest(j, st); }
    async function loadHistory(id,h){ const j=await fetchJson(buildUrl("history", id, {hours:h})); renderHistory(j); }
    async function loadAvg(id,h){ const j=await fetchJson(buildUrl("avg", id, {hours:h})); renderAvg(j,h); }

    /* ===== CSV ===== */
    function downloadCSV(){
      if(!lastHistory.length){ showError("No history loaded to download."); return; }
      const rows=[["Timestamp","PM2.5","PM10"], ...lastHistory.map(p=>[new Date(p.timestamp).toISOString(), String(p.pm25??""), String(p.pm10??"")])];
      const csv=rows.map(r=>r.map(v=>/[,\"\n]/.test(v)?`"${String(v).replace(/"/g,'""')}"`:v).join(",")).join("\n");
      const blob=new Blob([csv],{type:"text/csv;charset=utf-8;"});
      const a=document.createElement("a"); a.href=URL.createObjectURL(blob);
      const h=getHours(); a.download=`${selectedId}_history_${h}h.csv`; document.body.appendChild(a); a.click(); a.remove();
    }

    /* ===== Stations & Unlock ===== */
    function setVisibilityRibbon(stationId){
      const st=stations.find(s=>s.station===stationId);
      const isPublic = PUBLIC_STATIONS.has(stationId) || (st?.visibility==="public");
      document.getElementById("visibilityRibbon").textContent = isPublic ? "Public" : "Private";
      document.getElementById("visibilityRibbon").className = `vis-ribbon ${isPublic ? "vis-public" : "vis-private"}`;
    }
    function upsertStation(st){
      const i=stations.findIndex(x=>x.station===st.station);
      if(i>=0) stations[i]=st; else stations.push(st);
      refreshSelectors();
    }
    function refreshSelectors(){
      const opts = stations.map(s=>`<option value="${s.station}">${s.name} (${s.station})</option>`).join("");
      const a=document.getElementById("stationSelect");
      const b=document.getElementById("stationSelect_m");
      if(a){ a.innerHTML=opts; a.value=selectedId; }
      if(b){ b.innerHTML=opts; b.value=selectedId; }
    }

    /* ===== Init ===== */
    (async function init(){
      initMap();
      setDayNightIcon(); setInterval(setDayNightIcon, 5*60*1000);

      selectedId = stations[0].station;
      refreshSelectors();

      // Desktop controls
      const a=document.getElementById("stationSelect");
      a?.addEventListener("change", ()=>{ selectedId=a.value; const st=stations.find(x=>x.station===selectedId)||stations[0]; updateHeader(st); setVisibilityRibbon(selectedId); panTo(st); btns.ctlAll.click(); });
      document.getElementById("stationSearch")?.addEventListener("input", ()=>{});
      btns.ctlLatest.onclick=async()=>{ clearError(); try{ setBusy(true); await loadLatest(selectedId); }catch(e){ showError(e.message);}finally{ setBusy(false);} };
      btns.ctlHistory.onclick=async()=>{ clearError(); try{ setBusy(true); await loadHistory(selectedId, getHours()); }catch(e){ showError(e.message);}finally{ setBusy(false);} };
      btns.ctlAll.onclick=async()=>{ clearError(); try{ setBusy(true); const H=getHours(); await Promise.all([loadLatest(selectedId), loadHistory(selectedId,H), loadAvg(selectedId,H)]); }catch(e){ showError(e.message);}finally{ setBusy(false);} };
      btns.downloadCsv.onclick=()=>downloadCSV();

      // Mobile mirror
      const am=document.getElementById("stationSelect_m");
      am?.addEventListener("change", ()=>{ selectedId=am.value; refreshSelectors(); const st=stations.find(x=>x.station===selectedId)||stations[0]; updateHeader(st); setVisibilityRibbon(selectedId); panTo(st); btns.ctlAll.click(); });
      btns_m.ctlLatest.onclick = ()=> btns.ctlLatest.click();
      btns_m.ctlHistory.onclick= ()=> btns.ctlHistory.click();
      btns_m.ctlAll.onclick    = ()=> btns.ctlAll.click();
      btns_m.downloadCsv.onclick=()=> btns.downloadCsv.click();

      // Unlock
      document.getElementById("btnUnlock")?.addEventListener("click", ()=>unlockStation(document.getElementById("unlockInput").value, false));
      document.getElementById("btnUnlock_m")?.addEventListener("click", ()=>unlockStation(document.getElementById("unlockInput_m").value, true));

      async function unlockStation(raw, mobile){
        const code = (raw||"").trim();
        (mobile?document.getElementById("unlockMsg_m"):document.getElementById("unlockMsg")).textContent="";
        if(!code){ (mobile?document.getElementById("unlockMsg_m"):document.getElementById("unlockMsg")).textContent="Enter an exact station code/name."; return; }
        try{
          setBusy(true);
          const latest = await fetchJson(buildUrl("latest", code));
          const st = { station: code, name: code, area:"—", lat:FALLBACK_STATION.lat, lng:FALLBACK_STATION.lng, visibility: PUBLIC_STATIONS.has(code) ? "public" : "private" };
          upsertStation(st); selectedId=code; refreshSelectors(); updateHeader(st); setVisibilityRibbon(code); panTo(st);
          (mobile?document.getElementById("unlockMsg_m"):document.getElementById("unlockMsg")).textContent = st.visibility==="private" ? "Private station unlocked." : "Public station selected.";
          const H=getHours(); await Promise.all([renderLatest(latest, st), loadHistory(code,H), loadAvg(code,H)]);
        }catch(err){
          (mobile?document.getElementById("unlockMsg_m"):document.getElementById("unlockMsg")).textContent="No data for that code. Reason: "+(err?.message||"Unknown");
          showError("Unlock failed: "+(err?.message||"Unknown error"), mobile);
        }finally{ setBusy(false); }
      }

      // AQI circle toggles sheet
      document.getElementById("aqiCircle").addEventListener("click", ()=>{
        const s=document.getElementById("kpiSheet");
        const open = s.classList.toggle("open");
        document.getElementById("aqiCircle").setAttribute("aria-expanded", String(open));
      });

      // Mobile dock bindings (icon-first)
      document.getElementById("dockLatest").onclick  = ()=> btns.ctlLatest.click();
      document.getElementById("dockHistory").onclick = ()=> btns.ctlHistory.click();
      document.getElementById("dockRefresh").onclick = ()=> btns.ctlAll.click();
      document.getElementById("dockControls").onclick= ()=> {
        const offcanvas = new bootstrap.Offcanvas(document.getElementById('controlsDrawer'));
        offcanvas.show();
      };

      // initial load
      const st=stations[0]; updateHeader(st); setVisibilityRibbon(selectedId); panTo(st);
      btns.ctlAll.click();
    })();
  </script>
</body>
</html>
