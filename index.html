<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ClanertAir – Air Quality Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap 5 -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  >
  <!-- Bootstrap Icons -->
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
  >

  <!-- Chart.js for graphs -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Leaflet for map -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <style>
    :root {
      --bg-page: #f4f5fb;
      --bg-panel: #ffffff;
      --bg-card: #ffffff;
      --accent-green: #16a34a;
      --accent-blue: #1d4ed8;
      --accent-amber: #f59e0b;
      --text-main: #111827;
      --text-muted: #6b7280;
      --border-light: #e5e7eb;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: var(--text-main);
      background: var(--bg-page);
      overflow: hidden;
    }

    /* Map takes full screen, panel overlays on the right */
    #map {
      position: fixed;
      inset: 0;
      width: 100%;
      height: 100%;
      z-index: 0;
    }

    /* Top navigation bar */
    .top-nav {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 52px;
      padding: 4px 10px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: rgba(255,255,255,0.96);
      box-shadow: 0 4px 12px rgba(15,23,42,0.14);
      backdrop-filter: blur(8px);
      z-index: 30;
    }

    .nav-left {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .nav-logo {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: 1px solid var(--border-light);
      padding: 3px;
      background: #ffffff;
      object-fit: contain;
    }

    .nav-title-block {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .nav-title {
      font-size: 1rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .nav-sub {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .nav-toggle {
      border-radius: 999px;
      border: 1px solid var(--border-light);
      background: #f9fafb;
      width: 34px;
      height: 34px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 1.1rem;
      color: var(--text-main);
    }

    .nav-toggle:hover {
      background: #e5e7eb;
    }

    /* Side panel */

    .side-panel {
      position: fixed;
      top: 52px;        /* sits below nav */
      right: 0;
      bottom: 0;
      width: 380px;
      max-width: 100%;
      background: var(--bg-panel);
      box-shadow: -10px 0 30px rgba(15, 23, 42, 0.25);
      border-left: 1px solid var(--border-light);
      display: flex;
      flex-direction: column;
      z-index: 20;
      transform: translateX(0);
      transition: transform 0.25s ease;
    }

    .side-panel.collapsed {
      transform: translateX(calc(100% - 44px));
    }

    .panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 10px 6px;
      border-bottom: 1px solid var(--border-light);
      background: rgba(255,255,255,0.98);
      backdrop-filter: blur(6px);
    }

    .panel-header-title {
      font-size: 0.85rem;
      font-weight: 500;
      color: var(--text-main);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .panel-toggle {
      border: 1px solid var(--border-light);
      background: #f9fafb;
      border-radius: 999px;
      width: 28px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 0.9rem;
      color: var(--text-muted);
    }

    .panel-toggle:hover {
      background: #e5e7eb;
    }

    .panel-body {
      flex: 1;
      overflow-y: auto;
      padding: 8px 10px 10px;
      background: var(--bg-page);
    }

    .panel-section-title {
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
      margin: 6px 0 4px;
    }

    .station-list-info {
      font-size: 0.78rem;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    .station-search {
      width: 100%;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--border-light);
      font-size: 0.78rem;
      margin-bottom: 6px;
      background: #ffffff;
      color: var(--text-main);
    }

    .station-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-bottom: 8px;
    }

    .station-item {
      background: var(--bg-card);
      border-radius: 10px;
      padding: 7px 9px;
      border: 1px solid var(--border-light);
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      transition: box-shadow 0.15s ease, border-color 0.15s ease;
    }

    .station-item.active {
      border-color: var(--accent-green);
      box-shadow: 0 4px 12px rgba(22,163,74,0.2);
    }

    .station-main {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .station-name {
      font-size: 0.85rem;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .station-area {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .station-status-pill {
      border-radius: 999px;
      padding: 3px 7px;
      font-size: 0.7rem;
      background: #f3f4f6;
      color: var(--text-muted);
      white-space: nowrap;
    }

    .station-status-pill.good {
      background: rgba(22,163,74,0.12);
      color: #166534;
      border: 1px solid rgba(22,163,74,0.4);
    }

    .station-status-pill.moderate {
      background: rgba(234,179,8,0.12);
      color: #854d0e;
      border: 1px solid rgba(234,179,8,0.4);
    }

    .station-status-pill.unhealthy {
      background: rgba(249,115,22,0.12);
      color: #9a3412;
      border: 1px solid rgba(249,115,22,0.4);
    }

    .station-status-pill.veryunhealthy {
      background: rgba(239,68,68,0.12);
      color: #7f1d1d;
      border: 1px solid rgba(239,68,68,0.4);
    }

    .station-status-pill.hazardous {
      background: rgba(88,28,135,0.12);
      color: #4a044e;
      border: 1px solid rgba(126,34,206,0.4);
    }

    /* Cards & content */

    .cards-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 8px;
      margin-bottom: 8px;
    }

    .card-custom {
      background: var(--bg-card);
      border-radius: 12px;
      padding: 12px 12px;
      border: 1px solid var(--border-light);
      box-shadow: 0 6px 16px rgba(15, 23, 42, 0.04);
    }

    .card-header-line {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 4px;
    }

    .card-label {
      font-size: 0.75rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .card-label i {
      font-size: 0.9rem;
    }

    .card-main {
      display: flex;
      align-items: baseline;
      gap: 6px;
      margin-bottom: 4px;
    }

    .card-value {
      font-size: 1.45rem;
      font-weight: 600;
      color: var(--text-main);
    }

    .card-unit {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .card-note {
      font-size: 0.78rem;
      color: var(--text-muted);
    }

    /* Colored overview cards */

    .card-aq {
      background: linear-gradient(135deg, #ecfdf5, #eff6ff);
    }

    .card-pm25 {
      background: linear-gradient(135deg, #ecfdf5, #dcfce7);
    }

    .card-pm10 {
      background: linear-gradient(135deg, #eff6ff, #dbeafe);
    }

    .card-thermo {
      background: linear-gradient(135deg, #fff7ed, #fef3c7);
    }

    .card-station {
      background: linear-gradient(135deg, #f9fafb, #e5e7eb);
    }

    .aq-pill {
      padding: 3px 7px;
      border-radius: 999px;
      font-size: 0.75rem;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      margin-top: 4px;
    }

    .aq-pill i {
      font-size: 0.8rem;
    }

    .aq-good {
      background: rgba(22,163,74,0.12);
      color: #166534;
      border: 1px solid rgba(22,163,74,0.5);
    }

    .aq-moderate {
      background: rgba(234,179,8,0.12);
      color: #854d0e;
      border: 1px solid rgba(234,179,8,0.5);
    }

    .aq-unhealthy {
      background: rgba(249,115,22,0.12);
      color: #9a3412;
      border: 1px solid rgba(249,115,22,0.6);
    }

    .aq-veryunhealthy {
      background: rgba(239,68,68,0.1);
      color: #7f1d1d;
      border: 1px solid rgba(239,68,68,0.6);
    }

    .aq-hazardous {
      background: rgba(88,28,135,0.12);
      color: #4a044e;
      border: 1px solid rgba(126,34,206,0.7);
    }

    /* Trends section */

    .trends-section {
      margin-top: 4px;
    }

    .controls-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 6px;
      align-items: center;
    }

    .select-small,
    .btn-small {
      border-radius: 999px;
      border: 1px solid var(--border-light);
      padding: 5px 10px;
      font-size: 0.75rem;
      cursor: pointer;
      background: #ffffff;
      color: var(--text-main);
    }

    .btn-small {
      background: var(--accent-blue);
      color: #ffffff;
      border-color: var(--accent-blue);
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .btn-small:hover {
      background: #1e40af;
    }

    .toggle-inline {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .toggle-inline input {
      accent-color: var(--accent-green);
    }

    .chart-wrapper {
      position: relative;
      height: 170px;
      background: #ffffff;
      border-radius: 10px;
      border: 1px solid var(--border-light);
      padding: 6px;
    }

    .chart-caption {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    /* Footer info */

    .panel-footer {
      padding: 6px 10px 8px;
      border-top: 1px solid var(--border-light);
      background: #ffffff;
      font-size: 0.75rem;
      color: var(--text-muted);
      display: flex;
      justify-content: space-between;
      gap: 6px;
      align-items: center;
    }

    .status-text.ok {
      color: var(--accent-green);
    }
    .status-text.error {
      color: #dc2626;
    }

    /* Mobile behavior */
    @media (max-width: 640px) {
      .side-panel {
        width: 100%;
      }
      .side-panel.collapsed {
        transform: translateX(100%);
      }
    }
  </style>
</head>
<body>
  <!-- Top navigation bar -->
  <div class="top-nav">
    <div class="nav-left">
      <img
        src="https://i.ibb.co/4wkhdY4n/Clanertsustain-new-logo.png"
        alt="Clanert logo"
        class="nav-logo"
      >
      <div class="nav-title-block">
        <div class="nav-title">
          <span>ClanertAir</span>
          <i class="bi bi-wind text-success"></i>
        </div>
        <div class="nav-sub" id="navSub">Live · 1 station</div>
      </div>
    </div>
    <button id="navToggle" class="nav-toggle" aria-label="Toggle panel">
      <i class="bi bi-layout-sidebar-inset"></i>
    </button>
  </div>

  <!-- Fullscreen map -->
  <div id="map"></div>

  <!-- Right expandable side panel -->
  <div class="side-panel" id="sidePanel">
    <div class="panel-header">
      <div class="panel-header-title">
        <i class="bi bi-diagram-3 text-primary"></i>
        <span>Stations</span>
      </div>
      <button class="panel-toggle" id="panelToggle" title="Collapse details">
        ❯
      </button>
    </div>

    <div class="panel-body">
      <!-- Station list -->
      <div>
        <div class="panel-section-title">Stations</div>
        <div class="station-list-info" id="stationCountText">1 station</div>
        <input
          type="text"
          id="stationSearch"
          class="station-search"
          placeholder="Search name or area..."
        >
        <div id="stationList" class="station-list"></div>
      </div>

      <!-- Selected station details -->
      <div>
        <div class="panel-section-title">Now</div>
        <div class="cards-grid">
          <div class="card-custom card-aq">
            <div class="card-header-line">
              <div class="card-label">
                <i class="bi bi-speedometer2 text-success"></i>
                <span>Air quality</span>
              </div>
            </div>
            <div class="card-main">
              <div class="card-value" id="aqStatus">--</div>
            </div>
            <div class="card-note" id="aqMessage">
              Waiting for data…
            </div>
            <div id="aqCategoryPill"></div>
          </div>

          <div class="card-custom card-pm25">
            <div class="card-header-line">
              <div class="card-label">
                <i class="bi bi-dot text-success"></i>
                <span>PM2.5</span>
              </div>
            </div>
            <div class="card-main">
              <div class="card-value" id="pm25">--</div>
              <div class="card-unit">µg/m³</div>
            </div>
            <div class="card-note">
              Fine particles.
            </div>
          </div>

          <div class="card-custom card-pm10">
            <div class="card-header-line">
              <div class="card-label">
                <i class="bi bi-circle-half text-primary"></i>
                <span>PM10</span>
              </div>
            </div>
            <div class="card-main">
              <div class="card-value" id="pm10">--</div>
              <div class="card-unit">µg/m³</div>
            </div>
            <div class="card-note">
              Coarse particles.
            </div>
          </div>

          <div class="card-custom card-thermo">
            <div class="card-header-line">
              <div class="card-label">
                <i class="bi bi-thermometer-half text-warning"></i>
                <span>Weather</span>
              </div>
            </div>
            <div class="card-main">
              <div class="card-value" id="temp">--</div>
              <div class="card-unit">°C</div>
            </div>
            <div class="card-note">
              Humidity: <span id="hum">--</span> %.
            </div>
          </div>
        </div>

        <div class="card-custom card-station mb-2">
          <div class="card-header-line">
            <div class="card-label">
              <i class="bi bi-geo-alt text-secondary"></i>
              <span>Station</span>
            </div>
          </div>
          <div class="card-note" id="stationAreaText">--</div>
        </div>
      </div>

      <!-- Trends -->
      <div class="trends-section">
        <div class="panel-section-title">PM trends</div>
        <div class="controls-row">
          <select id="rangeSelect" class="select-small">
            <option value="1">Last hour</option>
            <option value="6">Last 6 h</option>
            <option value="24" selected>Last 24 h</option>
          </select>

          <label class="toggle-inline">
            <input type="checkbox" id="showPm10" checked>
            PM10
          </label>

          <label class="toggle-inline">
            <input type="checkbox" id="autoRefresh" checked>
            Auto
          </label>

          <button id="refreshBtn" class="btn-small">
            <i class="bi bi-arrow-repeat"></i>
            Refresh
          </button>
        </div>

        <div class="chart-caption" id="chartSubtitle">
          Loading data…
        </div>
        <div class="chart-wrapper">
          <canvas id="pmChart"></canvas>
        </div>
      </div>
    </div>

    <div class="panel-footer">
      <div id="timestampText">
        <i class="bi bi-clock"></i>
        <span>Last update: --</span>
      </div>
      <div id="statusText" class="status-text">
        <i class="bi bi-circle text-secondary"></i>
        <span>Idle</span>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS (for icons & potential future UI) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // --- PLATFORM CONFIG -------------------------------------------------
    //
    // Google Apps Script is configured for MULTI-STATION:
    // - Each station has a sheet named by its stationId (e.g. "CLANERT-MAKABE-001")
    // - We always pass ?mode=...&station=STATION_ID
    //
    // Add more stations by pushing to this array with:
    // { id, stationId, name, area, lat, lng, dataUrl }

    const SCRIPT_URL_CLANERT =
      "https://script.google.com/macros/s/AKfycbwD21CyF2Gli6Y6hDPUyds2fzAw7mrJ0NSDrqeiG7yItbZcYL-cbKsLcbHOU7db32wN/exec";

    const stations = [
      {
        id: "clanert-makabe",           // UI id
        stationId: "CLANERT-MAKABE-001",// SHEET name / ESP32 STATION_ID
        name: "ClanertAir – Mbezi Makabe",
        area: "Mbezi Makabe, Dar es Salaam",
        lat: -6.7432882,
        lng: 39.1044879,
        dataUrl: SCRIPT_URL_CLANERT,
        aqLabel: null
      }
      // add more stations later with their own stationId and same Apps Script URL
    ];

    // --- DOM REFERENCES --------------------------------------------------

    const sidePanel = document.getElementById("sidePanel");
    const panelToggle = document.getElementById("panelToggle");
    const navToggle = document.getElementById("navToggle");
    const navSubEl = document.getElementById("navSub");

    const stationCountTextEl = document.getElementById("stationCountText");
    const stationListEl = document.getElementById("stationList");
    const stationSearchEl = document.getElementById("stationSearch");
    const stationAreaTextEl = document.getElementById("stationAreaText");

    const pm25El = document.getElementById("pm25");
    const pm10El = document.getElementById("pm10");
    const tempEl = document.getElementById("temp");
    const humEl  = document.getElementById("hum");
    const aqStatusEl = document.getElementById("aqStatus");
    const aqMessageEl = document.getElementById("aqMessage");
    const aqCategoryPillEl = document.getElementById("aqCategoryPill");

    const rangeSelect = document.getElementById("rangeSelect");
    const autoRefreshEl = document.getElementById("autoRefresh");
    const showPm10El = document.getElementById("showPm10");
    const refreshBtn = document.getElementById("refreshBtn");

    const chartSubtitleEl = document.getElementById("chartSubtitle");
    const timestampTextEl = document.getElementById("timestampText");
    const statusTextEl = document.getElementById("statusText");

    // --- MAP & STATE -----------------------------------------------------

    let map = null;
    let markers = {}; // stationId -> circleMarker
    let pmChart = null;
    let autoRefreshTimer = null;
    let currentStation = stations[0];

    // --- AQ CATEGORY LOGIC ----------------------------------------------

    function classifyAirQuality(pm25) {
      if (pm25 == null || isNaN(pm25)) {
        return {
          label: "Unknown",
          message: "No recent data.",
          className: "aq-pill",
          stationStatusClass: ""
        };
      }

      if (pm25 <= 12) {
        return {
          label: "Good",
          message: "Air is clean.",
          className: "aq-pill aq-good",
          stationStatusClass: "good"
        };
      } else if (pm25 <= 35.4) {
        return {
          label: "Moderate",
          message: "OK for most people.",
          className: "aq-pill aq-moderate",
          stationStatusClass: "moderate"
        };
      } else if (pm25 <= 55.4) {
        return {
          label: "Unhealthy for sensitive",
          message: "Sensitive groups: limit exposure.",
          className: "aq-pill aq-unhealthy",
          stationStatusClass: "unhealthy"
        };
      } else if (pm25 <= 150.4) {
        return {
          label: "Unhealthy",
          message: "Limit outdoor activity.",
          className: "aq-pill aq-veryunhealthy",
          stationStatusClass: "veryunhealthy"
        };
      } else if (pm25 <= 250.4) {
        return {
          label: "Very unhealthy",
          message: "Avoid outdoor air if possible.",
          className: "aq-pill aq-veryunhealthy",
          stationStatusClass: "veryunhealthy"
        };
      } else {
        return {
          label: "Hazardous",
          message: "Stay indoors if you can.",
          className: "aq-pill aq-hazardous",
          stationStatusClass: "hazardous"
        };
      }
    }

    function getMarkerColors(label) {
      switch (label) {
        case "Good":
          return { color: "#16a34a", fillColor: "#22c55e" };
        case "Moderate":
          return { color: "#eab308", fillColor: "#facc15" };
        case "Unhealthy for sensitive":
          return { color: "#f97316", fillColor: "#fb923c" };
        case "Unhealthy":
          return { color: "#ef4444", fillColor: "#f87171" };
        case "Very unhealthy":
          return { color: "#b91c1c", fillColor: "#f97373" };
        case "Hazardous":
          return { color: "#6b21a8", fillColor: "#a855f7" };
        default:
          return { color: "#6b7280", fillColor: "#9ca3af" };
      }
    }

    // --- API CALLS (multi-station aware) --------------------------------

    async function fetchLatest(station) {
      const url =
        station.dataUrl +
        "?mode=latest&station=" +
        encodeURIComponent(station.stationId);

      const res = await fetch(url);
      const text = await res.text();
      let data;
      try {
        data = JSON.parse(text);
      } catch (e) {
        throw new Error("Server did not return JSON.");
      }
      if (data.error === "no_data") {
        throw new Error("No data available yet.");
      }
      return data;
    }

    async function fetchHistory(station, hours) {
      const url =
        station.dataUrl +
        "?mode=history&station=" +
        encodeURIComponent(station.stationId) +
        "&hours=" +
        encodeURIComponent(hours);

      const res = await fetch(url);
      const text = await res.text();
      let data;
      try {
        data = JSON.parse(text);
      } catch (e) {
        throw new Error("History response not JSON.");
      }
      return data;
    }

    // --- UI UPDATE FUNCTIONS --------------------------------------------

    function updateCardsFromLatest(station, latest) {
      const pm25 = parseFloat(latest.pm25);
      const pm10 = parseFloat(latest.pm10);
      const temp = parseFloat(latest.temperature);
      const hum  = parseFloat(latest.humidity);

      pm25El.textContent = isNaN(pm25) ? "--" : pm25.toFixed(1);
      pm10El.textContent = isNaN(pm10) ? "--" : pm10.toFixed(1);
      tempEl.textContent = isNaN(temp) ? "--" : temp.toFixed(1);
      humEl.textContent  = isNaN(hum)  ? "--" : hum.toFixed(0);

      const aqInfo = classifyAirQuality(pm25);
      station.aqLabel = aqInfo.label; // store on station

      aqStatusEl.textContent = aqInfo.label;
      aqMessageEl.textContent = aqInfo.message;
      aqCategoryPillEl.innerHTML =
        `<span class="${aqInfo.className}">
           <i class="bi bi-circle-fill"></i>
           ${aqInfo.label}
         </span>`;

      timestampTextEl.innerHTML =
        `<i class="bi bi-clock"></i> <span>Last update: ${formatTimestampFull(latest.timestamp)}</span>`;

      // Update station area text
      stationAreaTextEl.textContent = station.area;

      // Update marker style & popup
      updateMarkerForStation(station, pm25, pm10, temp, hum, aqInfo);
      // Re-render station list (respecting search)
      renderStationList(stationSearchEl.value);
    }

    function updateMarkerForStation(station, pm25, pm10, temp, hum, aqInfo) {
      const marker = markers[station.id];
      if (!marker) return;
      const colors = getMarkerColors(aqInfo.label);

      marker.setStyle({
        color: colors.color,
        fillColor: colors.fillColor
      });

      const pieces = [];
      if (!isNaN(pm25)) pieces.push(`PM2.5: ${pm25.toFixed(1)} µg/m³`);
      if (!isNaN(pm10)) pieces.push(`PM10: ${pm10.toFixed(1)} µg/m³`);
      if (!isNaN(temp)) pieces.push(`Temp: ${temp.toFixed(1)} °C`);
      if (!isNaN(hum)) pieces.push(`Humidity: ${hum.toFixed(0)} %`);

      const popupHtml = `
        <strong>${station.name}</strong><br>
        Status: ${aqInfo.label}<br>
        ${pieces.join(" · ")}
      `;
      marker.bindPopup(popupHtml);
    }

    function updateChartFromHistory(history) {
      let points = history.points || [];
      const hours = history.hours;

      // Filter invalid data
      points = points.filter(p => {
        const ts = new Date(p.timestamp);
        const pm25 = parseFloat(p.pm25);
        const pm10 = parseFloat(p.pm10);
        return !isNaN(ts.getTime()) && (!isNaN(pm25) || !isNaN(pm10));
      });

      points.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

      if (!points.length) {
        chartSubtitleEl.textContent = "No data in this range.";
      } else {
        chartSubtitleEl.textContent =
          `${points.length} points · last ${hours} h`;
      }

      const labels = points.map(p => formatTimestampShort(p.timestamp));
      const pm25Data = points.map(p => {
        const v = parseFloat(p.pm25);
        return isNaN(v) ? null : v;
      });
      const pm10Data = points.map(p => {
        const v = parseFloat(p.pm10);
        return isNaN(v) ? null : v;
      });

      const showPm10 = showPm10El.checked;
      const ctx = document.getElementById("pmChart").getContext("2d");

      if (pmChart) {
        pmChart.destroy();
      }

      pmChart = new Chart(ctx, {
        type: "line",
        data: {
          labels,
          datasets: [
            {
              label: "PM2.5",
              data: pm25Data,
              borderWidth: 2,
              tension: 0.2,
              pointRadius: 0,
              borderColor: "#16a34a",
              backgroundColor: "rgba(22,163,74,0.12)"
            },
            {
              label: "PM10",
              data: pm10Data,
              borderWidth: 1.5,
              tension: 0.2,
              pointRadius: 0,
              borderColor: "#1d4ed8",
              backgroundColor: "rgba(37,99,235,0.08)",
              borderDash: [4, 3],
              hidden: !showPm10
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            mode: "index",
            intersect: false
          },
          plugins: {
            legend: {
              labels: {
                color: "#111827",
                font: { size: 10 }
              }
            },
            tooltip: {
              callbacks: {
                title: (items) => {
                  const idx = items[0].dataIndex;
                  const p = points[idx];
                  return p ? formatTimestampFull(p.timestamp) : "";
                }
              }
            }
          },
          scales: {
            x: {
              ticks: {
                color: "#6b7280",
                maxTicksLimit: 8
              },
              grid: {
                color: "#e5e7eb"
              }
            },
            y: {
              ticks: {
                color: "#6b7280"
              },
              grid: {
                color: "#e5e7eb"
              },
              suggestedMin: 0,
              suggestedMax: 150
            }
          }
        }
      });
    }

    function formatTimestampFull(ts) {
      if (!ts) return "--";
      const d = new Date(ts);
      if (isNaN(d.getTime())) return String(ts);
      return d.toLocaleString();
    }

    function formatTimestampShort(ts) {
      const d = new Date(ts);
      if (isNaN(d.getTime())) return "";
      return d.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
    }

    // --- STATION LIST RENDERING -----------------------------------------

    function renderStationList(filterText) {
      const q = (filterText || "").trim().toLowerCase();

      const visible = q
        ? stations.filter(s =>
            s.name.toLowerCase().includes(q) ||
            s.area.toLowerCase().includes(q)
          )
        : stations;

      stationCountTextEl.textContent =
        visible.length === 1 ? "1 station" : `${visible.length} stations`;

      navSubEl.textContent =
        "Live · " +
        (stations.length === 1
          ? "1 station"
          : `${stations.length} stations`);

      stationListEl.innerHTML = "";
      visible.forEach(st => {
        const div = document.createElement("div");
        div.className =
          "station-item" + (st.id === currentStation.id ? " active" : "");
        div.dataset.stationId = st.id;

        const main = document.createElement("div");
        main.className = "station-main";

        const name = document.createElement("div");
        name.className = "station-name";
        name.innerHTML = `<i class="bi bi-broadcast-pin text-primary"></i> ${st.name}`;

        const area = document.createElement("div");
        area.className = "station-area";
        area.textContent = st.area;

        main.appendChild(name);
        main.appendChild(area);

        const status = document.createElement("div");
        status.className = "station-status-pill";
        if (st.aqLabel) {
          const labelLower = st.aqLabel.toLowerCase();
          if (labelLower.includes("good")) {
            status.classList.add("good");
          } else if (labelLower.includes("moderate")) {
            status.classList.add("moderate");
          } else if (labelLower.includes("sensitive")) {
            status.classList.add("unhealthy");
          } else if (labelLower.includes("very")) {
            status.classList.add("veryunhealthy");
          } else if (labelLower.includes("hazardous")) {
            status.classList.add("hazardous");
          } else if (labelLower.includes("unhealthy")) {
            status.classList.add("unhealthy");
          }
          status.textContent = st.aqLabel;
        } else {
          status.textContent = "No data";
        }

        div.appendChild(main);
        div.appendChild(status);

        div.addEventListener("click", () => {
          selectStationById(st.id);
        });

        stationListEl.appendChild(div);
      });

      if (visible.length === 0) {
        const empty = document.createElement("div");
        empty.className = "station-list-info";
        empty.textContent = "No stations match your search.";
        stationListEl.appendChild(empty);
      }
    }

    function selectStationById(stationId) {
      const station = stations.find(s => s.id === stationId);
      if (!station) return;
      currentStation = station;

      renderStationList(stationSearchEl.value);
      centerMapOnStation(station);
      refreshAllForCurrentStation();
    }

    // --- MAP INITIALIZATION ---------------------------------------------

    function initMap() {
      const first = stations[0];
      map = L.map("map").setView([first.lat, first.lng], 13);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: "&copy; OpenStreetMap contributors"
      }).addTo(map);

      stations.forEach(st => {
        const circle = L.circleMarker([st.lat, st.lng], {
          radius: 10,
          color: "#6b7280",
          weight: 2,
          fillColor: "#9ca3af",
          fillOpacity: 0.9
        }).addTo(map);

        circle.bindPopup(st.name);
        circle.on("click", () => {
          selectStationById(st.id);
        });

        markers[st.id] = circle;
      });

      stationAreaTextEl.textContent = stations[0].area;
    }

    function centerMapOnStation(station) {
      if (!map) return;
      map.setView([station.lat, station.lng], 13);
    }

    // --- REFRESH LOGIC ---------------------------------------------------

    async function refreshAllForCurrentStation() {
      const station = currentStation;
      const hours = parseInt(rangeSelect.value, 10) || 1;

      statusTextEl.innerHTML =
        `<span class="text-muted"><i class="bi bi-arrow-repeat"></i> Updating…</span>`;
      statusTextEl.className = "status-text";

      try {
        const [latest, history] = await Promise.all([
          fetchLatest(station),
          fetchHistory(station, hours)
        ]);

        updateCardsFromLatest(station, latest);
        updateChartFromHistory(history);

        statusTextEl.innerHTML =
          `<span class="text-success"><i class="bi bi-check-circle"></i> Updated</span>`;
        statusTextEl.className = "status-text ok";
      } catch (err) {
        console.error(err);
        statusTextEl.innerHTML =
          `<span class="text-danger"><i class="bi bi-exclamation-circle"></i> Error</span>`;
        statusTextEl.className = "status-text error";
      }
    }

    function setupAutoRefresh() {
      if (autoRefreshTimer) {
        clearInterval(autoRefreshTimer);
        autoRefreshTimer = null;
      }
      if (autoRefreshEl.checked) {
        autoRefreshTimer = setInterval(() => {
          refreshAllForCurrentStation();
        }, 60000);
      }
    }

    // --- PANEL TOGGLING --------------------------------------------------

    function togglePanel() {
      const collapsed = sidePanel.classList.toggle("collapsed");
      panelToggle.textContent = collapsed ? "❮" : "❯";
      if (map) {
        setTimeout(() => {
          map.invalidateSize();
        }, 250);
      }
    }

    panelToggle.addEventListener("click", togglePanel);
    navToggle.addEventListener("click", togglePanel);

    // --- OTHER EVENTS ----------------------------------------------------

    refreshBtn.addEventListener("click", () => {
      refreshAllForCurrentStation();
    });

    rangeSelect.addEventListener("change", () => {
      refreshAllForCurrentStation();
    });

    autoRefreshEl.addEventListener("change", () => {
      setupAutoRefresh();
    });

    showPm10El.addEventListener("change", () => {
      if (pmChart) {
        const ds = pmChart.data.datasets[1];
        ds.hidden = !showPm10El.checked;
        pmChart.update();
      }
    });

    stationSearchEl.addEventListener("input", () => {
      renderStationList(stationSearchEl.value);
    });

    window.addEventListener("resize", () => {
      if (map) {
        setTimeout(() => {
          map.invalidateSize();
        }, 200);
      }
    });

    // --- INITIAL BOOT ----------------------------------------------------

    window.addEventListener("load", () => {
      initMap();
      renderStationList("");
      centerMapOnStation(currentStation);
      refreshAllForCurrentStation();
      setupAutoRefresh();
    });
  </script>
</body>
</html>
