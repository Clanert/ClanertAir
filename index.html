<!-- /index.html -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ClanertAir · Mbezi Makabe</title>

  <!-- Bootstrap 5 + Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"/>

  <!-- Chart.js + Leaflet -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root{ --accent:#4f46e5; --muted:#6b7280; --border:#e5e7eb; }
    html,body{height:100%;background:#fff;}
    .navbar{background:#0f172a;}
    .navbar .navbar-brand,.navbar .nav-link,.navbar .btn{color:#fff!important}
    .map-wrap{position:relative;height:70vh;border-bottom:1px solid var(--border);}
    #map{height:100%;width:100%;}
    .overlay{
      position:absolute;inset:auto auto 1rem 1rem;z-index:500;background:#fff;border:1px solid var(--border);
      border-radius:.75rem;box-shadow:0 10px 30px rgba(0,0,0,.08); padding:0.75rem 0.75rem 0.75rem 0.75rem;
    }
    .kpi-card{border:1px solid var(--border);border-radius:.75rem;min-width:140px}
    .metric{font-size:clamp(1.25rem,3vw,1.75rem);font-weight:700;}
    .metric-sub{font-size:.875rem;color:var(--muted);}
    .badge-aqi{font-weight:600;color:#fff;}
    .aqi-good{background:#22c55e!important}
    .aqi-moderate{background:#eab308!important}
    .aqi-ufsg{background:#f59e0b!important}
    .aqi-unhealthy{background:#ef4444!important}
    .aqi-vunhealthy{background:#a855f7!important}
    .aqi-hazardous{background:#7f1d1d!important}
    .status-ribbon{
      position:absolute;top:.5rem;right:.5rem;z-index:510;padding:.35rem .6rem;border-radius:.5rem;
      font-weight:600;font-size:.85rem;color:#fff;box-shadow:0 4px 16px rgba(0,0,0,.15);
    }
    .online{background:#22c55e}.offline{background:#ef4444}
    .sticky-ctrls{position:sticky;top:.75rem;z-index:400}
    .legend-toggle input{accent-color:var(--accent)}
    .btn-accent{background:var(--accent);border-color:var(--accent)}
    .btn-outline-accent{color:#4f46e5;border-color:#4f46e5}
    .btn-outline-accent:hover{background:#4f46e5;color:#fff}
    .hidden{display:none!important}

    .activity-card{border:1px solid var(--border); border-radius:.75rem; padding:.75rem; display:flex; align-items:center; gap:.75rem;}
    .activity-icon{display:inline-flex; align-items:center; justify-content:center; width:40px; height:40px; border-radius:50%; color:#fff; font-size:1.1rem;}
    .ok{background:#22c55e} .caution{background:#eab308} .avoid{background:#ef4444}
    .note{font-size:.85rem; color:var(--muted);}
    .pill{display:inline-flex; align-items:center; gap:.35rem; padding:.25rem .5rem; border-radius:999px; border:1px solid var(--border); background:#fff;}
    .date-ribbon{font-size:.8rem;border:1px solid var(--border);border-radius:999px;padding:.2rem .6rem;color:#374151;background:#fff;}

    /* Public/Private ribbon — now inside measurement overlay */
    .vis-ribbon{
      position:absolute; top:.5rem; right:.5rem; z-index:520;
      padding:.35rem .6rem; border-radius:.5rem; font-weight:600; font-size:.85rem; color:#fff;
      box-shadow:0 4px 16px rgba(0,0,0,.15);
    }
    .vis-public{background:#16a34a}
    .vis-private{background:#f59e0b}
  </style>
</head>
<body>
  <!-- NAV -->
  <nav class="navbar navbar-expand-lg">
    <div class="container">
      <a class="navbar-brand fw-bold d-flex align-items-center gap-2" href="#">
        <i class="bi bi-cloud-fog2"></i> ClanertAir · Mbezi Makabe
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#nav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div id="nav" class="collapse navbar-collapse">
        <ul class="navbar-nav me-auto ms-2">
          <li class="nav-item"><a class="nav-link" href="#mapsec">Map</a></li>
          <li class="nav-item"><a class="nav-link" href="#overview">Overview</a></li>
          <li class="nav-item"><a class="nav-link" href="#stations">Stations</a></li>
        </ul>
        <div class="d-flex gap-2">
          <button id="btnLatest" class="btn btn-sm btn-outline-light"><i class="bi bi-broadcast-pin"></i> Latest</button>
          <button id="btnHistory" class="btn btn-sm btn-outline-light"><i class="bi bi-graph-up"></i> History</button>
          <button id="btnAll" class="btn btn-sm btn-primary"><i class="bi bi-arrow-repeat"></i> Refresh</button>
        </div>
      </div>
    </div>
  </nav>

  <!-- MAP -->
  <section id="mapsec" class="map-wrap">
    <div id="map"></div>
    <div id="statusRibbon" class="status-ribbon offline">Offline</div>

    <!-- Measurement overlay banner -->
    <div class="overlay">
      <!-- MOVED: visibility ribbon into overlay (top-right) -->
      <div id="visibilityRibbon" class="vis-ribbon vis-public">Public</div>

      <div class="p-3">
        <div class="d-flex flex-wrap gap-3">
          <div class="kpi-card p-3">
            <div class="text-secondary">Station</div>
            <div class="fw-semibold" id="headerStationName">CLANERT · Mbezi Makabe</div>
            <div class="small text-secondary" id="headerStationArea">Dar es Salaam</div>
          </div>
          <div class="kpi-card p-3">
            <div class="text-secondary">PM2.5</div>
            <div class="metric" id="kpiPm25">—</div>
            <div class="metric-sub">µg/m³</div>
          </div>
          <div class="kpi-card p-3">
            <div class="text-secondary">PM10</div>
            <div class="metric" id="kpiPm10">—</div>
            <div class="metric-sub">µg/m³</div>
          </div>
          <div class="kpi-card p-3">
            <div class="text-secondary">Temp <i class="bi bi-thermometer-half"></i></div>
            <div class="metric" id="kpiTemp">—</div>
            <div class="metric-sub">°C</div>
          </div>
          <div class="kpi-card p-3">
            <div class="text-secondary">Humidity <i class="bi bi-droplet-half"></i></div>
            <div class="metric" id="kpiHum">—</div>
            <div class="metric-sub">%</div>
          </div>
          <div class="kpi-card p-3">
            <div class="text-secondary">AQI</div>
            <div class="d-flex align-items-center gap-2">
              <div class="metric" id="kpiAQI">—</div>
              <span id="kpiAQIBadge" class="badge badge-aqi text-white">—</span>
              <i id="kpiAQIEmoji" class="bi"></i>
            </div>
            <div class="metric-sub" id="kpiAQINote">—</div>
          </div>
        </div>
        <div class="text-secondary small mt-2">
          Last sample: <span id="kpiTime">—</span>
        </div>
      </div>
    </div>
  </section>

  <!-- OVERVIEW -->
  <section id="overview" class="container py-4">
    <div class="row g-3">
      <div class="col-12 col-lg-4">
        <div class="sticky-ctrls">
          <div class="card">
            <div class="card-body">
              <h6 class="card-title mb-3">Controls</h6>
              <div class="mb-3">
                <label class="form-label">Station</label>
                <select id="stationSelect" class="form-select"></select>
                <div class="form-text">Kept for future multi-station.</div>
              </div>
              <div class="mb-3">
                <label class="form-label">Search</label>
                <input id="stationSearch" class="form-control" placeholder="Search (future)"/>
              </div>

              <!-- Unlock private station -->
              <div class="mb-3">
                <label class="form-label">Unlock Private Station</label>
                <div class="input-group">
                  <input id="unlockInput" class="form-control" placeholder="Type exact station code or name"/>
                  <button id="btnUnlock" class="btn btn-outline-secondary"><i class="bi bi-unlock"></i> Unlock</button>
                </div>
                <div id="unlockMsg" class="form-text"></div>
              </div>

              <div class="mb-3">
                <label class="form-label">Hours</label>
                <input id="hoursInput" class="form-control" type="number" min="1" step="1" value="24"/>
              </div>
              <div class="d-grid gap-2">
                <button id="btnCtlLatest" class="btn btn-outline-accent"><i class="bi bi-broadcast-pin"></i> Latest</button>
                <button id="btnCtlHistory" class="btn btn-outline-secondary"><i class="bi bi-graph-up"></i> History</button>
                <button id="btnCtlAll" class="btn btn-accent text-white"><i class="bi bi-arrow-repeat"></i> Refresh</button>
                <button id="btnDownloadCsv" class="btn btn-outline-secondary"><i class="bi bi-download"></i> Download CSV</button>
              </div>
            </div>
          </div>
          <div id="alert" class="alert alert-danger mt-3 d-none" role="alert">
            <i class="bi bi-exclamation-triangle"></i> <span id="alertMsg">Error</span>
          </div>
        </div>
      </div>

      <div class="col-12 col-lg-8">
        <!-- Activities (Live & Average) -->
        <div class="card mb-3">
          <div class="card-body">
            <h6 class="card-title mb-3">Activities & Air Quality</h6>
            <div class="d-flex align-items-center gap-3 mb-3 flex-wrap">
              <div class="pill">
                <span class="text-secondary small">Live AQI</span>
                <span id="liveAQIVal" class="fw-semibold">—</span>
                <span id="liveAQIBadge" class="badge badge-aqi">—</span>
                <i id="liveAQIEmoji" class="bi"></i>
              </div>
              <div class="pill">
                <span class="text-secondary small">Average AQI (last <span id="avgHoursLabel">—</span>h)</span>
                <span id="avgAQIVal" class="fw-semibold">—</span>
                <span id="avgAQIBadge" class="badge badge-aqi">—</span>
                <i id="avgAQIEmoji" class="bi"></i>
              </div>
            </div>
            <div class="row g-2" id="activitiesGrid"></div>
          </div>
        </div>

        <!-- PM Trends -->
        <div class="card mb-3">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2 flex-wrap gap-2">
              <div class="d-flex align-items-center gap-3">
                <h6 class="card-title m-0">PM Trends</h6>
                <span id="historyDateRibbon" class="date-ribbon">—</span>
              </div>
              <div class="legend-toggle small">
                <label class="me-3"><input class="form-check-input me-1" type="checkbox" checked data-series="pm25"> PM2.5</label>
                <label><input class="form-check-input me-1" type="checkbox" checked data-series="pm10"> PM10</label>
              </div>
            </div>
            <canvas id="historyChart" height="140"></canvas>
          </div>
        </div>

        <!-- Averages -->
        <div class="card mb-3">
          <div class="card-body">
            <h6 class="card-title mb-2">Averages (last <span id="avgHoursLabel2">—</span>h)</h6>
            <div class="row g-2">
              <div class="col-6 col-md-3"><div class="p-2 border rounded"><div class="small text-secondary">PM2.5</div><div id="avgPm25" class="fw-semibold">—</div></div></div>
              <div class="col-6 col-md-3"><div class="p-2 border rounded"><div class="small text-secondary">PM10</div><div id="avgPm10" class="fw-semibold">—</div></div></div>
              <div class="col-6 col-md-3"><div class="p-2 border rounded"><div class="small text-secondary">Temp <i class="bi bi-thermometer-half"></i></div><div id="avgTemp" class="fw-semibold">—</div></div></div>
              <div class="col-6 col-md-3"><div class="p-2 border rounded"><div class="small text-secondary">Humidity <i class="bi bi-droplet-half"></i></div><div id="avgHum" class="fw-semibold">—</div></div></div>
            </div>
            <div class="d-flex align-items-center gap-2 mt-2">
              <span class="text-secondary small">Samples</span>
              <span id="avgCount" class="badge text-bg-light">—</span>
              <span class="text-secondary small ms-3">Average AQI</span>
              <span id="avgAQIVal2" class="fw-semibold">—</span>
              <span id="avgAQIBadge2" class="badge badge-aqi">—</span>
              <i id="avgAQIEmoji2" class="bi"></i>
            </div>
          </div>
        </div>

        <!-- Hidden table (CSV only) -->
        <div id="historyTableWrap" class="card hidden">
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-sm align-middle">
                <thead><tr><th>Timestamp</th><th>PM2.5</th><th>PM10</th></tr></thead>
                <tbody id="historyBody"></tbody>
              </table>
            </div>
          </div>
        </div>

      </div>
    </div>

    <!-- Footer -->
    <div class="d-flex flex-column flex-md-row align-items-center justify-content-between gap-2 border-top pt-3 mt-3">
      <div class="small text-secondary">© Clanert Sustain</div>
      <div class="small">
        <a href="https://www.clanertsustain.co.tz" class="link-secondary text-decoration-none" target="_blank" rel="noreferrer">
          www.clanertsustain.co.tz
        </a> · <i class="bi bi-telephone"></i> +255 621 667 315
      </div>
    </div>
  </section>

  <!-- STATIONS placeholder -->
  <section id="stations" class="container py-4">
    <div class="card"><div class="card-body">
      <h6 class="card-title m-0">Stations</h6>
      <div class="small text-secondary">Ready for future additions.</div>
    </div></div>
  </section>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
          integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

  <script>
    // ========= CONFIG =========
    const FALLBACK_STATION = { station:"CLANERT-MAKABE-001", name:"CLANERT · Mbezi Makabe", area:"Dar es Salaam", lat:-6.7350, lng:39.1800, visibility:"public" };
    const PUBLIC_STATIONS = new Set([FALLBACK_STATION.station]); // others treated as private unless listed
    const BASE_URL = "https://script.google.com/macros/s/AKfycbwD21CyF2Gli6Y6hDPUyds2fzAw7mrJ0NSDrqeiG7yItbZcYL-cbKsLcbHOU7db32wN/exec";
    const ONLINE_THRESHOLD_MIN = 10;

    // ========= DOM =========
    const el = (id)=>document.getElementById(id);
    const $hours=el("hoursInput"), $statusRibbon=el("statusRibbon"), $historyBody=el("historyBody"), $alert=el("alert"), $alertMsg=el("alertMsg");
    const $stationSelect=el("stationSelect"), $stationSearch=el("stationSearch"), $headerStationName=el("headerStationName"), $headerStationArea=el("headerStationArea");
    const $activitiesGrid=el("activitiesGrid"), $kpiTemp=el("kpiTemp"), $kpiHum=el("kpiHum");
    const $liveAQIVal=el("liveAQIVal"), $liveAQIBadge=el("liveAQIBadge"), $liveAQIEmoji=el("liveAQIEmoji");
    const $avgAQIVal=el("avgAQIVal"), $avgAQIBadge=el("avgAQIBadge"), $avgAQIEmoji=el("avgAQIEmoji");
    const $avgHoursLabel=el("avgHoursLabel"), $avgHoursLabel2=el("avgHoursLabel2");
    const $avgPm25=el("avgPm25"), $avgPm10=el("avgPm10"), $avgTemp=el("avgTemp"), $avgHum=el("avgHum"), $avgCount=el("avgCount");
    const $avgAQIVal2=el("avgAQIVal2"), $avgAQIBadge2=el("avgAQIBadge2"), $avgAQIEmoji2=el("avgAQIEmoji2");
    const $historyDateRibbon=el("historyDateRibbon");
    const $visibilityRibbon=el("visibilityRibbon");
    const $unlockInput=el("unlockInput"), $btnUnlock=el("btnUnlock"), $unlockMsg=el("unlockMsg");

    const btns={
      navLatest:el("btnLatest"), navHistory:el("btnHistory"), navAll:el("btnAll"),
      ctlLatest:el("btnCtlLatest"), ctlHistory:el("btnCtlHistory"), ctlAll:el("btnCtlAll"),
      downloadCsv:el("btnDownloadCsv"),
    };

    // ========= STATE =========
    let chart,map,marker,stations=[],selectedId=FALLBACK_STATION.station,lastHistory=[];

    // ========= MAP =========
    function initMap(){
      map=L.map('map',{zoomControl:true}).setView([FALLBACK_STATION.lat,FALLBACK_STATION.lng],14);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'&copy; OpenStreetMap'}).addTo(map);
      marker=L.circleMarker([FALLBACK_STATION.lat,FALLBACK_STATION.lng],{radius:14,weight:2,color:'#888',fillColor:'#aaa',fillOpacity:.9}).addTo(map);
      marker.bindPopup("<div id='stationPopup'>Tap refresh</div>");
      marker.on('click',()=>marker.openPopup());
    }
    function setMarkerStyle(cat){ const c={ "aqi-good":"#22c55e","aqi-moderate":"#eab308","aqi-ufsg":"#f59e0b","aqi-unhealthy":"#ef4444","aqi-vunhealthy":"#a855f7","aqi-hazardous":"#7f1d1d" }[cat]||"#999"; marker.setStyle({color:c,fillColor:c,radius:14}); }
    function setMarkerPopup(html){ const p=document.getElementById('stationPopup'); if(p) p.innerHTML=html; else marker.bindPopup(html); }
    function panTo(st){ if(Number.isFinite(st.lat)&&Number.isFinite(st.lng)) map.setView([st.lat,st.lng],14); }

    // ========= AQI =========
    function aqiFromConcentration(c,b){ for(const [Cl,Ch,Il,Ih] of b){ if(c>=Cl&&c<=Ch) return Math.round(((Ih-Il)/(Ch-Cl))*(c-Cl)+Il);} return null;}
    function aqiPm25(pm){ const c=Math.max(0,Math.min(Number(pm),500.4)); const bp=[[0,12,0,50],[12.1,35.4,51,100],[35.5,55.4,101,150],[55.5,150.4,151,200],[150.5,250.4,201,300],[250.5,350.4,301,400],[350.5,500.4,401,500]]; return aqiFromConcentration(c,bp); }
    function aqiPm10(pm){ const c=Math.max(0,Math.min(Number(pm),604)); const bp=[[0,54,0,50],[55,154,51,100],[155,254,101,150],[255,354,151,200],[355,424,201,300],[425,504,301,400],[505,604,401,500]]; return aqiFromConcentration(c,bp); }
    function aqiCategory(aqi){ if(aqi==null) return {cls:"text-bg-secondary",code:"—",note:"—",emoji:"bi-emoji-expressionless",level:"caution"}; if(aqi<=50) return {cls:"aqi-good",code:"Good",note:"Satisfactory.",emoji:"bi-emoji-smile",level:"ok"}; if(aqi<=100) return {cls:"aqi-moderate",code:"Moderate",note:"Acceptable.",emoji:"bi-emoji-neutral",level:"ok"}; if(aqi<=150) return {cls:"aqi-ufsg",code:"Unhealthy (SG)",note:"Sensitive groups caution.",emoji:"bi-emoji-frown",level:"caution"}; if(aqi<=200) return {cls:"aqi-unhealthy",code:"Unhealthy",note:"Everyone may feel effects.",emoji:"bi-emoji-angry",level:"avoid"}; if(aqi<=300) return {cls:"aqi-vunhealthy",code:"Very Unhealthy",note:"Health alert.",emoji:"bi-emoji-dizzy",level:"avoid"}; return {cls:"aqi-hazardous",code:"Hazardous",note:"Emergency conditions.",emoji:"bi-emoji-dizzy",level:"avoid"}; }

    // ========= UTILS =========
    function showError(msg){ $alertMsg.textContent=msg; $alert.classList.remove("d-none"); }
    function clearError(){ $alert.classList.add("d-none"); }
    function fmtNum(x,d=1){ const n=Number(x); return Number.isFinite(n)?n.toFixed(d):"—"; }
    function fmtTime(ts){ const d=new Date(ts); return isNaN(d)?"—":d.toLocaleString(); }
    function fmtHHMM(ts){ const d=new Date(ts); if(isNaN(d)) return "—"; const h=String(d.getHours()).padStart(2,'0'); const m=String(d.getMinutes()).padStart(2,'0'); return `${h}:${m}`; }
    function fmtDate(ts){ const d=new Date(ts); if(isNaN(d)) return "—"; return d.toLocaleDateString(undefined,{year:"numeric",month:"short",day:"numeric"}); }
    function minutesSince(ts){ const d=new Date(ts); if(isNaN(d)) return Infinity; return (Date.now()-d.getTime())/60000; }
    function buildUrl(mode,station,params={}){ const u=new URL(BASE_URL); u.searchParams.set("mode",mode); if(station) u.searchParams.set("station",station); Object.entries(params).forEach(([k,v])=>{ if(v!==undefined&&v!==null&&`${v}`.length) u.searchParams.set(k,v); }); return u.toString(); }
    async function fetchJson(url){ const ctrl=new AbortController(); const t=setTimeout(()=>ctrl.abort(),15000); try{ const res=await fetch(url,{signal:ctrl.signal,cache:"no-store"}); if(!res.ok){ const txt=await res.text().catch(()=> ""); throw new Error(`HTTP ${res.status} ${txt||res.statusText}`);} return await res.json(); } finally { clearTimeout(t); } }
    function setBusy(b){ const all=[btns.navAll,btns.navHistory,btns.navLatest,btns.ctlAll,btns.ctlHistory,btns.ctlLatest,btns.downloadCsv,$btnUnlock]; all.forEach(x=>x.disabled=b); const html=b?`<span class="spinner-border spinner-border-sm me-1"></span> Refresh`:`<i class="bi bi-arrow-repeat"></i> Refresh`; btns.navAll.innerHTML=html; btns.ctlAll.innerHTML=html; }

    // ========= Activities =========
    function activitiesFor(cat){ const ok=(t,i,n)=>({cls:"ok",icon:i,title:t,note:n}); const ca=(t,i,n)=>({cls:"caution",icon:i,title:t,note:n}); const av=(t,i,n)=>({cls:"avoid",icon:i,title:t,note:n});
      if(cat.level==="ok") return [ok("Running","bi-bicycle","Good to go."),ok("Outdoor play","bi-sun","No restrictions."),ok("Commuting/Walking","bi-signpost","Normal activity."),ok("Windows open","bi-wind","Ventilation OK.")];
      if(cat.level==="caution") return [ca("Running (sensitive)","bi-activity","Shorter, lighter effort."),ca("Outdoor play","bi-tree","Limit duration; watch symptoms."),ca("Commuting/Walking","bi-signpost","Prefer less-busy routes."),ca("Masks (SG)","bi-shield-check","Consider mask if sensitive.")];
      return [av("Running","bi-activity","Avoid vigorous exercise."),av("Outdoor play","bi-tree","Move indoors if possible."),av("Commuting","bi-signpost","Reduce exposure; mask recommended."),av("Windows closed","bi-wind","Filter/recirculate air.")];
    }
    function renderActivities(cat){ $activitiesGrid.innerHTML=activitiesFor(cat).map(it=>`
      <div class="col-12 col-md-6">
        <div class="activity-card">
          <span class="activity-icon ${it.cls}"><i class="bi ${it.icon}"></i></span>
          <div><div class="fw-semibold">${it.title}</div><div class="note">${it.note}</div></div>
        </div>
      </div>`).join(""); }

    // ========= Renderers =========
    function updateHeader(st){
      $headerStationName.textContent=st.name;
      $headerStationArea.textContent=st.area||"—";
      const isPublic = PUBLIC_STATIONS.has(st.station) || st.visibility==="public";
      $visibilityRibbon.textContent = isPublic ? "Public" : "Private";
      $visibilityRibbon.className = `vis-ribbon ${isPublic ? "vis-public" : "vis-private"}`;
    }
    function updateStatusRibbon(ts){ const online=minutesSince(ts)<=ONLINE_THRESHOLD_MIN; $statusRibbon.textContent=online?"Online":"Offline"; $statusRibbon.className=`status-ribbon ${online?"online":"offline"}`; }
    function setLiveAQIPill(aqi,cat){ $liveAQIVal.textContent=aqi??"—"; $liveAQIBadge.textContent=cat.code; $liveAQIBadge.className=`badge badge-aqi ${cat.cls}`; $liveAQIEmoji.className=`bi ${cat.emoji}`; }
    function setAvgAQIPill(aqi,cat,h){ $avgHoursLabel.textContent=h; $avgHoursLabel2.textContent=h; $avgAQIVal.textContent=aqi??"—"; $avgAQIBadge.textContent=cat.code; $avgAQIBadge.className=`badge badge-aqi ${cat.cls}`; $avgAQIEmoji.className=`bi ${cat.emoji}`; $avgAQIVal2.textContent=aqi??"—"; $avgAQIBadge2.textContent=cat.code; $avgAQIBadge2.className=`badge badge-aqi ${cat.cls}`; $avgAQIEmoji2.className=`bi ${cat.emoji}`; }

    function renderLatest(j,st){
      if(j.error) throw new Error(j.message||j.error);
      el("kpiPm25").textContent=fmtNum(j.pm25); el("kpiPm10").textContent=fmtNum(j.pm10);
      $kpiTemp.textContent=fmtNum(j.temperature); $kpiHum.textContent=fmtNum(j.humidity);
      el("kpiTime").textContent=fmtTime(j.timestamp);

      const aqi25=aqiPm25(j.pm25), aqi10=aqiPm10(j.pm10), aqi=Math.max(aqi25??0,aqi10??0)||null, cat=aqiCategory(aqi);
      el("kpiAQI").textContent=aqi??"—"; const b=el("kpiAQIBadge"); b.textContent=cat.code; b.className=`badge badge-aqi ${cat.cls}`; el("kpiAQIEmoji").className=`bi ${cat.emoji}`; el("kpiAQINote").textContent=cat.note;

      setMarkerStyle(cat.cls); marker.setLatLng([st.lat,st.lng]); setMarkerPopup(`
        <div class="small">
          <div class="fw-semibold mb-1">${st.name}</div>
          <div>AQI: <span class="badge badge-aqi ${cat.cls}">${aqi??"—"} · ${cat.code}</span> <i class="bi ${cat.emoji}"></i></div>
          <div>PM2.5: <b>${fmtNum(j.pm25)}</b> µg/m³ · PM10: <b>${fmtNum(j.pm10)}</b> µg/m³</div>
          <div>Temp: <b>${fmtNum(j.temperature)}</b> °C · Humidity: <b>${fmtNum(j.humidity)}</b> %</div>
          <div class="text-secondary">Last: ${fmtTime(j.timestamp)}</div>
        </div>`);

      updateStatusRibbon(j.timestamp);
      setLiveAQIPill(aqi,cat);
      renderActivities(cat);
    }

    function ensureChart(){
      if(chart) return chart;
      chart=new Chart(el("historyChart"),{
        type:"line",
        data:{labels:[],datasets:[]},
        options:{responsive:true,interaction:{mode:"index",intersect:false},scales:{x:{grid:{color:"#eee"}},y:{grid:{color:"#f2f2f2"}}},plugins:{legend:{position:"bottom"}}}
      });
      document.querySelectorAll(".legend-toggle input[type=checkbox]").forEach((cb,idx)=>{ cb.onchange=()=>{ chart.toggleDataVisibility(idx); chart.update(); }; });
      return chart;
    }

    function renderHistory(j){
      if(j.error) throw new Error(j.message||j.error);
      const pts=Array.isArray(j.points)?j.points:[]; lastHistory=pts;

      $historyBody.innerHTML="";
      if(pts.length){
        const frag=document.createDocumentFragment();
        pts.forEach(p=>{ const tr=document.createElement("tr"); tr.innerHTML=`<td>${fmtTime(p.timestamp)}</td><td>${fmtNum(p.pm25,2)}</td><td>${fmtNum(p.pm10,2)}</td>`; frag.appendChild(tr); });
        $historyBody.appendChild(frag);
      }

      const labels=pts.map(p=>fmtHHMM(p.timestamp));
      const mk=(label,key)=>({label,data:pts.map(p=>Number(p[key])),borderWidth:2,pointRadius:0,tension:.25});
      const c=ensureChart(); c.data.labels=labels; c.data.datasets=[ mk("PM2.5 (µg/m³)","pm25"), mk("PM10 (µg/m³)","pm10") ]; c.update();

      if(pts.length){ const first=fmtDate(pts[0].timestamp); const last=fmtDate(pts[pts.length-1].timestamp); $historyDateRibbon.textContent=first===last?first:`${first} – ${last}`; } else { $historyDateRibbon.textContent="—"; }
    }

    function renderAvg(j,h){
      if(j.error) throw new Error(j.message||j.error);
      $avgPm25.textContent=fmtNum(j.pm25_avg); $avgPm10.textContent=fmtNum(j.pm10_avg);
      $avgTemp.textContent=fmtNum(j.temperature_avg); $avgHum.textContent=fmtNum(j.humidity_avg);
      $avgCount.textContent=j.count??0;

      const aqi25=aqiPm25(j.pm25_avg), aqi10=aqiPm10(j.pm10_avg), avgAQI=(aqi25==null&&aqi10==null)?null:Math.max(aqi25??0,aqi10??0), avgCat=aqiCategory(avgAQI);
      setAvgAQIPill(avgAQI,avgCat,h); renderActivities(avgCat);
    }

    // ========= API helpers =========
    async function loadLatest(id){ const j=await fetchJson(buildUrl("latest",id)); const st=stations.find(s=>s.station===id)||FALLBACK_STATION; renderLatest(j,st); }
    async function loadHistory(id,h){ const j=await fetchJson(buildUrl("history",id,{hours:h})); renderHistory(j); }
    async function loadAvg(id,h){ const j=await fetchJson(buildUrl("avg",id,{hours:h})); renderAvg(j,h); }

    // ========= CSV =========
    function downloadCSV(){
      if(!lastHistory.length){ showError("No history loaded to download."); return; }
      const rows=[["Timestamp","PM2.5","PM10"],...lastHistory.map(p=>[new Date(p.timestamp).toISOString(),String(p.pm25??""),String(p.pm10??"")])];
      const csv=rows.map(r=>r.map(v=>/[,\"\n]/.test(v)?`"${String(v).replace(/"/g,'""')}"`:v).join(",")).join("\n");
      const blob=new Blob([csv],{type:"text/csv;charset=utf-8;"}); const a=document.createElement("a"); a.href=URL.createObjectURL(blob); const h=Math.max(1,parseInt($hours.value,10)||24); a.download=`${selectedId}_history_${h}h.csv`; document.body.appendChild(a); a.click(); a.remove();
    }

    // ========= Visibility / Unlock =========
    function setVisibilityRibbon(stationId){
      const isPublic = PUBLIC_STATIONS.has(stationId) || (stations.find(s=>s.station===stationId)?.visibility==="public");
      $visibilityRibbon.textContent = isPublic ? "Public" : "Private";
      $visibilityRibbon.className = `vis-ribbon ${isPublic ? "vis-public" : "vis-private"}`;
    }
    function upsertStation(st){
      const i = stations.findIndex(x=>x.station===st.station);
      if(i>=0) stations[i]=st; else stations.push(st);
      const cur = $stationSelect.value || selectedId;
      $stationSelect.innerHTML = stations.map(s => `<option value="${s.station}">${s.name} (${s.station})</option>`).join("");
      $stationSelect.value = cur;
    }

    // ========= INIT =========
    (async function init(){
      initMap(); clearError();
      const usp=new URLSearchParams(location.search); const h=Number(usp.get("hours")||localStorage.getItem("clanert_hours")||24); $hours.value=h>0?h:24;

      // seed public station
      stations=[{...FALLBACK_STATION, visibility:"public"}]; selectedId=stations[0].station;
      updateHeader(stations[0]); setVisibilityRibbon(selectedId);
      $stationSelect.innerHTML=stations.map(s=>`<option value="${s.station}">${s.name} (${s.station})</option>`).join(""); $stationSelect.value=selectedId;

      $stationSelect.onchange=()=>{ selectedId=$stationSelect.value; const st=stations.find(x=>x.station===selectedId)||FALLBACK_STATION; updateHeader(st); setVisibilityRibbon(selectedId); panTo(st); btns.ctlAll.click(); };
      $stationSearch.addEventListener("input",()=>{});

      // nav mirrors
      btns.navLatest.onclick=()=>btns.ctlLatest.click(); btns.navHistory.onclick=()=>btns.ctlHistory.click(); btns.navAll.onclick=()=>btns.ctlAll.click();

      // loaders
      btns.ctlLatest.onclick=async()=>{ clearError(); try{ setBusy(true); await loadLatest(selectedId); }catch(e){ showError(e.message);}finally{ setBusy(false);} };
      btns.ctlHistory.onclick=async()=>{ clearError(); try{ setBusy(true); await loadHistory(selectedId, Math.max(1, parseInt($hours.value,10)||24)); }catch(e){ showError(e.message);}finally{ setBusy(false);} };
      btns.ctlAll.onclick=async()=>{ clearError(); try{ setBusy(true); const H=Math.max(1, parseInt($hours.value,10)||24); await Promise.all([loadLatest(selectedId), loadHistory(selectedId,H), loadAvg(selectedId,H)]); localStorage.setItem("clanert_hours", String(H)); const s=new URLSearchParams(location.search); s.set("hours", String(H)); history.replaceState({}, "", `${location.pathname}?${s.toString()}`);}catch(e){ showError(e.message);}finally{ setBusy(false);} };
      btns.downloadCsv.onclick=()=>downloadCSV();

      // unlock by code/name
      $btnUnlock.onclick=async()=>{
        const code = ($unlockInput.value||"").trim();
        $unlockMsg.textContent = "";
        clearError();
        if(!code){ $unlockMsg.textContent = "Enter an exact station code/name."; return; }
        try{
          setBusy(true);
          const latest = await fetchJson(buildUrl("latest", code));
          const st = { station: code, name: code, area:"—", lat:FALLBACK_STATION.lat, lng:FALLBACK_STATION.lng, visibility: PUBLIC_STATIONS.has(code) ? "public" : "private" };
          upsertStation(st);
          selectedId = code; $stationSelect.value = code; updateHeader(st); setVisibilityRibbon(code); panTo(st);
          $unlockMsg.textContent = st.visibility==="private" ? "Private station unlocked." : "Public station selected.";
          const H=Math.max(1, parseInt($hours.value,10)||24);
          await Promise.all([renderLatest(latest, st), loadHistory(code,H), loadAvg(code,H)]);
        }catch(err){
          $unlockMsg.textContent = "No data for that code. Reason: " + (err?.message||"Unknown");
          showError("Unlock failed: " + (err?.message||"Unknown error"));
        }finally{ setBusy(false); }
      };

      // initial load
      panTo(stations[0]);
      btns.ctlAll.click();
    })();
  </script>
</body>
</html>
