<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ClanertAir – Air Quality Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" />
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <style>
    :root{
      --bg-page:#f4f5fb; --bg-panel:#fff; --bg-card:#fff;
      --accent-green:#16a34a; --accent-blue:#1d4ed8; --accent-amber:#f59e0b;
      --text-main:#111827; --text-muted:#6b7280; --border-light:#e5e7eb;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",sans-serif;color:var(--text-main);background:var(--bg-page);overflow:hidden}
    #map{position:fixed;inset:0;width:100%;height:100%;z-index:0}

    /* Top bar */
    .top-nav{
      position:fixed;top:0;left:0;right:0;height:62px;padding:8px 12px;
      display:flex;align-items:center;justify-content:space-between;
      background:rgba(255,255,255,.96);box-shadow:0 10px 30px rgba(15,23,42,.12);
      backdrop-filter:blur(10px);z-index:30;
    }
    .nav-left{display:flex;align-items:center;gap:12px;min-width:0}
    .nav-logo{
      width:46px;height:46px;border-radius:16px;border:1px solid var(--border-light);
      padding:6px;background:#fff;object-fit:contain;box-shadow:0 10px 18px rgba(15,23,42,.06)
    }
    .nav-title-block{display:flex;flex-direction:column;gap:2px;min-width:0}
    .nav-title{
      font-size:1.05rem;font-weight:900;display:flex;align-items:center;gap:8px;
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;line-height:1.1
    }
    .nav-sub{font-size:.8rem;color:var(--text-muted);display:flex;align-items:center;gap:10px;min-width:0}
    .nav-toggle{
      border-radius:999px;border:1px solid var(--border-light);background:#f9fafb;
      width:44px;height:44px;display:flex;align-items:center;justify-content:center;
      cursor:pointer;font-size:1.22rem;color:var(--text-main);
      box-shadow:0 10px 20px rgba(15,23,42,.08);
      transition:transform .15s ease, background .15s ease;
    }
    .nav-toggle:hover{background:#e5e7eb;transform:translateY(-1px)}
    .nav-toggle:active{transform:translateY(0)}

    /* Side panel */
    .side-panel{
      position:fixed;top:62px;right:0;bottom:0;width:392px;max-width:100%;
      background:var(--bg-panel);box-shadow:-10px 0 30px rgba(15,23,42,.25);
      border-left:1px solid var(--border-light);
      display:flex;flex-direction:column;z-index:20;
      transform:translateX(0);transition:transform .25s ease;
    }
    .side-panel.collapsed{transform:translateX(calc(100% - 52px))}
    .panel-header{
      display:flex;align-items:center;justify-content:space-between;
      padding:10px 12px;border-bottom:1px solid var(--border-light);
      background:rgba(255,255,255,.98);backdrop-filter:blur(8px)
    }
    .panel-header-title{
      font-size:.9rem;font-weight:950;display:flex;align-items:center;gap:10px
    }
    .panel-body{flex:1;overflow-y:auto;padding:10px;background:var(--bg-page)}
    .panel-footer{
      padding:8px 10px;border-top:1px solid var(--border-light);background:#fff;
      font-size:.78rem;color:var(--text-muted);display:flex;justify-content:space-between;gap:8px;align-items:center
    }
    .status-text.ok{color:var(--accent-green)}
    .status-text.error{color:#dc2626}

    /* Mobile */
    @media (max-width:640px){
      .side-panel{width:100%}
      .side-panel.collapsed{transform:translateX(100%)}
      body.panel-open .aq-scale{
        opacity:0;visibility:hidden;pointer-events:none;transform:translateY(10px)
      }
    }

    /* Banner */
    .banner{
      background:#fff;border:1px solid var(--border-light);border-radius:18px;
      padding:10px 12px;box-shadow:0 10px 22px rgba(15,23,42,.04);
      display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:10px
    }
    .banner-left{display:flex;flex-direction:column;gap:2px;min-width:0}
    .banner-title{font-weight:950;font-size:.92rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .banner-sub{font-size:.78rem;color:var(--text-muted);display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .online-pill{
      display:inline-flex;align-items:center;gap:8px;padding:4px 10px;border-radius:999px;
      border:1px solid rgba(22,163,74,.35);background:rgba(22,163,74,.10);color:#166534;
      font-size:.74rem;font-weight:950;white-space:nowrap
    }
    .offline-pill{border-color:rgba(220,38,38,.35);background:rgba(220,38,38,.10);color:#991b1b}
    .slogan{
      font-size:.74rem;font-weight:950;color:#111827;background:rgba(29,78,216,.08);
      border:1px solid rgba(29,78,216,.18);padding:6px 12px;border-radius:999px;white-space:nowrap
    }

    /* blinking light */
    .blink-dot{
      width:9px;height:9px;border-radius:999px;display:inline-block;
      background:#16a34a;box-shadow:0 0 0 rgba(22,163,74,.55);
      animation:pulse 1.4s infinite;
    }
    .blink-dot.off{
      background:#dc2626;
      box-shadow:0 0 0 rgba(220,38,38,.45);
      animation:pulseRed 1.4s infinite;
    }
    @keyframes pulse{
      0%{box-shadow:0 0 0 0 rgba(22,163,74,.55)}
      70%{box-shadow:0 0 0 10px rgba(22,163,74,0)}
      100%{box-shadow:0 0 0 0 rgba(22,163,74,0)}
    }
    @keyframes pulseRed{
      0%{box-shadow:0 0 0 0 rgba(220,38,38,.45)}
      70%{box-shadow:0 0 0 10px rgba(220,38,38,0)}
      100%{box-shadow:0 0 0 0 rgba(220,38,38,0)}
    }

    /* Search + list */
    .station-search{
      width:100%;padding:10px 12px;border-radius:999px;border:1px solid var(--border-light);
      font-size:.82rem;margin-bottom:8px;background:#fff;color:var(--text-main)
    }
    .station-list{display:flex;flex-direction:column;gap:8px;margin-bottom:10px}
    .station-item{
      background:var(--bg-card);border-radius:16px;padding:10px 10px;border:1px solid var(--border-light);
      display:flex;justify-content:space-between;align-items:center;cursor:pointer;
      transition:.15s ease;box-shadow:0 10px 22px rgba(15,23,42,.04)
    }
    .station-item:hover{box-shadow:0 14px 28px rgba(15,23,42,.07)}
    .station-item.active{border-color:var(--accent-green);box-shadow:0 10px 22px rgba(22,163,74,.16)}
    .station-name{font-size:.9rem;font-weight:950;display:flex;align-items:center;gap:8px;line-height:1.1}
    .station-area{font-size:.78rem;color:var(--text-muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:240px}
    .station-status-pill{
      border-radius:999px;padding:4px 9px;font-size:.72rem;background:#f3f4f6;color:var(--text-muted);
      white-space:nowrap;border:1px solid var(--border-light);display:inline-flex;align-items:center;gap:6px;font-weight:900
    }
    .station-status-pill.good{background:rgba(22,163,74,.12);color:#166534;border-color:rgba(22,163,74,.35)}
    .station-status-pill.moderate{background:rgba(234,179,8,.12);color:#854d0e;border-color:rgba(234,179,8,.35)}
    .station-status-pill.unhealthy{background:rgba(249,115,22,.12);color:#9a3412;border-color:rgba(249,115,22,.35)}
    .station-status-pill.veryunhealthy{background:rgba(239,68,68,.12);color:#7f1d1d;border-color:rgba(239,68,68,.35)}
    .station-status-pill.hazardous{background:rgba(88,28,135,.12);color:#4a044e;border-color:rgba(126,34,206,.35)}

    /* Details area */
    .details-wrap{display:none}
    body.has-selection .details-wrap{display:block}
    .empty-wrap{display:block}
    body.has-selection .empty-wrap{display:none}
    .empty-card{
      background:#fff;border:1px dashed rgba(107,114,128,.35);border-radius:18px;padding:16px;
      box-shadow:0 10px 22px rgba(15,23,42,.04);color:var(--text-muted)
    }
    .empty-card h6{margin:0 0 6px;font-weight:950;color:#111827;font-size:.95rem}
    .empty-card .hint{font-size:.82rem;display:flex;gap:8px;align-items:flex-start}
    .empty-card .hint i{margin-top:1px}

    /* Cards */
    .cards-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px;margin-bottom:10px}
    .card-custom{
      background:var(--bg-card);border-radius:18px;padding:12px;border:1px solid var(--border-light);
      box-shadow:0 10px 24px rgba(15,23,42,.05)
    }
    .card-header-line{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
    .card-label{
      font-size:.72rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:.08em;
      display:flex;align-items:center;gap:8px;font-weight:900
    }
    .card-main{display:flex;align-items:baseline;gap:8px}
    .card-value{font-size:1.55rem;font-weight:950}
    .card-unit{font-size:.75rem;color:var(--text-muted)}
    .card-note{font-size:.78rem;color:var(--text-muted);margin-top:6px}
    .card-aq{background:linear-gradient(135deg,#ecfdf5,#eff6ff)}
    .card-pm25{background:linear-gradient(135deg,#ecfdf5,#dcfce7)}
    .card-pm10{background:linear-gradient(135deg,#eff6ff,#dbeafe)}
    .card-thermo{background:linear-gradient(135deg,#fff7ed,#fef3c7)}
    .card-station{background:linear-gradient(135deg,#f9fafb,#e5e7eb)}

    /* AQ pill */
    .aq-pill{padding:4px 9px;border-radius:999px;font-size:.78rem;display:inline-flex;align-items:center;gap:6px;margin-top:8px;border:1px solid transparent;font-weight:900}
    .aq-good{background:rgba(22,163,74,.12);color:#166534;border-color:rgba(22,163,74,.5)}
    .aq-moderate{background:rgba(234,179,8,.12);color:#854d0e;border-color:rgba(234,179,8,.5)}
    .aq-unhealthy{background:rgba(249,115,22,.12);color:#9a3412;border-color:rgba(249,115,22,.6)}
    .aq-veryunhealthy{background:rgba(239,68,68,.10);color:#7f1d1d;border-color:rgba(239,68,68,.6)}
    .aq-hazardous{background:rgba(88,28,135,.12);color:#4a044e;border-color:rgba(126,34,206,.7)}

    /* Activities */
    .activities{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px;margin-top:10px}
    .act{
      background:#fff;border:1px solid var(--border-light);border-radius:16px;padding:10px;
      display:flex;gap:10px;align-items:flex-start;box-shadow:0 10px 22px rgba(15,23,42,.04)
    }
    .act i{font-size:1.15rem}
    .act-title{font-weight:950;font-size:.86rem;margin:0}
    .act-sub{margin:2px 0 0;font-size:.76rem;color:var(--text-muted)}

    /* Controls */
    .controls-row{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-bottom:8px}
    .select-small,.btn-small{border-radius:999px;border:1px solid var(--border-light);padding:6px 12px;font-size:.78rem;background:#fff}
    .btn-small{
      background:var(--accent-blue);border-color:var(--accent-blue);color:#fff;display:inline-flex;align-items:center;gap:6px;
      box-shadow:0 10px 20px rgba(15,23,42,.08);transition:transform .15s ease, filter .15s ease
    }
    .btn-small:hover{filter:brightness(.95);transform:translateY(-1px)}
    .btn-small:active{transform:translateY(0)}
    .toggle-inline{display:inline-flex;align-items:center;gap:6px;font-size:.78rem;color:var(--text-muted);font-weight:800}
    .toggle-inline input{accent-color:var(--accent-green)}

    .chart-wrapper{
      position:relative;height:140px;background:#fff;border-radius:16px;border:1px solid var(--border-light);
      padding:8px;box-shadow:0 10px 24px rgba(15,23,42,.04)
    }
    .chart-caption{font-size:.78rem;color:var(--text-muted);margin-bottom:6px}

    /* AQ SCALE */
    .aq-scale{
      position:fixed;left:12px;bottom:14px;z-index:25;width:280px;max-width:calc(100vw - 24px);
      background:rgba(255,255,255,.92);border:1px solid var(--border-light);border-radius:18px;
      box-shadow:0 14px 34px rgba(15,23,42,.14);backdrop-filter:blur(10px);padding:12px 12px 10px;
      transition:opacity .18s ease, transform .18s ease, visibility .18s ease;will-change:opacity,transform
    }
    .aq-scale-title{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:8px;font-weight:950;font-size:.86rem}
    .aq-scale-title small{font-weight:900;color:var(--text-muted);font-size:.76rem}
    .aqi-bar{position:relative;height:10px;border-radius:999px;overflow:hidden;border:1px solid var(--border-light);background:#e5e7eb}
    .aqi-bar .seg{height:100%;float:left}
    .aqi-pointer{
      position:absolute;top:-7px;width:0;height:0;border-left:6px solid transparent;border-right:6px solid transparent;
      border-bottom:7px solid #111827;transform:translateX(-50%)
    }
    .aq-scale-row{display:flex;justify-content:space-between;align-items:center;margin-top:8px;gap:10px;font-size:.78rem;color:var(--text-muted)}
    .aq-scale-row strong{color:var(--text-main)}

    .leaflet-control-attribution{
      background:rgba(255,255,255,.65)!important;border-radius:10px!important;padding:2px 8px!important;margin:6px!important
    }

    /* Modals */
    .modal-content{border-radius:18px;border:1px solid var(--border-light);box-shadow:0 18px 45px rgba(15,23,42,.18)}
    .modal-header{border-bottom:1px solid var(--border-light)}
    .modal-footer{border-top:1px solid var(--border-light)}
    .small-help{font-size:.78rem;color:var(--text-muted)}
    .history-table{border:1px solid var(--border-light);border-radius:14px;overflow:hidden;background:#fff}
    .history-table thead th{font-size:.75rem;text-transform:uppercase;letter-spacing:.07em;color:var(--text-muted);background:#f9fafb;border-bottom:1px solid var(--border-light)}
    .history-table td{font-size:.82rem;color:var(--text-main)}

    /* -------- Map popup mini panel (integrated details on click) -------- */
    .station-pop{min-width:240px;max-width:280px}
    .station-pop .pop-title{font-weight:950;font-size:.95rem;line-height:1.15;margin-bottom:6px}
    .station-pop .pop-sub{font-size:.78rem;color:var(--text-muted);margin-bottom:8px}
    .station-pop .pop-row{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
    .station-pop .pop-chip{
      display:inline-flex;align-items:center;gap:6px;
      padding:6px 10px;border-radius:999px;font-size:.78rem;font-weight:950;
      border:1px solid rgba(229,231,235,.9);background:#fff;
      box-shadow:0 8px 14px rgba(15,23,42,.06)
    }
    .station-pop .pop-chip .muted{color:var(--text-muted);font-weight:900}
    .pop-chip.good{border-color:rgba(22,163,74,.35);background:rgba(22,163,74,.08);color:#166534}
    .pop-chip.moderate{border-color:rgba(234,179,8,.35);background:rgba(234,179,8,.10);color:#854d0e}
    .pop-chip.unhealthy{border-color:rgba(249,115,22,.35);background:rgba(249,115,22,.10);color:#9a3412}
    .pop-chip.veryunhealthy{border-color:rgba(239,68,68,.35);background:rgba(239,68,68,.10);color:#7f1d1d}
    .pop-chip.hazardous{border-color:rgba(126,34,206,.35);background:rgba(126,34,206,.10);color:#4a044e}
    .station-pop .pop-actions{display:flex;gap:8px;margin-top:8px}
    .pop-btn{
      border:1px solid var(--border-light);background:#111827;color:#fff;
      padding:8px 10px;border-radius:999px;font-size:.78rem;font-weight:950;
      display:inline-flex;align-items:center;gap:6px;cursor:pointer
    }
    .pop-btn.secondary{background:#16a34a;border-color:#16a34a}
  </style>
</head>

<body>
  <!-- Top navigation bar -->
  <div class="top-nav">
    <div class="nav-left">
      <img
        src="https://i.ibb.co/4wkhdY4n/Clanertsustain-new-logo.png"
        alt="Clanert logo"
        class="nav-logo"
      />
      <div class="nav-title-block">
        <div class="nav-title">
          <span>ClanertAir</span>
          <span id="dayNightIcon" class="ms-1"></span>
        </div>
        <div class="nav-sub">
          <span id="navSub">Live</span>
          <span id="aqMood"></span>
        </div>
      </div>
    </div>

    <!-- Hamburger ONLY controls panel -->
    <button id="navToggle" class="nav-toggle" aria-label="Toggle panel" title="Menu">
      <i id="navToggleIcon" class="bi bi-list"></i>
    </button>
  </div>

  <!-- Fullscreen map -->
  <div id="map"></div>

  <!-- AQ scale -->
  <div class="aq-scale" aria-label="Air quality scale">
    <div class="aq-scale-title">
      <div class="d-flex align-items-center gap-2">
        <i class="bi bi-speedometer2 text-success"></i>
        <span>Air Quality Scale</span>
      </div>
      <small id="aqScaleMini">PM2.5: -- µg/m³</small>
    </div>

    <div class="aqi-bar">
      <div class="seg" style="width:20%;background:#22c55e"></div>
      <div class="seg" style="width:20%;background:#facc15"></div>
      <div class="seg" style="width:20%;background:#fb923c"></div>
      <div class="seg" style="width:20%;background:#f87171"></div>
      <div class="seg" style="width:20%;background:#a855f7"></div>
      <div id="aqiPointer" class="aqi-pointer" style="left:0%"></div>
    </div>

    <div class="aq-scale-row">
      <span><strong id="aqScaleLabel">--</strong></span>
      <span id="aqScaleHint"><i class="bi bi-info-circle"></i> Waiting…</span>
    </div>
  </div>

  <!-- Side panel -->
  <div class="side-panel" id="sidePanel">
    <div class="panel-header">
      <div class="panel-header-title">
        <i class="bi bi-grid-1x2-fill text-primary"></i>
        <span>Stations</span>
      </div>
    </div>

    <div class="panel-body">
      <!-- Banner -->
      <div class="banner" aria-label="Station status banner">
        <div class="banner-left">
          <div class="banner-title" id="bannerStationName">No station selected</div>
          <div class="banner-sub">
            <span id="onlinePill" class="online-pill offline-pill">
              <span class="blink-dot off"></span>
              <i class="bi bi-wifi-off"></i> Offline
            </span>
            <span class="text-muted" id="bannerLastSeen">Last seen: --</span>
          </div>
        </div>
        <div class="slogan">Breathe clean air</div>
      </div>

      <!-- Search -->
      <input
        type="text"
        id="stationSearch"
        class="station-search"
        placeholder="Search public… or enter private code"
        autocomplete="off"
      />
      <div class="d-flex justify-content-between align-items-center mb-2">
        <div class="text-muted" style="font-size:.8rem;font-weight:900" id="stationCountText">Type to search</div>
        <button id="addPrivateBtn" class="btn btn-sm" style="border-radius:999px;border:1px solid var(--border-light);background:#fff;" title="Add private by code">
          <i class="bi bi-lock-fill text-secondary"></i>
        </button>
      </div>

      <!-- Station list (EMPTY until user types) -->
      <div id="stationList" class="station-list"></div>

      <!-- EMPTY STATE -->
      <div class="empty-wrap">
        <div class="empty-card">
          <h6><i class="bi bi-search me-1"></i> Search a station</h6>
          <div class="hint">
            <i class="bi bi-stars text-primary"></i>
            <div>
              Type to find <strong>public</strong> stations.<br/>
              For <strong>private</strong>, enter the code then tap <i class="bi bi-lock-fill"></i>.
            </div>
          </div>
        </div>
      </div>

      <!-- DETAILS (kept as before; removed repeating info-strip section) -->
      <div class="details-wrap">
        <div class="cards-grid">
          <div class="card-custom card-aq">
            <div class="card-header-line">
              <div class="card-label"><i class="bi bi-shield-check text-success"></i><span>Status</span></div>
            </div>
            <div class="card-main">
              <div class="card-value" id="aqStatus">--</div>
            </div>
            <div class="card-note" id="aqMessage">--</div>
            <div id="aqCategoryPill"></div>
          </div>

          <div class="card-custom card-thermo">
            <div class="card-header-line">
              <div class="card-label"><i class="bi bi-thermometer-half text-warning"></i><span>Weather</span></div>
            </div>
            <div class="card-main">
              <div class="card-value" id="temp">--</div>
              <div class="card-unit">°C</div>
            </div>
            <div class="card-note">RH: <span id="hum">--</span>%</div>
          </div>

          <div class="card-custom card-pm25">
            <div class="card-header-line">
              <div class="card-label"><i class="bi bi-dot text-success"></i><span>PM2.5</span></div>
            </div>
            <div class="card-main">
              <div class="card-value" id="pm25">--</div>
              <div class="card-unit">µg/m³</div>
            </div>
          </div>

          <div class="card-custom card-pm10">
            <div class="card-header-line">
              <div class="card-label"><i class="bi bi-circle-half text-primary"></i><span>PM10</span></div>
            </div>
            <div class="card-main">
              <div class="card-value" id="pm10">--</div>
              <div class="card-unit">µg/m³</div>
            </div>
          </div>
        </div>

        <div class="card-custom card-station mb-2">
          <div class="card-header-line">
            <div class="card-label"><i class="bi bi-geo-alt text-secondary"></i><span>Location</span></div>
            <div id="privacyBadge" class="station-status-pill"><i class="bi bi-unlock"></i> Public</div>
          </div>
          <div class="card-note" id="stationAreaText">--</div>
        </div>

        <div class="activities" id="activities"></div>

        <div class="d-flex justify-content-between align-items-center mt-3 mb-2">
          <div class="card-label m-0"><i class="bi bi-graph-up-arrow text-primary"></i><span>Trends</span></div>
          <div class="small-help">µg/m³</div>
        </div>

        <div class="controls-row">
          <select id="rangeSelect" class="select-small" title="Range">
            <option value="1">1h</option>
            <option value="6">6h</option>
            <option value="24" selected>24h</option>
          </select>

          <label class="toggle-inline" title="Show PM10">
            <input type="checkbox" id="showPm10" checked />
            PM10
          </label>

          <label class="toggle-inline" title="Auto refresh">
            <input type="checkbox" id="autoRefresh" checked />
            Auto
          </label>

          <button id="refreshBtn" class="btn-small" title="Refresh">
            <i class="bi bi-arrow-repeat"></i>
          </button>

          <button id="historyBtn" class="btn-small" style="background:#111827;border-color:#111827;" title="History (password)">
            <i class="bi bi-clock-history"></i>
          </button>

          <button id="downloadCsvBtn" class="btn-small" style="background:#16a34a;border-color:#16a34a;" title="CSV (password)">
            <i class="bi bi-download"></i>
          </button>

          <button id="clearCacheBtn" class="btn-small" style="background:#6b7280;border-color:#6b7280;" title="Clear cache">
            <i class="bi bi-trash3"></i>
          </button>
        </div>

        <div class="chart-caption" id="chartSubtitle">--</div>
        <div class="chart-wrapper">
          <canvas id="pmChart"></canvas>
        </div>

        <div class="small-help mt-2">
          <i class="bi bi-shield-lock"></i> History & CSV require password.
        </div>
      </div>
    </div>

    <div class="panel-footer">
      <div id="timestampText">
        <i class="bi bi-clock"></i>
        <span>Last update: --</span>
      </div>
      <div id="statusText" class="status-text">
        <i class="bi bi-circle text-secondary"></i>
        <span>Idle</span>
      </div>
    </div>
  </div>

  <!-- History Modal -->
  <div class="modal fade" id="historyModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <div>
            <h5 class="modal-title mb-1">Historical Data (µg/m³)</h5>
            <div class="small-help" id="historyMeta">--</div>
          </div>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body">
          <div class="history-table table-responsive">
            <table class="table table-sm mb-0">
              <thead>
                <tr>
                  <th style="min-width:180px;">Timestamp</th>
                  <th>PM2.5 (µg/m³)</th>
                  <th>PM10 (µg/m³)</th>
                </tr>
              </thead>
              <tbody id="historyTbody">
                <tr><td colspan="3" class="text-muted">Loading…</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <div class="modal-footer d-flex justify-content-between">
          <div class="small-help">Download requires password.</div>
          <button type="button" class="btn btn-success" id="modalCsvBtn">
            <i class="bi bi-download me-1"></i> Download CSV
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Password Modal -->
  <div class="modal fade" id="passwordModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Protected access</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="small-help mb-2">Enter password to view or download data.</div>
          <input id="passwordInput" type="password" class="form-control" placeholder="Password" autocomplete="off" />
          <div id="passwordError" class="text-danger mt-2" style="display:none;font-size:.85rem;">
            Wrong password. Try again.
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="passwordConfirmBtn">
            <i class="bi bi-shield-lock"></i> Confirm
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // -------------------- PLATFORM CONFIG --------------------
    const SCRIPT_URL_CLANERT =
      "https://script.google.com/macros/s/AKfycbwD21CyF2Gli6Y6hDPUyds2fzAw7mrJ0NSDrqeiG7yItbZcYL-cbKsLcbHOU7db32wN/exec";

    // Public stations are searchable. Private stations are NOT shown unless user adds by code.
    const stations = [
      {
        id: "clanert-makabe",
        stationId: "CLANERT-MAKABE-001",
        name: "ClanertAir – Mbezi Makabe",
        area: "Mbezi Makabe, Dar es Salaam",
        owner: "ClanertAir",
        lat: -6.7432882,
        lng: 39.1044879,
        dataUrl: SCRIPT_URL_CLANERT,
        aqLabel: null,
        visibility: "public" // public | private
      }
    ];

    // -------------------- PASSWORD --------------------
    // NOTE: Client-side only (visible in source). For real security, enforce on server too.
    const DOWNLOAD_PASSWORD = "Clanert360@";

    // -------------------- CACHE (localStorage) --------------------
    const CACHE_NS = "clanertair_cache_v1";
    const CACHE_TTL_LATEST_MS = 30 * 1000;
    const CACHE_TTL_HISTORY_MS = 5 * 60 * 1000;

    function cacheKey(type, stationId, extra) { return `${CACHE_NS}:${type}:${stationId}:${extra || ""}`; }
    function cacheSet(key, payload) {
      try { localStorage.setItem(key, JSON.stringify({ t: Date.now(), payload })); } catch {}
    }
    function cacheGet(key, ttlMs) {
      try {
        const raw = localStorage.getItem(key);
        if (!raw) return null;
        const v = JSON.parse(raw);
        if (!v || typeof v.t !== "number") return null;
        if (Date.now() - v.t > ttlMs) return null;
        return v.payload;
      } catch { return null; }
    }
    function cacheClearAll() {
      try {
        const keys = [];
        for (let i = 0; i < localStorage.length; i++) {
          const k = localStorage.key(i);
          if (k && k.startsWith(CACHE_NS + ":")) keys.push(k);
        }
        keys.forEach(k => localStorage.removeItem(k));
      } catch {}
    }

    // -------------------- DOM --------------------
    const sidePanel = document.getElementById("sidePanel");
    const navToggle = document.getElementById("navToggle");
    const navToggleIcon = document.getElementById("navToggleIcon");

    const navSubEl = document.getElementById("navSub");
    const stationCountTextEl = document.getElementById("stationCountText");
    const stationListEl = document.getElementById("stationList");
    const stationSearchEl = document.getElementById("stationSearch");
    const addPrivateBtn = document.getElementById("addPrivateBtn");

    const stationAreaTextEl = document.getElementById("stationAreaText");
    const privacyBadgeEl = document.getElementById("privacyBadge");

    const pm25El = document.getElementById("pm25");
    const pm10El = document.getElementById("pm10");
    const tempEl = document.getElementById("temp");
    const humEl  = document.getElementById("hum");
    const aqStatusEl = document.getElementById("aqStatus");
    const aqMessageEl = document.getElementById("aqMessage");
    const aqCategoryPillEl = document.getElementById("aqCategoryPill");

    const rangeSelect = document.getElementById("rangeSelect");
    const autoRefreshEl = document.getElementById("autoRefresh");
    const showPm10El = document.getElementById("showPm10");
    const refreshBtn = document.getElementById("refreshBtn");

    const chartSubtitleEl = document.getElementById("chartSubtitle");
    const timestampTextEl = document.getElementById("timestampText");
    const statusTextEl = document.getElementById("statusText");
    const activitiesEl = document.getElementById("activities");

    const dayNightIconEl = document.getElementById("dayNightIcon");
    const aqMoodEl = document.getElementById("aqMood");

    const aqiPointerEl = document.getElementById("aqiPointer");
    const aqScaleMiniEl = document.getElementById("aqScaleMini");
    const aqScaleLabelEl = document.getElementById("aqScaleLabel");
    const aqScaleHintEl = document.getElementById("aqScaleHint");

    const bannerStationNameEl = document.getElementById("bannerStationName");
    const onlinePillEl = document.getElementById("onlinePill");
    const bannerLastSeenEl = document.getElementById("bannerLastSeen");

    // History/CSV DOM
    const historyBtn = document.getElementById("historyBtn");
    const downloadCsvBtn = document.getElementById("downloadCsvBtn");
    const clearCacheBtn = document.getElementById("clearCacheBtn");

    const historyModalEl = document.getElementById("historyModal");
    const historyTbodyEl = document.getElementById("historyTbody");
    const historyMetaEl = document.getElementById("historyMeta");
    const modalCsvBtn = document.getElementById("modalCsvBtn");
    const historyModal = historyModalEl ? new bootstrap.Modal(historyModalEl) : null;

    // Password modal DOM
    const passwordModalEl = document.getElementById("passwordModal");
    const passwordModal = passwordModalEl ? new bootstrap.Modal(passwordModalEl) : null;
    const passwordInputEl = document.getElementById("passwordInput");
    const passwordConfirmBtn = document.getElementById("passwordConfirmBtn");
    const passwordErrorEl = document.getElementById("passwordError");

    // -------------------- MAP & STATE --------------------
    let map = null;
    let markers = {};
    let pmChart = null;
    let autoRefreshTimer = null;

    // start with NO selection
    let currentStation = null;
    let lastHistory = null;
    let pendingAction = null;

    // -------------------- DAY/NIGHT --------------------
    function updateDayNightIcon() {
      const h = new Date().getHours();
      const isDay = h >= 6 && h < 18;
      dayNightIconEl.innerHTML = isDay
        ? `<i class="bi bi-sun-fill text-warning" title="Day"></i>`
        : `<i class="bi bi-moon-stars-fill text-primary" title="Night"></i>`;
    }

    // -------------------- AQ LOGIC --------------------
    function classifyAirQuality(pm25) {
      if (pm25 == null || isNaN(pm25)) {
        return { label:"Unknown", message:"No data.", className:"aq-pill", moodIcon:`<i class="bi bi-emoji-expressionless"></i>` };
      }
      if (pm25 <= 12)   return { label:"Good", message:"Clean air.", className:"aq-pill aq-good", moodIcon:`<i class="bi bi-emoji-smile-fill text-success"></i>` };
      if (pm25 <= 35.4) return { label:"Moderate", message:"OK for most.", className:"aq-pill aq-moderate", moodIcon:`<i class="bi bi-emoji-neutral-fill text-warning"></i>` };
      if (pm25 <= 55.4) return { label:"Sensitive", message:"Limit heavy activity.", className:"aq-pill aq-unhealthy", moodIcon:`<i class="bi bi-emoji-frown-fill text-warning"></i>` };
      if (pm25 <= 150.4)return { label:"Unhealthy", message:"Reduce outdoor time.", className:"aq-pill aq-veryunhealthy", moodIcon:`<i class="bi bi-emoji-dizzy-fill text-danger"></i>` };
      if (pm25 <= 250.4)return { label:"Very Unhealthy", message:"Avoid outdoors.", className:"aq-pill aq-veryunhealthy", moodIcon:`<i class="bi bi-lungs-fill text-danger"></i>` };
      return { label:"Hazardous", message:"Stay indoors.", className:"aq-pill aq-hazardous", moodIcon:`<i class="bi bi-skull-fill" style="color:#6b21a8"></i>` };
    }

    function setAqiPointerFromPm25(pm25) {
      if (pm25 == null || isNaN(pm25)) { aqiPointerEl.style.left = "0%"; return; }
      const clamped = Math.max(0, Math.min(pm25, 250));
      aqiPointerEl.style.left = ((clamped / 250) * 100) + "%";
    }

    function getMarkerColors(label) {
      switch (label) {
        case "Good": return { color: "#16a34a", fillColor: "#22c55e" };
        case "Moderate": return { color: "#eab308", fillColor: "#facc15" };
        case "Sensitive": return { color: "#f97316", fillColor: "#fb923c" };
        case "Unhealthy": return { color: "#ef4444", fillColor: "#f87171" };
        case "Very Unhealthy": return { color: "#b91c1c", fillColor: "#f97373" };
        case "Hazardous": return { color: "#6b21a8", fillColor: "#a855f7" };
        default: return { color: "#6b7280", fillColor: "#9ca3af" };
      }
    }

    // -------------------- ACTIVITIES (short) --------------------
    function activitiesFor(label) {
      if (label === "Good") return [
        { icon:"bi-person-running", title:"Run", sub:"Best time." },
        { icon:"bi-bicycle", title:"Ride", sub:"Go longer." },
        { icon:"bi-tree", title:"Outdoor", sub:"Enjoy." },
        { icon:"bi-wind", title:"Ventilate", sub:"Fresh air." },
      ];
      if (label === "Moderate") return [
        { icon:"bi-person-walking", title:"Walk", sub:"Easy pace." },
        { icon:"bi-bicycle", title:"Ride", sub:"Short." },
        { icon:"bi-heart-pulse", title:"Workout", sub:"Medium." },
        { icon:"bi-wind", title:"Ventilate", sub:"Low traffic." },
      ];
      if (label === "Sensitive") return [
        { icon:"bi-house-door", title:"Indoor", sub:"Safer." },
        { icon:"bi-mask", title:"Mask", sub:"If outside." },
        { icon:"bi-person-walking", title:"Short walk", sub:"Light." },
        { icon:"bi-fan", title:"Ventilate", sub:"Brief." },
      ];
      if (label === "Unhealthy" || label === "Very Unhealthy") return [
        { icon:"bi-house-lock", title:"Indoors", sub:"Avoid outdoor." },
        { icon:"bi-shield-check", title:"Close", sub:"Reduce dust." },
        { icon:"bi-heart-pulse", title:"Light", sub:"Low effort." },
        { icon:"bi-mask", title:"Mask", sub:"If needed." },
      ];
      if (label === "Hazardous") return [
        { icon:"bi-house-lock-fill", title:"Stay in", sub:"High risk." },
        { icon:"bi-shield-fill-check", title:"Seal", sub:"Cleaner." },
        { icon:"bi-x-octagon", title:"No outdoor", sub:"Avoid." },
        { icon:"bi-telephone", title:"Care", sub:"If symptoms." },
      ];
      return [
        { icon:"bi-question-circle", title:"No data", sub:"Wait." },
        { icon:"bi-arrow-repeat", title:"Refresh", sub:"Try again." }
      ];
    }

    function renderActivities(label) {
      const acts = activitiesFor(label);
      activitiesEl.innerHTML = acts.map(a => `
        <div class="act">
          <i class="bi ${a.icon} text-primary"></i>
          <div>
            <p class="act-title">${a.title}</p>
            <p class="act-sub">${a.sub}</p>
          </div>
        </div>
      `).join("");
    }

    // -------------------- API CALLS (WITH CACHE) --------------------
    async function fetchLatest(station) {
      const key = cacheKey("latest", station.stationId, "");
      const cached = cacheGet(key, CACHE_TTL_LATEST_MS);
      if (cached) return cached;

      const url = station.dataUrl + "?mode=latest&station=" + encodeURIComponent(station.stationId);
      const res = await fetch(url, { cache: "no-store" });
      const text = await res.text();
      let data;
      try { data = JSON.parse(text); } catch { throw new Error("Server did not return JSON."); }
      if (data.error === "no_data") throw new Error("No data available yet.");

      cacheSet(key, data);
      return data;
    }

    async function fetchHistory(station, hours) {
      const key = cacheKey("history", station.stationId, String(hours));
      const cached = cacheGet(key, CACHE_TTL_HISTORY_MS);
      if (cached) return cached;

      const url = station.dataUrl
        + "?mode=history&station=" + encodeURIComponent(station.stationId)
        + "&hours=" + encodeURIComponent(hours);

      const res = await fetch(url, { cache: "no-store" });
      const text = await res.text();
      let data;
      try { data = JSON.parse(text); } catch { throw new Error("History response not JSON."); }

      cacheSet(key, data);
      return data;
    }

    // -------------------- UI HELPERS --------------------
    function formatTimestampFull(ts) {
      if (!ts) return "--";
      const d = new Date(ts);
      if (isNaN(d.getTime())) return String(ts);
      return d.toLocaleString();
    }
    function formatTimestampShort(ts) {
      const d = new Date(ts);
      if (isNaN(d.getTime())) return "";
      return d.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
    }
    function isStationOnline(ts) {
      const d = new Date(ts);
      if (isNaN(d.getTime())) return false;
      const diff = Date.now() - d.getTime();
      return diff >= 0 && diff <= (10 * 60 * 1000);
    }

    function setSelectionUI(selected) {
      document.body.classList.toggle("has-selection", !!selected);
      if (!selected) {
        bannerStationNameEl.textContent = "No station selected";
        bannerLastSeenEl.textContent = "Last seen: --";
        onlinePillEl.className = "online-pill offline-pill";
        onlinePillEl.innerHTML = `<span class="blink-dot off"></span> <i class="bi bi-wifi-off"></i> Offline`;
        timestampTextEl.innerHTML = `<i class="bi bi-clock"></i> <span>Last update: --</span>`;
        aqMoodEl.innerHTML = "";
        aqScaleMiniEl.textContent = "PM2.5: -- µg/m³";
        aqScaleLabelEl.textContent = "--";
        aqScaleHintEl.innerHTML = `<i class="bi bi-info-circle"></i> Waiting…`;
        setAqiPointerFromPm25(null);
      }
    }

    // -------- Map popup (integrated repeating section) --------
    function pillClassForAQ(label) {
      const s = (label || "").toLowerCase();
      if (s.includes("good")) return "good";
      if (s.includes("moderate")) return "moderate";
      if (s.includes("sensitive")) return "unhealthy";
      if (s.includes("very")) return "veryunhealthy";
      if (s.includes("hazard")) return "hazardous";
      if (s.includes("unhealthy")) return "unhealthy";
      return "";
    }

    function buildPopupHTML(station, latest, aqInfo) {
      const pm25 = parseFloat(latest.pm25);
      const pm10 = parseFloat(latest.pm10);
      const temp = parseFloat(latest.temperature);
      const hum  = parseFloat(latest.humidity);

      const priv = station.visibility === "private"
        ? `<span class="pop-chip"><i class="bi bi-lock-fill"></i> <span class="muted">Private</span></span>`
        : `<span class="pop-chip"><i class="bi bi-unlock"></i> <span class="muted">Public</span></span>`;

      const owner = station.owner ? `<span class="pop-chip"><i class="bi bi-person-badge"></i> <span class="muted">${station.owner}</span></span>` : "";

      const aqPill = `<span class="pop-chip ${pillClassForAQ(aqInfo.label)}"><i class="bi bi-activity"></i> ${aqInfo.label}</span>`;

      const p25 = isNaN(pm25) ? "--" : pm25.toFixed(1);
      const p10 = isNaN(pm10) ? "--" : pm10.toFixed(1);
      const t = isNaN(temp) ? "--" : temp.toFixed(1);
      const h = isNaN(hum) ? "--" : hum.toFixed(0);

      return `
        <div class="station-pop">
          <div class="pop-title">${station.name}</div>
          <div class="pop-sub"><i class="bi bi-geo-alt"></i> ${station.area || station.stationId}</div>

          <div class="pop-row">
            ${aqPill}
            ${priv}
            ${owner}
          </div>

          <div class="pop-row">
            <span class="pop-chip"><i class="bi bi-dot"></i> PM2.5: <span class="muted">${p25} µg/m³</span></span>
            <span class="pop-chip"><i class="bi bi-circle-half"></i> PM10: <span class="muted">${p10} µg/m³</span></span>
          </div>

          <div class="pop-row">
            <span class="pop-chip"><i class="bi bi-thermometer-half"></i> ${t} °C</span>
            <span class="pop-chip"><i class="bi bi-droplet"></i> ${h} %</span>
          </div>

          <div class="pop-sub"><i class="bi bi-clock"></i> ${formatTimestampFull(latest.timestamp)}</div>

          <div class="pop-actions">
            <button class="pop-btn" onclick="window.__openHistoryFromPopup()">
              <i class="bi bi-clock-history"></i> History
            </button>
            <button class="pop-btn secondary" onclick="window.__downloadCsvFromPopup()">
              <i class="bi bi-download"></i> CSV
            </button>
          </div>
        </div>
      `;
    }

    // -------------------- UPDATE UI FROM DATA --------------------
    function updateMarkerForStation(station, latest, aqInfo) {
      const marker = markers[station.id];
      if (!marker) return;

      const colors = getMarkerColors(aqInfo.label);
      marker.setStyle({ color: colors.color, fillColor: colors.fillColor });

      // bind integrated popup (replaces repeating section)
      marker.bindPopup(buildPopupHTML(station, latest, aqInfo), { closeButton: true, autoPan: true });
    }

    function updateCardsFromLatest(station, latest) {
      const pm25 = parseFloat(latest.pm25);
      const pm10 = parseFloat(latest.pm10);
      const temp = parseFloat(latest.temperature);
      const hum  = parseFloat(latest.humidity);

      pm25El.textContent = isNaN(pm25) ? "--" : pm25.toFixed(1);
      pm10El.textContent = isNaN(pm10) ? "--" : pm10.toFixed(1);
      tempEl.textContent = isNaN(temp) ? "--" : temp.toFixed(1);
      humEl.textContent  = isNaN(hum)  ? "--" : hum.toFixed(0);

      const aqInfo = classifyAirQuality(pm25);
      station.aqLabel = aqInfo.label;

      // mood + overlay
      aqMoodEl.innerHTML = aqInfo.moodIcon;
      aqScaleMiniEl.textContent = "PM2.5: " + (isNaN(pm25) ? "--" : pm25.toFixed(1)) + " µg/m³";
      aqScaleLabelEl.textContent = aqInfo.label;
      aqScaleHintEl.innerHTML = `<i class="bi bi-info-circle"></i> ${aqInfo.message}`;
      setAqiPointerFromPm25(pm25);

      // Banner
      bannerStationNameEl.textContent = station.name;
      const lastSeen = formatTimestampFull(latest.timestamp);
      bannerLastSeenEl.textContent = "Last seen: " + lastSeen;

      const online = isStationOnline(latest.timestamp);

      onlinePillEl.className = "online-pill" + (online ? "" : " offline-pill");
      onlinePillEl.innerHTML = online
        ? `<span class="blink-dot"></span> <i class="bi bi-wifi"></i> Online`
        : `<span class="blink-dot off"></span> <i class="bi bi-wifi-off"></i> Offline`;

      // Privacy badge
      if (station.visibility === "private") {
        privacyBadgeEl.className = "station-status-pill";
        privacyBadgeEl.innerHTML = `<i class="bi bi-lock-fill"></i> Private`;
      } else {
        privacyBadgeEl.className = "station-status-pill";
        privacyBadgeEl.innerHTML = `<i class="bi bi-unlock"></i> Public`;
      }

      // Cards
      aqStatusEl.textContent = aqInfo.label;
      aqMessageEl.textContent = aqInfo.message;
      aqCategoryPillEl.innerHTML =
        `<span class="${aqInfo.className}">
          <i class="bi bi-circle-fill"></i> ${aqInfo.label}
        </span>`;

      renderActivities(aqInfo.label);

      timestampTextEl.innerHTML =
        `<i class="bi bi-clock"></i> <span>Last update: ${lastSeen}</span>`;

      stationAreaTextEl.textContent = station.area || "--";

      // Map popup integration
      updateMarkerForStation(station, latest, aqInfo);
    }

    function computeNiceMax(values) {
      const nums = values.filter(v => typeof v === "number" && !isNaN(v));
      if (!nums.length) return 50;
      const max = Math.max(...nums);
      const base = Math.max(max, 5);
      const raw = base + base * 0.15;
      const step = raw <= 50 ? 5 : raw <= 100 ? 10 : raw <= 200 ? 20 : 50;
      return Math.ceil(raw / step) * step;
    }

    function updateChartFromHistory(history) {
      lastHistory = history;

      let points = history.points || [];
      const hours = history.hours;

      points = points.filter(p => {
        const ts = new Date(p.timestamp);
        const pm25 = parseFloat(p.pm25);
        const pm10 = parseFloat(p.pm10);
        return !isNaN(ts.getTime()) && (!isNaN(pm25) || !isNaN(pm10));
      });

      points.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

      chartSubtitleEl.textContent = points.length ? `${points.length} pts · ${hours}h` : "No data.";

      const labels = points.map(p => formatTimestampShort(p.timestamp));
      const pm25Data = points.map(p => {
        const v = parseFloat(p.pm25);
        return isNaN(v) ? null : v;
      });
      const pm10Data = points.map(p => {
        const v = parseFloat(p.pm10);
        return isNaN(v) ? null : v;
      });

      const combined = [...pm25Data, ...(showPm10El.checked ? pm10Data : [])].filter(v => v != null);
      const niceMax = computeNiceMax(combined);

      const ctx = document.getElementById("pmChart").getContext("2d");
      if (pmChart) pmChart.destroy();

      pmChart = new Chart(ctx, {
        type: "line",
        data: {
          labels,
          datasets: [
            {
              label: "PM2.5 (µg/m³)",
              data: pm25Data,
              borderWidth: 2,
              tension: 0.25,
              pointRadius: 0,
              borderColor: "#16a34a",
              backgroundColor: "rgba(22,163,74,0.12)"
            },
            {
              label: "PM10 (µg/m³)",
              data: pm10Data,
              borderWidth: 1.6,
              tension: 0.25,
              pointRadius: 0,
              borderColor: "#1d4ed8",
              backgroundColor: "rgba(37,99,235,0.08)",
              borderDash: [4, 3],
              hidden: !showPm10El.checked
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: "index", intersect: false },
          plugins: {
            legend: { labels: { color: "#111827", font: { size: 10 } } },
            tooltip: {
              callbacks: {
                title: (items) => {
                  const idx = items[0].dataIndex;
                  const p = points[idx];
                  return p ? formatTimestampFull(p.timestamp) : "";
                }
              }
            }
          },
          scales: {
            x: { ticks: { color: "#6b7280", maxTicksLimit: 7 }, grid: { color: "#e5e7eb" } },
            y: {
              ticks: { color: "#6b7280" },
              grid: { color: "#e5e7eb" },
              suggestedMin: 0,
              suggestedMax: niceMax,
              title: { display: true, text: "µg/m³" }
            }
          }
        }
      });
    }

    // -------------------- STATIONS: SEARCH + PRIVATE CODE ADD --------------------
    function normalize(s) { return (s || "").trim().toLowerCase(); }

    function renderStationList(filterText) {
      const q = normalize(filterText);

      if (!q) {
        stationCountTextEl.textContent = "Type to search";
        stationListEl.innerHTML = "";
        navSubEl.textContent = "Live";
        return;
      }

      const visible = stations.filter(s => {
        const hay = `${s.name} ${s.area} ${s.stationId}`.toLowerCase();
        return hay.includes(q);
      });

      stationCountTextEl.textContent = visible.length ? `${visible.length} found` : "No match";
      navSubEl.textContent = "Live · " + (currentStation ? "1 selected" : "none");

      stationListEl.innerHTML = "";
      visible.forEach(st => {
        const div = document.createElement("div");
        div.className = "station-item" + (currentStation && st.id === currentStation.id ? " active" : "");

        const left = document.createElement("div");
        left.innerHTML = `
          <div class="station-name">
            <i class="bi ${st.visibility === "private" ? "bi-lock-fill text-secondary" : "bi-broadcast-pin text-primary"}"></i>
            ${st.name}
          </div>
          <div class="station-area">${st.area || st.stationId}</div>
        `;

        const status = document.createElement("div");
        status.className = "station-status-pill";

        if (st.aqLabel) {
          const labelLower = st.aqLabel.toLowerCase();
          if (labelLower.includes("good")) status.classList.add("good");
          else if (labelLower.includes("moderate")) status.classList.add("moderate");
          else if (labelLower.includes("sensitive")) status.classList.add("unhealthy");
          else if (labelLower.includes("very")) status.classList.add("veryunhealthy");
          else if (labelLower.includes("hazardous")) status.classList.add("hazardous");
          else if (labelLower.includes("unhealthy")) status.classList.add("unhealthy");
          status.innerHTML = `${st.visibility === "private" ? `<i class="bi bi-lock-fill"></i>` : `<i class="bi bi-unlock"></i>`} ${st.aqLabel}`;
        } else {
          status.innerHTML = `${st.visibility === "private" ? `<i class="bi bi-lock-fill"></i>` : `<i class="bi bi-unlock"></i>`} --`;
        }

        div.appendChild(left);
        div.appendChild(status);
        div.addEventListener("click", () => selectStationById(st.id));
        stationListEl.appendChild(div);
      });

      if (visible.length === 0) {
        const empty = document.createElement("div");
        empty.className = "text-muted";
        empty.style.fontSize = ".82rem";
        empty.innerHTML = `<i class="bi bi-info-circle"></i> Not found. For private, enter code then tap the lock.`;
        stationListEl.appendChild(empty);
      }
    }

    function addPrivateStationFromCode(code) {
      const stationId = (code || "").trim();
      if (!stationId) return;

      const exists = stations.find(s => s.stationId === stationId);
      if (exists) {
        selectStationById(exists.id);
        return;
      }

      const st = {
        id: "private-" + stationId.replace(/[^a-z0-9]+/gi, "-").toLowerCase() + "-" + Math.random().toString(16).slice(2,6),
        stationId,
        name: "Private – " + stationId,
        area: stationId,
        owner: "Private owner",
        lat: -6.7924,
        lng: 39.2083,
        dataUrl: SCRIPT_URL_CLANERT,
        aqLabel: null,
        visibility: "private"
      };
      stations.push(st);

      if (map) {
        const circle = L.circleMarker([st.lat, st.lng], {
          radius: 10, color: "#6b7280", weight: 2, fillColor: "#9ca3af", fillOpacity: 0.9
        }).addTo(map);
        circle.bindPopup(st.name);
        circle.on("click", () => selectStationById(st.id));
        markers[st.id] = circle;
      }

      selectStationById(st.id);
    }

    function selectStationById(stationId) {
      const station = stations.find(s => s.id === stationId);
      if (!station) return;
      currentStation = station;

      setSelectionUI(true);
      centerMapOnStation(station);
      refreshAllForCurrentStation();
      renderStationList(stationSearchEl.value);
      setupAutoRefresh();

      // open popup on select (after refresh binds the popup)
      setTimeout(() => {
        const m = markers[station.id];
        if (m) m.openPopup();
      }, 450);
    }

    // -------------------- MAP INIT --------------------
    function initMap() {
      map = L.map("map", { zoomControl: false }).setView([-6.7924, 39.2083], 12);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: "&copy; OpenStreetMap contributors"
      }).addTo(map);

      stations.forEach(st => {
        if (!st.lat || !st.lng) return;
        const circle = L.circleMarker([st.lat, st.lng], {
          radius: 10, color: "#6b7280", weight: 2, fillColor: "#9ca3af", fillOpacity: 0.9
        }).addTo(map);

        circle.on("click", () => selectStationById(st.id));
        markers[st.id] = circle;
      });
    }

    function centerMapOnStation(station) {
      if (!map || !station || station.lat == null || station.lng == null) return;
      map.setView([station.lat, station.lng], 13);
    }

    // -------------------- REFRESH --------------------
    async function refreshAllForCurrentStation() {
      if (!currentStation) return;

      const station = currentStation;
      const hours = parseInt(rangeSelect.value, 10) || 1;

      statusTextEl.innerHTML = `<span class="text-muted"><i class="bi bi-arrow-repeat"></i> Updating…</span>`;
      statusTextEl.className = "status-text";

      try {
        const [latest, history] = await Promise.all([
          fetchLatest(station),
          fetchHistory(station, hours)
        ]);

        updateCardsFromLatest(station, latest);
        updateChartFromHistory(history);

        // open popup with integrated info
        const m = markers[station.id];
        if (m) m.openPopup();

        statusTextEl.innerHTML = `<span class="text-success"><i class="bi bi-check-circle"></i> OK</span>`;
        statusTextEl.className = "status-text ok";
      } catch (err) {
        console.error(err);
        statusTextEl.innerHTML = `<span class="text-danger"><i class="bi bi-exclamation-circle"></i> Error</span>`;
        statusTextEl.className = "status-text error";

        onlinePillEl.className = "online-pill offline-pill";
        onlinePillEl.innerHTML = `<span class="blink-dot off"></span> <i class="bi bi-wifi-off"></i> Offline`;
      }
    }

    function setupAutoRefresh() {
      if (autoRefreshTimer) clearInterval(autoRefreshTimer);
      autoRefreshTimer = null;

      if (autoRefreshEl.checked && currentStation) {
        autoRefreshTimer = setInterval(refreshAllForCurrentStation, 60000);
      }
    }

    // -------------------- PANEL TOGGLE + AQ SCALE HIDE ON MOBILE --------------------
    function setMobileAqScaleVisibility(panelCollapsed) {
      if (window.matchMedia("(max-width: 640px)").matches) {
        document.body.classList.toggle("panel-open", !panelCollapsed);
      } else {
        document.body.classList.remove("panel-open");
      }
    }

    function togglePanel() {
      const collapsed = sidePanel.classList.toggle("collapsed");
      setMobileAqScaleVisibility(collapsed);
      navToggleIcon.className = collapsed ? "bi bi-list" : "bi bi-x-lg";
      if (map) setTimeout(() => map.invalidateSize(), 250);
    }

    navToggle.addEventListener("click", togglePanel);

    // -------------------- PASSWORD GATE --------------------
    function showPassword(action) {
      pendingAction = action;
      passwordErrorEl.style.display = "none";
      passwordInputEl.value = "";
      passwordModal.show();
      setTimeout(() => passwordInputEl.focus(), 150);
    }

    passwordConfirmBtn.addEventListener("click", async () => {
      const entered = passwordInputEl.value || "";
      if (entered !== DOWNLOAD_PASSWORD) {
        passwordErrorEl.style.display = "block";
        return;
      }
      passwordErrorEl.style.display = "none";
      passwordModal.hide();

      try {
        if (pendingAction === "view_history") await openHistoryModal();
        if (pendingAction === "download_csv") await doCsvDownload();
      } catch (e) {
        console.error(e);
        alert("Action failed. Please try again.");
      } finally {
        pendingAction = null;
      }
    });

    passwordInputEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter") passwordConfirmBtn.click();
    });

    // -------------------- HISTORY VIEW --------------------
    async function openHistoryModal() {
      if (!historyModal || !currentStation) return;

      historyTbodyEl.innerHTML = `<tr><td colspan="3" class="text-muted">Loading…</td></tr>`;
      const hours = parseInt(rangeSelect.value, 10) || 1;
      historyMetaEl.textContent = `${currentStation.name} · ${hours}h`;

      if (!lastHistory || String(lastHistory.hours) !== String(hours)) {
        lastHistory = await fetchHistory(currentStation, hours);
      }

      const pts = (lastHistory.points || [])
        .filter(p => p && p.timestamp)
        .sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));

      const limited = pts.slice(0, 300);
      historyMetaEl.textContent = `${currentStation.name} · ${hours}h · ${limited.length}/${pts.length}`;

      if (!limited.length) {
        historyTbodyEl.innerHTML = `<tr><td colspan="3" class="text-muted">No data.</td></tr>`;
      } else {
        historyTbodyEl.innerHTML = limited.map(p => `
          <tr>
            <td>${formatTimestampFull(p.timestamp)}</td>
            <td>${safeNum(p.pm25, 1) || "<span class='text-muted'>--</span>"}</td>
            <td>${safeNum(p.pm10, 1) || "<span class='text-muted'>--</span>"}</td>
          </tr>
        `).join("");
      }

      historyModal.show();
    }

    // -------------------- CSV DOWNLOAD --------------------
    function safeNum(v, digits = 1) {
      const n = parseFloat(v);
      return isNaN(n) ? "" : n.toFixed(digits);
    }

    function toCsv(points) {
      const header = ["timestamp","pm25_ugm3","pm10_ugm3"];
      const rows = (points || []).map(p => {
        const ts = p.timestamp ?? "";
        const pm25 = safeNum(p.pm25, 1);
        const pm10 = safeNum(p.pm10, 1);
        return [`"${String(ts).replace(/"/g,'""')}"`, pm25, pm10].join(",");
      });
      return [header.join(","), ...rows].join("\n");
    }

    function downloadTextFile(filename, text) {
      const blob = new Blob([text], { type: "text/csv;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function formatCsvFilename() {
      const hours = parseInt(rangeSelect.value, 10) || 1;
      const safeStation = (currentStation.stationId || "station").replace(/[^a-z0-9-_]+/gi, "_");
      const stamp = new Date().toISOString().replace(/[:.]/g, "-");
      return `${safeStation}_history_${hours}h_${stamp}.csv`;
    }

    async function doCsvDownload() {
      if (!currentStation) return;
      const hours = parseInt(rangeSelect.value, 10) || 1;
      if (!lastHistory || String(lastHistory.hours) !== String(hours)) {
        lastHistory = await fetchHistory(currentStation, hours);
      }
      downloadTextFile(formatCsvFilename(), toCsv(lastHistory.points || []));
    }

    // Expose popup buttons (Leaflet popup uses inline onclick)
    window.__openHistoryFromPopup = () => showPassword("view_history");
    window.__downloadCsvFromPopup = () => showPassword("download_csv");

    // -------------------- EVENTS --------------------
    refreshBtn.addEventListener("click", () => refreshAllForCurrentStation());

    rangeSelect.addEventListener("change", () => {
      lastHistory = null;
      refreshAllForCurrentStation();
    });

    autoRefreshEl.addEventListener("change", setupAutoRefresh);

    showPm10El.addEventListener("change", () => {
      if (pmChart) {
        pmChart.data.datasets[1].hidden = !showPm10El.checked;
        pmChart.update();
      }
      refreshAllForCurrentStation();
    });

    historyBtn.addEventListener("click", () => showPassword("view_history"));
    downloadCsvBtn.addEventListener("click", () => showPassword("download_csv"));
    modalCsvBtn.addEventListener("click", () => showPassword("download_csv"));

    clearCacheBtn.addEventListener("click", () => {
      cacheClearAll();
      lastHistory = null;
      statusTextEl.innerHTML = `<span class="text-success"><i class="bi bi-check-circle"></i> Cache cleared</span>`;
      statusTextEl.className = "status-text ok";
      setTimeout(() => {
        statusTextEl.innerHTML = `<span class="text-muted"><i class="bi bi-circle"></i> Idle</span>`;
        statusTextEl.className = "status-text";
      }, 1500);
    });

    stationSearchEl.addEventListener("input", () => renderStationList(stationSearchEl.value));

    addPrivateBtn.addEventListener("click", async () => {
      const code = (stationSearchEl.value || "").trim();
      if (!code) return;
      addPrivateStationFromCode(code);
      await refreshAllForCurrentStation();
      setupAutoRefresh();
    });

    window.addEventListener("resize", () => {
      if (map) setTimeout(() => map.invalidateSize(), 200);
      setMobileAqScaleVisibility(sidePanel.classList.contains("collapsed"));
    });

    // -------------------- BOOT --------------------
    window.addEventListener("load", () => {
      updateDayNightIcon();
      setInterval(updateDayNightIcon, 30000);

      initMap();

      setSelectionUI(false);
      renderStationList("");

      const collapsed = sidePanel.classList.contains("collapsed");
      setMobileAqScaleVisibility(collapsed);
      navToggleIcon.className = collapsed ? "bi bi-list" : "bi bi-x-lg";
    });
  </script>
</body>
</html>
