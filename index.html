<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ClanertAir – Air Quality Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" />
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <style>
    :root {
      --bg-page: #f4f5fb;
      --bg-panel: #ffffff;
      --bg-card: #ffffff;
      --accent-green: #16a34a;
      --accent-blue: #1d4ed8;
      --accent-amber: #f59e0b;
      --text-main: #111827;
      --text-muted: #6b7280;
      --border-light: #e5e7eb;
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
      color: var(--text-main);
      background: var(--bg-page);
      overflow: hidden;
    }

    #map {
      position: fixed;
      inset: 0;
      width: 100%;
      height: 100%;
      z-index: 0;
    }

    /* Top bar */
    .top-nav {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 62px;
      padding: 8px 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: rgba(255, 255, 255, 0.96);
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.12);
      backdrop-filter: blur(10px);
      z-index: 30;
    }

    .nav-left {
      display: flex;
      align-items: center;
      gap: 12px;
      min-width: 0;
    }

    .nav-logo {
      width: 46px;             /* INCREASED LOGO */
      height: 46px;
      border-radius: 16px;
      border: 1px solid var(--border-light);
      padding: 6px;
      background: #fff;
      object-fit: contain;
      box-shadow: 0 10px 18px rgba(15, 23, 42, 0.06);
    }

    .nav-title-block {
      display: flex;
      flex-direction: column;
      gap: 2px;
      min-width: 0;
    }

    .nav-title {
      font-size: 1.05rem;
      font-weight: 800;
      display: flex;
      align-items: center;
      gap: 8px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      line-height: 1.1;
    }

    .nav-sub {
      font-size: 0.8rem;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 10px;
      min-width: 0;
    }

    .nav-toggle {
      border-radius: 999px;
      border: 1px solid var(--border-light);
      background: #f9fafb;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 1.2rem;
      color: var(--text-main);
      box-shadow: 0 8px 16px rgba(15, 23, 42, 0.06);
    }
    .nav-toggle:hover { background: #e5e7eb; }

    /* Side panel */
    .side-panel {
      position: fixed;
      top: 62px;
      right: 0;
      bottom: 0;
      width: 392px;
      max-width: 100%;
      background: var(--bg-panel);
      box-shadow: -10px 0 30px rgba(15, 23, 42, 0.25);
      border-left: 1px solid var(--border-light);
      display: flex;
      flex-direction: column;
      z-index: 20;
      transform: translateX(0);
      transition: transform 0.25s ease;
    }
    .side-panel.collapsed { transform: translateX(calc(100% - 48px)); }

    .panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 10px;
      border-bottom: 1px solid var(--border-light);
      background: rgba(255, 255, 255, 0.98);
      backdrop-filter: blur(8px);
    }

    .panel-header-title {
      font-size: 0.9rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .panel-toggle {
      border: 1px solid var(--border-light);
      background: #f9fafb;
      border-radius: 999px;
      width: 30px;
      height: 26px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 0.9rem;
      color: var(--text-muted);
    }
    .panel-toggle:hover { background: #e5e7eb; }

    .panel-body {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
      background: var(--bg-page);
    }

    .panel-section-title {
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
      margin: 10px 0 6px;
    }

    /* Station list */
    .station-search {
      width: 100%;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid var(--border-light);
      font-size: 0.8rem;
      margin-bottom: 8px;
      background: #fff;
      color: var(--text-main);
    }

    .station-list { display: flex; flex-direction: column; gap: 8px; margin-bottom: 10px; }

    .station-item {
      background: var(--bg-card);
      border-radius: 14px;
      padding: 10px 10px;
      border: 1px solid var(--border-light);
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      transition: 0.15s ease;
      box-shadow: 0 10px 22px rgba(15, 23, 42, 0.04);
    }
    .station-item:hover { box-shadow: 0 14px 28px rgba(15, 23, 42, 0.07); }
    .station-item.active {
      border-color: var(--accent-green);
      box-shadow: 0 10px 22px rgba(22, 163, 74, 0.16);
    }

    .station-name { font-size: 0.9rem; font-weight: 800; display: flex; align-items: center; gap: 8px; }
    .station-area { font-size: 0.78rem; color: var(--text-muted); }

    .station-status-pill {
      border-radius: 999px;
      padding: 4px 9px;
      font-size: 0.72rem;
      background: #f3f4f6;
      color: var(--text-muted);
      white-space: nowrap;
      border: 1px solid var(--border-light);
    }
    .station-status-pill.good { background: rgba(22,163,74,.12); color:#166534; border-color: rgba(22,163,74,.35); }
    .station-status-pill.moderate { background: rgba(234,179,8,.12); color:#854d0e; border-color: rgba(234,179,8,.35); }
    .station-status-pill.unhealthy { background: rgba(249,115,22,.12); color:#9a3412; border-color: rgba(249,115,22,.35); }
    .station-status-pill.veryunhealthy { background: rgba(239,68,68,.12); color:#7f1d1d; border-color: rgba(239,68,68,.35); }
    .station-status-pill.hazardous { background: rgba(88,28,135,.12); color:#4a044e; border-color: rgba(126,34,206,.35); }

    /* Cards */
    .cards-grid { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 10px; margin-bottom: 10px; }

    .card-custom {
      background: var(--bg-card);
      border-radius: 18px;
      padding: 12px;
      border: 1px solid var(--border-light);
      box-shadow: 0 10px 24px rgba(15, 23, 42, 0.05);
    }

    .card-header-line { display:flex; align-items:center; justify-content:space-between; margin-bottom:6px; }

    .card-label {
      font-size: 0.75rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .card-main { display:flex; align-items:baseline; gap:8px; }
    .card-value { font-size: 1.55rem; font-weight: 900; }
    .card-unit { font-size: 0.75rem; color: var(--text-muted); }
    .card-note { font-size: 0.8rem; color: var(--text-muted); margin-top: 6px; }

    .card-aq { background: linear-gradient(135deg, #ecfdf5, #eff6ff); }
    .card-pm25 { background: linear-gradient(135deg, #ecfdf5, #dcfce7); }
    .card-pm10 { background: linear-gradient(135deg, #eff6ff, #dbeafe); }
    .card-thermo { background: linear-gradient(135deg, #fff7ed, #fef3c7); }
    .card-station { background: linear-gradient(135deg, #f9fafb, #e5e7eb); }

    /* AQ pill */
    .aq-pill {
      padding: 4px 9px;
      border-radius: 999px;
      font-size: 0.78rem;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      margin-top: 8px;
      border: 1px solid transparent;
    }
    .aq-good { background: rgba(22,163,74,.12); color:#166534; border-color: rgba(22,163,74,.5); }
    .aq-moderate { background: rgba(234,179,8,.12); color:#854d0e; border-color: rgba(234,179,8,.5); }
    .aq-unhealthy { background: rgba(249,115,22,.12); color:#9a3412; border-color: rgba(249,115,22,.6); }
    .aq-veryunhealthy { background: rgba(239,68,68,.10); color:#7f1d1d; border-color: rgba(239,68,68,.6); }
    .aq-hazardous { background: rgba(88,28,135,.12); color:#4a044e; border-color: rgba(126,34,206,.7); }

    /* Activities */
    .activities { display:grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 8px; margin-top: 10px; }
    .act {
      background:#fff;
      border:1px solid var(--border-light);
      border-radius:16px;
      padding:10px;
      display:flex;
      gap:10px;
      align-items:flex-start;
      box-shadow: 0 10px 22px rgba(15, 23, 42, 0.04);
    }
    .act i { font-size: 1.15rem; }
    .act-title { font-weight: 900; font-size: 0.86rem; margin:0; }
    .act-sub { margin:2px 0 0; font-size: 0.78rem; color: var(--text-muted); }

    /* Chart controls + chart */
    .controls-row { display:flex; flex-wrap:wrap; gap:8px; align-items:center; margin-bottom: 8px; }
    .select-small, .btn-small {
      border-radius: 999px;
      border: 1px solid var(--border-light);
      padding: 6px 12px;
      font-size: 0.78rem;
      background: #fff;
    }
    .btn-small {
      background: var(--accent-blue);
      border-color: var(--accent-blue);
      color: #fff;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .btn-small:hover { background: #1e40af; }
    .toggle-inline { display:inline-flex; align-items:center; gap:6px; font-size: 0.78rem; color: var(--text-muted); }
    .toggle-inline input { accent-color: var(--accent-green); }

    /* SHORTER chart */
    .chart-wrapper {
      position: relative;
      height: 140px; /* shorter */
      background: #fff;
      border-radius: 16px;
      border: 1px solid var(--border-light);
      padding: 8px;
      box-shadow: 0 10px 24px rgba(15, 23, 42, 0.04);
    }
    .chart-caption { font-size: 0.78rem; color: var(--text-muted); margin-bottom: 6px; }

    /* Footer */
    .panel-footer {
      padding: 8px 10px;
      border-top: 1px solid var(--border-light);
      background: #fff;
      font-size: 0.78rem;
      color: var(--text-muted);
      display: flex;
      justify-content: space-between;
      gap: 8px;
      align-items: center;
    }
    .status-text.ok { color: var(--accent-green); }
    .status-text.error { color: #dc2626; }

    /* Mobile */
    @media (max-width: 640px) {
      .side-panel { width: 100%; }
      .side-panel.collapsed { transform: translateX(100%); }
    }

    /* ---------------- AQ SCALE BAR OVERLAY (LEFT BOTTOM) ---------------- */
    .aq-scale {
      position: fixed;
      left: 12px;
      bottom: 14px;
      z-index: 25;
      width: 280px;
      max-width: calc(100vw - 24px);
      background: rgba(255, 255, 255, 0.92);
      border: 1px solid var(--border-light);
      border-radius: 18px;
      box-shadow: 0 14px 34px rgba(15, 23, 42, 0.14);
      backdrop-filter: blur(10px);
      padding: 12px 12px 10px;
    }

    .aq-scale-title {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom: 8px;
      font-weight: 900;
      font-size: 0.86rem;
    }

    .aq-scale-title small {
      font-weight: 700;
      color: var(--text-muted);
      font-size: 0.76rem;
    }

    .aqi-bar {
      position: relative;
      height: 10px;
      border-radius: 999px;
      overflow: hidden;
      border: 1px solid var(--border-light);
      background: #e5e7eb;
    }
    .aqi-bar .seg { height: 100%; float: left; }
    .aqi-pointer {
      position: absolute;
      top: -7px;
      width: 0;
      height: 0;
      border-left: 6px solid transparent;
      border-right: 6px solid transparent;
      border-bottom: 7px solid #111827;
      transform: translateX(-50%);
    }

    .aq-scale-row {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-top: 8px;
      gap: 10px;
      font-size: 0.78rem;
      color: var(--text-muted);
    }

    .aq-scale-row strong { color: var(--text-main); }

    /* Make leaflet attribution subtle */
    .leaflet-control-attribution {
      background: rgba(255,255,255,0.65) !important;
      border-radius: 10px !important;
      padding: 2px 8px !important;
      margin: 6px !important;
    }
  </style>
</head>

<body>
  <!-- Top navigation bar -->
  <div class="top-nav">
    <div class="nav-left">
      <img
        src="https://i.ibb.co/4wkhdY4n/Clanertsustain-new-logo.png"
        alt="Clanert logo"
        class="nav-logo"
      />
      <div class="nav-title-block">
        <div class="nav-title">
          <span>ClanertAir</span>
          <span id="dayNightIcon" class="ms-1"></span>
        </div>
        <div class="nav-sub">
          <span id="navSub">Live · 1 station</span>
          <span id="aqMood"></span>
        </div>
      </div>
    </div>

    <button id="navToggle" class="nav-toggle" aria-label="Toggle panel">
      <i class="bi bi-layout-sidebar-inset"></i>
    </button>
  </div>

  <!-- Fullscreen map -->
  <div id="map"></div>

  <!-- AQ scale bar overlay (left bottom) -->
  <div class="aq-scale" aria-label="Air quality scale">
    <div class="aq-scale-title">
      <div class="d-flex align-items-center gap-2">
        <i class="bi bi-speedometer2 text-success"></i>
        <span>Air Quality Scale</span>
      </div>
      <small id="aqScaleMini">PM2.5: --</small>
    </div>

    <div class="aqi-bar">
      <div class="seg" style="width:20%;background:#22c55e"></div>
      <div class="seg" style="width:20%;background:#facc15"></div>
      <div class="seg" style="width:20%;background:#fb923c"></div>
      <div class="seg" style="width:20%;background:#f87171"></div>
      <div class="seg" style="width:20%;background:#a855f7"></div>
      <div id="aqiPointer" class="aqi-pointer" style="left:0%"></div>
    </div>

    <div class="aq-scale-row">
      <span><strong id="aqScaleLabel">--</strong></span>
      <span id="aqScaleHint"><i class="bi bi-info-circle"></i> Waiting…</span>
    </div>
  </div>

  <!-- Right expandable side panel -->
  <div class="side-panel" id="sidePanel">
    <div class="panel-header">
      <div class="panel-header-title">
        <i class="bi bi-diagram-3 text-primary"></i>
        <span>Stations</span>
      </div>
      <button class="panel-toggle" id="panelToggle" title="Collapse details">❯</button>
    </div>

    <div class="panel-body">
      <!-- Station list -->
      <div class="panel-section-title">Stations</div>
      <div class="d-flex justify-content-between align-items-center mb-2">
        <div class="text-muted" style="font-size:.8rem" id="stationCountText">1 station</div>
      </div>

      <input type="text" id="stationSearch" class="station-search" placeholder="Search name or area..." />
      <div id="stationList" class="station-list"></div>

      <!-- Selected station details -->
      <div class="panel-section-title">Now</div>

      <div class="cards-grid">
        <div class="card-custom card-aq">
          <div class="card-header-line">
            <div class="card-label">
              <i class="bi bi-shield-check text-success"></i>
              <span>Status</span>
            </div>
          </div>
          <div class="card-main">
            <div class="card-value" id="aqStatus">--</div>
          </div>
          <div class="card-note" id="aqMessage">Waiting for data…</div>
          <div id="aqCategoryPill"></div>
        </div>

        <div class="card-custom card-thermo">
          <div class="card-header-line">
            <div class="card-label">
              <i class="bi bi-thermometer-half text-warning"></i>
              <span>Weather</span>
            </div>
          </div>
          <div class="card-main">
            <div class="card-value" id="temp">--</div>
            <div class="card-unit">°C</div>
          </div>
          <div class="card-note">
            Humidity: <span id="hum">--</span> %.
          </div>
        </div>

        <div class="card-custom card-pm25">
          <div class="card-header-line">
            <div class="card-label">
              <i class="bi bi-dot text-success"></i>
              <span>PM2.5</span>
            </div>
          </div>
          <div class="card-main">
            <div class="card-value" id="pm25">--</div>
            <div class="card-unit">µg/m³</div>
          </div>
          <div class="card-note">Fine particles.</div>
        </div>

        <div class="card-custom card-pm10">
          <div class="card-header-line">
            <div class="card-label">
              <i class="bi bi-circle-half text-primary"></i>
              <span>PM10</span>
            </div>
          </div>
          <div class="card-main">
            <div class="card-value" id="pm10">--</div>
            <div class="card-unit">µg/m³</div>
          </div>
          <div class="card-note">Coarse particles.</div>
        </div>
      </div>

      <div class="card-custom card-station">
        <div class="card-header-line">
          <div class="card-label">
            <i class="bi bi-geo-alt text-secondary"></i>
            <span>Station</span>
          </div>
        </div>
        <div class="card-note" id="stationAreaText">--</div>
      </div>

      <!-- Activities -->
      <div class="panel-section-title">Suggested activities</div>
      <div id="activities" class="activities"></div>

      <!-- Trends -->
      <div class="panel-section-title mt-3">PM trends</div>
      <div class="controls-row">
        <select id="rangeSelect" class="select-small">
          <option value="1">Last hour</option>
          <option value="6">Last 6 h</option>
          <option value="24" selected>Last 24 h</option>
        </select>

        <label class="toggle-inline">
          <input type="checkbox" id="showPm10" checked />
          PM10
        </label>

        <label class="toggle-inline">
          <input type="checkbox" id="autoRefresh" checked />
          Auto
        </label>

        <button id="refreshBtn" class="btn-small">
          <i class="bi bi-arrow-repeat"></i>
          Refresh
        </button>
      </div>

      <div class="chart-caption" id="chartSubtitle">Loading data…</div>
      <div class="chart-wrapper">
        <canvas id="pmChart"></canvas>
      </div>
    </div>

    <div class="panel-footer">
      <div id="timestampText">
        <i class="bi bi-clock"></i>
        <span>Last update: --</span>
      </div>
      <div id="statusText" class="status-text">
        <i class="bi bi-circle text-secondary"></i>
        <span>Idle</span>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // -------------------- PLATFORM CONFIG --------------------
    const SCRIPT_URL_CLANERT =
      "https://script.google.com/macros/s/AKfycbwD21CyF2Gli6Y6hDPUyds2fzAw7mrJ0NSDrqeiG7yItbZcYL-cbKsLcbHOU7db32wN/exec";

    const stations = [
      {
        id: "clanert-makabe",
        stationId: "CLANERT-MAKABE-001",
        name: "ClanertAir – Mbezi Makabe",
        area: "Mbezi Makabe, Dar es Salaam",
        lat: -6.7432882,
        lng: 39.1044879,
        dataUrl: SCRIPT_URL_CLANERT,
        aqLabel: null
      }
    ];

    // -------------------- DOM --------------------
    const sidePanel = document.getElementById("sidePanel");
    const panelToggle = document.getElementById("panelToggle");
    const navToggle = document.getElementById("navToggle");
    const navSubEl = document.getElementById("navSub");

    const stationCountTextEl = document.getElementById("stationCountText");
    const stationListEl = document.getElementById("stationList");
    const stationSearchEl = document.getElementById("stationSearch");
    const stationAreaTextEl = document.getElementById("stationAreaText");

    const pm25El = document.getElementById("pm25");
    const pm10El = document.getElementById("pm10");
    const tempEl = document.getElementById("temp");
    const humEl  = document.getElementById("hum");
    const aqStatusEl = document.getElementById("aqStatus");
    const aqMessageEl = document.getElementById("aqMessage");
    const aqCategoryPillEl = document.getElementById("aqCategoryPill");

    const rangeSelect = document.getElementById("rangeSelect");
    const autoRefreshEl = document.getElementById("autoRefresh");
    const showPm10El = document.getElementById("showPm10");
    const refreshBtn = document.getElementById("refreshBtn");

    const chartSubtitleEl = document.getElementById("chartSubtitle");
    const timestampTextEl = document.getElementById("timestampText");
    const statusTextEl = document.getElementById("statusText");

    const activitiesEl = document.getElementById("activities");

    const dayNightIconEl = document.getElementById("dayNightIcon");
    const aqMoodEl = document.getElementById("aqMood");

    // AQ scale overlay DOM
    const aqiPointerEl = document.getElementById("aqiPointer");
    const aqScaleMiniEl = document.getElementById("aqScaleMini");
    const aqScaleLabelEl = document.getElementById("aqScaleLabel");
    const aqScaleHintEl = document.getElementById("aqScaleHint");

    // -------------------- MAP & STATE --------------------
    let map = null;
    let markers = {};
    let pmChart = null;
    let autoRefreshTimer = null;
    let currentStation = stations[0];

    // -------------------- DAY/NIGHT --------------------
    function updateDayNightIcon() {
      const h = new Date().getHours();
      const isDay = h >= 6 && h < 18;
      dayNightIconEl.innerHTML = isDay
        ? `<i class="bi bi-sun-fill text-warning" title="Day"></i>`
        : `<i class="bi bi-moon-stars-fill text-primary" title="Night"></i>`;
    }

    // -------------------- AQ LOGIC --------------------
    function classifyAirQuality(pm25) {
      if (pm25 == null || isNaN(pm25)) {
        return {
          label: "Unknown",
          message: "No recent data.",
          className: "aq-pill",
          stationStatusClass: "",
          moodIcon: `<i class="bi bi-emoji-expressionless"></i>`
        };
      }
      if (pm25 <= 12) {
        return {
          label: "Good",
          message: "Air is clean. Great for outdoor activity.",
          className: "aq-pill aq-good",
          stationStatusClass: "good",
          moodIcon: `<i class="bi bi-emoji-smile-fill text-success"></i>`
        };
      } else if (pm25 <= 35.4) {
        return {
          label: "Moderate",
          message: "OK for most people. Sensitive groups take care.",
          className: "aq-pill aq-moderate",
          stationStatusClass: "moderate",
          moodIcon: `<i class="bi bi-emoji-neutral-fill text-warning"></i>`
        };
      } else if (pm25 <= 55.4) {
        return {
          label: "Unhealthy for sensitive",
          message: "Sensitive groups: limit time outdoors.",
          className: "aq-pill aq-unhealthy",
          stationStatusClass: "unhealthy",
          moodIcon: `<i class="bi bi-emoji-frown-fill text-warning"></i>`
        };
      } else if (pm25 <= 150.4) {
        return {
          label: "Unhealthy",
          message: "Limit outdoor activity. Prefer indoor exercise.",
          className: "aq-pill aq-veryunhealthy",
          stationStatusClass: "veryunhealthy",
          moodIcon: `<i class="bi bi-emoji-dizzy-fill text-danger"></i>`
        };
      } else if (pm25 <= 250.4) {
        return {
          label: "Very unhealthy",
          message: "Avoid outdoor air if possible.",
          className: "aq-pill aq-veryunhealthy",
          stationStatusClass: "veryunhealthy",
          moodIcon: `<i class="bi bi-lungs-fill text-danger"></i>`
        };
      } else {
        return {
          label: "Hazardous",
          message: "Stay indoors. Reduce exposure.",
          className: "aq-pill aq-hazardous",
          stationStatusClass: "hazardous",
          moodIcon: `<i class="bi bi-skull-fill" style="color:#6b21a8"></i>`
        };
      }
    }

    function setAqiPointerFromPm25(pm25) {
      if (pm25 == null || isNaN(pm25)) {
        aqiPointerEl.style.left = "0%";
        return;
      }
      // map 0..250 to 0..100%
      const clamped = Math.max(0, Math.min(pm25, 250));
      const pct = (clamped / 250) * 100;
      aqiPointerEl.style.left = pct + "%";
    }

    function getMarkerColors(label) {
      switch (label) {
        case "Good": return { color: "#16a34a", fillColor: "#22c55e" };
        case "Moderate": return { color: "#eab308", fillColor: "#facc15" };
        case "Unhealthy for sensitive": return { color: "#f97316", fillColor: "#fb923c" };
        case "Unhealthy": return { color: "#ef4444", fillColor: "#f87171" };
        case "Very unhealthy": return { color: "#b91c1c", fillColor: "#f97373" };
        case "Hazardous": return { color: "#6b21a8", fillColor: "#a855f7" };
        default: return { color: "#6b7280", fillColor: "#9ca3af" };
      }
    }

    // -------------------- ACTIVITIES --------------------
    function activitiesFor(label) {
      if (label === "Good") return [
        { icon:"bi-person-running", title:"Running / Jogging", sub:"Best time for outdoor cardio." },
        { icon:"bi-bicycle", title:"Cycling / Cruising", sub:"Enjoy longer rides outside." },
        { icon:"bi-tree", title:"Outdoor exercise", sub:"Park workouts are recommended." },
        { icon:"bi-wind", title:"Ventilation", sub:"Open windows for fresh air." },
      ];
      if (label === "Moderate") return [
        { icon:"bi-person-walking", title:"Light walk", sub:"Good for most people." },
        { icon:"bi-bicycle", title:"Short cycling", sub:"Keep it moderate intensity." },
        { icon:"bi-heart-pulse", title:"Workout (short)", sub:"Prefer mid-intensity." },
        { icon:"bi-wind", title:"Ventilate smart", sub:"Ventilate when traffic is low." },
      ];
      if (label.includes("sensitive")) return [
        { icon:"bi-house-door", title:"Indoor workout", sub:"Safer for sensitive groups." },
        { icon:"bi-person-walking", title:"Short walk", sub:"Avoid heavy exertion." },
        { icon:"bi-mask", title:"Mask outdoors", sub:"Consider a well-fitting mask." },
        { icon:"bi-fan", title:"Ventilation caution", sub:"Ventilate briefly if needed." },
      ];
      if (label === "Unhealthy") return [
        { icon:"bi-house-door", title:"Stay indoors", sub:"Avoid outdoor running/exercise." },
        { icon:"bi-heart-pulse", title:"Indoor exercise", sub:"Short + low intensity." },
        { icon:"bi-mask", title:"Mask if outside", sub:"Reduce exposure as much as possible." },
        { icon:"bi-shield-check", title:"Air cleaning", sub:"Close windows / purifier if possible." },
      ];
      if (label === "Very unhealthy") return [
        { icon:"bi-house-lock", title:"Avoid outdoors", sub:"Health risk for everyone." },
        { icon:"bi-shield-check", title:"Close windows", sub:"Keep indoor air cleaner." },
        { icon:"bi-fan", title:"Ventilation caution", sub:"Ventilate only if air improves." },
        { icon:"bi-activity", title:"Rest / light indoor", sub:"Avoid intense activity." },
      ];
      if (label === "Hazardous") return [
        { icon:"bi-house-lock-fill", title:"Stay inside", sub:"Avoid outdoor exposure." },
        { icon:"bi-shield-fill-check", title:"Seal indoor air", sub:"Windows closed, purifier if possible." },
        { icon:"bi-telephone", title:"Health caution", sub:"If symptoms: seek medical advice." },
        { icon:"bi-x-octagon", title:"No outdoor activity", sub:"Running/cycling not recommended." },
      ];
      return [
        { icon:"bi-question-circle", title:"No data", sub:"Waiting for sensor updates." },
        { icon:"bi-arrow-repeat", title:"Refresh", sub:"Try again in a moment." }
      ];
    }

    function renderActivities(label) {
      const acts = activitiesFor(label);
      activitiesEl.innerHTML = acts.map(a => `
        <div class="act">
          <i class="bi ${a.icon} text-primary"></i>
          <div>
            <p class="act-title">${a.title}</p>
            <p class="act-sub">${a.sub}</p>
          </div>
        </div>
      `).join("");
    }

    // -------------------- API CALLS --------------------
    async function fetchLatest(station) {
      const url = station.dataUrl + "?mode=latest&station=" + encodeURIComponent(station.stationId);
      const res = await fetch(url);
      const text = await res.text();
      let data;
      try { data = JSON.parse(text); } catch { throw new Error("Server did not return JSON."); }
      if (data.error === "no_data") throw new Error("No data available yet.");
      return data;
    }

    async function fetchHistory(station, hours) {
      const url = station.dataUrl
        + "?mode=history&station=" + encodeURIComponent(station.stationId)
        + "&hours=" + encodeURIComponent(hours);
      const res = await fetch(url);
      const text = await res.text();
      let data;
      try { data = JSON.parse(text); } catch { throw new Error("History response not JSON."); }
      return data;
    }

    // -------------------- UI UPDATE --------------------
    function updateCardsFromLatest(station, latest) {
      const pm25 = parseFloat(latest.pm25);
      const pm10 = parseFloat(latest.pm10);
      const temp = parseFloat(latest.temperature);
      const hum  = parseFloat(latest.humidity);

      pm25El.textContent = isNaN(pm25) ? "--" : pm25.toFixed(1);
      pm10El.textContent = isNaN(pm10) ? "--" : pm10.toFixed(1);
      tempEl.textContent = isNaN(temp) ? "--" : temp.toFixed(1);
      humEl.textContent  = isNaN(hum)  ? "--" : hum.toFixed(0);

      const aqInfo = classifyAirQuality(pm25);
      station.aqLabel = aqInfo.label;

      // Top mood + overlay
      aqMoodEl.innerHTML = aqInfo.moodIcon;
      aqScaleMiniEl.textContent = "PM2.5: " + (isNaN(pm25) ? "--" : pm25.toFixed(1));
      aqScaleLabelEl.textContent = aqInfo.label;
      aqScaleHintEl.innerHTML = `<i class="bi bi-info-circle"></i> ${aqInfo.message}`;

      setAqiPointerFromPm25(pm25);

      // Cards
      aqStatusEl.textContent = aqInfo.label;
      aqMessageEl.textContent = aqInfo.message;
      aqCategoryPillEl.innerHTML =
        `<span class="${aqInfo.className}">
          <i class="bi bi-circle-fill"></i>
          ${aqInfo.label}
        </span>`;

      renderActivities(aqInfo.label);

      timestampTextEl.innerHTML =
        `<i class="bi bi-clock"></i> <span>Last update: ${formatTimestampFull(latest.timestamp)}</span>`;

      stationAreaTextEl.textContent = station.area;

      updateMarkerForStation(station, pm25, pm10, temp, hum, aqInfo);
      renderStationList(stationSearchEl.value);
    }

    function updateMarkerForStation(station, pm25, pm10, temp, hum, aqInfo) {
      const marker = markers[station.id];
      if (!marker) return;

      const colors = getMarkerColors(aqInfo.label);
      marker.setStyle({ color: colors.color, fillColor: colors.fillColor });

      const pieces = [];
      if (!isNaN(pm25)) pieces.push(`PM2.5: ${pm25.toFixed(1)} µg/m³`);
      if (!isNaN(pm10)) pieces.push(`PM10: ${pm10.toFixed(1)} µg/m³`);
      if (!isNaN(temp)) pieces.push(`Temp: ${temp.toFixed(1)} °C`);
      if (!isNaN(hum)) pieces.push(`Humidity: ${hum.toFixed(0)} %`);

      marker.bindPopup(`
        <strong>${station.name}</strong><br>
        Status: ${aqInfo.label}<br>
        ${pieces.join(" · ")}
      `);
    }

    // Dynamic Y scale based on data
    function computeNiceMax(values) {
      const nums = values.filter(v => typeof v === "number" && !isNaN(v));
      if (!nums.length) return 50;
      const max = Math.max(...nums);
      const min = Math.min(...nums);

      // If flat, add some headroom
      const base = Math.max(max, 5);
      const headroom = base * 0.15; // 15%
      const raw = base + headroom;

      // Round up to "nice" steps (10s)
      const step = raw <= 50 ? 5 : raw <= 100 ? 10 : raw <= 200 ? 20 : 50;
      return Math.ceil(raw / step) * step;
    }

    function updateChartFromHistory(history) {
      let points = history.points || [];
      const hours = history.hours;

      points = points.filter(p => {
        const ts = new Date(p.timestamp);
        const pm25 = parseFloat(p.pm25);
        const pm10 = parseFloat(p.pm10);
        return !isNaN(ts.getTime()) && (!isNaN(pm25) || !isNaN(pm10));
      });

      points.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

      chartSubtitleEl.textContent = points.length
        ? `${points.length} points · last ${hours} h`
        : "No data in this range.";

      const labels = points.map(p => formatTimestampShort(p.timestamp));
      const pm25Data = points.map(p => {
        const v = parseFloat(p.pm25);
        return isNaN(v) ? null : v;
      });
      const pm10Data = points.map(p => {
        const v = parseFloat(p.pm10);
        return isNaN(v) ? null : v;
      });

      // scale according to data currently visible
      const combined = [...pm25Data, ...(showPm10El.checked ? pm10Data : [])].filter(v => v != null);
      const niceMax = computeNiceMax(combined);

      const ctx = document.getElementById("pmChart").getContext("2d");
      if (pmChart) pmChart.destroy();

      pmChart = new Chart(ctx, {
        type: "line",
        data: {
          labels,
          datasets: [
            {
              label: "PM2.5",
              data: pm25Data,
              borderWidth: 2,
              tension: 0.25,
              pointRadius: 0,
              borderColor: "#16a34a",
              backgroundColor: "rgba(22,163,74,0.12)"
            },
            {
              label: "PM10",
              data: pm10Data,
              borderWidth: 1.6,
              tension: 0.25,
              pointRadius: 0,
              borderColor: "#1d4ed8",
              backgroundColor: "rgba(37,99,235,0.08)",
              borderDash: [4, 3],
              hidden: !showPm10El.checked
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: "index", intersect: false },
          plugins: {
            legend: { labels: { color: "#111827", font: { size: 10 } } },
            tooltip: {
              callbacks: {
                title: (items) => {
                  const idx = items[0].dataIndex;
                  const p = points[idx];
                  return p ? formatTimestampFull(p.timestamp) : "";
                }
              }
            }
          },
          scales: {
            x: {
              ticks: { color: "#6b7280", maxTicksLimit: 7 },
              grid: { color: "#e5e7eb" }
            },
            y: {
              ticks: { color: "#6b7280" },
              grid: { color: "#e5e7eb" },
              suggestedMin: 0,
              suggestedMax: niceMax
            }
          }
        }
      });
    }

    function formatTimestampFull(ts) {
      if (!ts) return "--";
      const d = new Date(ts);
      if (isNaN(d.getTime())) return String(ts);
      return d.toLocaleString();
    }

    function formatTimestampShort(ts) {
      const d = new Date(ts);
      if (isNaN(d.getTime())) return "";
      return d.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
    }

    // -------------------- STATION LIST --------------------
    function renderStationList(filterText) {
      const q = (filterText || "").trim().toLowerCase();

      const visible = q
        ? stations.filter(s => s.name.toLowerCase().includes(q) || s.area.toLowerCase().includes(q))
        : stations;

      stationCountTextEl.textContent = visible.length === 1 ? "1 station" : `${visible.length} stations`;

      navSubEl.textContent =
        "Live · " + (stations.length === 1 ? "1 station" : `${stations.length} stations`);

      stationListEl.innerHTML = "";
      visible.forEach(st => {
        const div = document.createElement("div");
        div.className = "station-item" + (st.id === currentStation.id ? " active" : "");

        const main = document.createElement("div");
        main.className = "station-main";
        main.innerHTML = `
          <div class="station-name"><i class="bi bi-broadcast-pin text-primary"></i> ${st.name}</div>
          <div class="station-area">${st.area}</div>
        `;

        const status = document.createElement("div");
        status.className = "station-status-pill";
        if (st.aqLabel) {
          const labelLower = st.aqLabel.toLowerCase();
          if (labelLower.includes("good")) status.classList.add("good");
          else if (labelLower.includes("moderate")) status.classList.add("moderate");
          else if (labelLower.includes("sensitive")) status.classList.add("unhealthy");
          else if (labelLower.includes("very")) status.classList.add("veryunhealthy");
          else if (labelLower.includes("hazardous")) status.classList.add("hazardous");
          else if (labelLower.includes("unhealthy")) status.classList.add("unhealthy");
          status.textContent = st.aqLabel;
        } else {
          status.textContent = "No data";
        }

        div.appendChild(main);
        div.appendChild(status);

        div.addEventListener("click", () => selectStationById(st.id));
        stationListEl.appendChild(div);
      });

      if (visible.length === 0) {
        const empty = document.createElement("div");
        empty.className = "text-muted";
        empty.style.fontSize = ".82rem";
        empty.textContent = "No stations match your search.";
        stationListEl.appendChild(empty);
      }
    }

    function selectStationById(stationId) {
      const station = stations.find(s => s.id === stationId);
      if (!station) return;
      currentStation = station;

      renderStationList(stationSearchEl.value);
      centerMapOnStation(station);
      refreshAllForCurrentStation();
    }

    // -------------------- MAP INIT --------------------
    function initMap() {
      const first = stations[0];

      // remove zoom controls (top left)
      map = L.map("map", { zoomControl: false }).setView([first.lat, first.lng], 13);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: "&copy; OpenStreetMap contributors"
      }).addTo(map);

      stations.forEach(st => {
        const circle = L.circleMarker([st.lat, st.lng], {
          radius: 10,
          color: "#6b7280",
          weight: 2,
          fillColor: "#9ca3af",
          fillOpacity: 0.9
        }).addTo(map);

        circle.bindPopup(st.name);
        circle.on("click", () => selectStationById(st.id));

        markers[st.id] = circle;
      });

      stationAreaTextEl.textContent = first.area;
    }

    function centerMapOnStation(station) {
      if (!map) return;
      map.setView([station.lat, station.lng], 13);
    }

    // -------------------- REFRESH LOGIC --------------------
    async function refreshAllForCurrentStation() {
      const station = currentStation;
      const hours = parseInt(rangeSelect.value, 10) || 1;

      statusTextEl.innerHTML = `<span class="text-muted"><i class="bi bi-arrow-repeat"></i> Updating…</span>`;
      statusTextEl.className = "status-text";

      try {
        const [latest, history] = await Promise.all([
          fetchLatest(station),
          fetchHistory(station, hours)
        ]);

        updateCardsFromLatest(station, latest);
        updateChartFromHistory(history);

        statusTextEl.innerHTML = `<span class="text-success"><i class="bi bi-check-circle"></i> Updated</span>`;
        statusTextEl.className = "status-text ok";
      } catch (err) {
        console.error(err);
        statusTextEl.innerHTML = `<span class="text-danger"><i class="bi bi-exclamation-circle"></i> Error</span>`;
        statusTextEl.className = "status-text error";
      }
    }

    function setupAutoRefresh() {
      if (autoRefreshTimer) clearInterval(autoRefreshTimer);
      autoRefreshTimer = null;

      if (autoRefreshEl.checked) {
        autoRefreshTimer = setInterval(refreshAllForCurrentStation, 60000);
      }
    }

    // -------------------- PANEL TOGGLE --------------------
    function togglePanel() {
      const collapsed = sidePanel.classList.toggle("collapsed");
      panelToggle.textContent = collapsed ? "❮" : "❯";
      if (map) setTimeout(() => map.invalidateSize(), 250);
    }

    panelToggle.addEventListener("click", togglePanel);
    navToggle.addEventListener("click", togglePanel);

    // -------------------- EVENTS --------------------
    refreshBtn.addEventListener("click", refreshAllForCurrentStation);
    rangeSelect.addEventListener("change", refreshAllForCurrentStation);

    autoRefreshEl.addEventListener("change", setupAutoRefresh);

    showPm10El.addEventListener("change", () => {
      if (pmChart) {
        pmChart.data.datasets[1].hidden = !showPm10El.checked;
        // recompute scale based on what is visible
        pmChart.update();
      }
      refreshAllForCurrentStation();
    });

    stationSearchEl.addEventListener("input", () => renderStationList(stationSearchEl.value));

    window.addEventListener("resize", () => {
      if (map) setTimeout(() => map.invalidateSize(), 200);
    });

    // -------------------- BOOT --------------------
    window.addEventListener("load", () => {
      updateDayNightIcon();
      setInterval(updateDayNightIcon, 30000);

      initMap();
      renderStationList("");
      centerMapOnStation(currentStation);
      refreshAllForCurrentStation();
      setupAutoRefresh();
    });
  </script>
</body>
</html>
